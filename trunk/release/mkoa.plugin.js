Ext.namespace("Mixky.editor");Mixky.editor.RowNumberer=Ext.extend(Object,{header:"",width:35,sortable:false,constructor:function(a){Ext.apply(this,a);if(this.rowspan)this.renderer=this.renderer.createDelegate(this)},fixed:true,menuDisabled:true,dataIndex:"",id:"numberer",rowspan:undefined,renderer:function(a,b,c,d){if(this.rowspan)b.cellAttr='rowspan="'+this.rowspan+'"';a=c.get("rowstate");if(a==""&&c.dirty)a="edit";return String.format("<div class='mixky-editor-rownumberer-{0}'> {1}</div>",a,d+1)}});Ext.namespace("Mixky.plugins");Mixky.plugins.UploadButtonPlugin=function(a){Ext.apply(this,a);this.addEvents("swfUploadLoaded","fileDialogStart","startUpload","fileUploadError","fileUploadSuccess","fileUploadComplete","allUploadsComplete");Mixky.plugins.UploadButtonPlugin.superclass.constructor.call(this);this.initComponent()};
Ext.extend(Mixky.plugins.UploadButtonPlugin,Ext.util.Observable,{button:undefined,strings:{text_add:"\u6d4f\u89c8\u6587\u4ef6",text_upload:"\u4e0a\u4f20\u6587\u4ef6",text_cancel:"\u53d6\u6d88\u4e0a\u4f20",text_clear:"\u6e05\u9664\u961f\u5217",text_progressbar:"Progress Bar",text_remove:"\u79fb\u9664\u6587\u4ef6",text_remove_sure:"\u60a8\u786e\u5b9a\u8981\u4ece\u961f\u5217\u4e2d\u79fb\u9664\u6587\u4ef6\u4e48?",text_error:"Error",text_uploading:"\u6b63\u5728\u4e0a\u4f20\u6587\u4ef6: {0} ({1} of {2})",
header_filename:"\u6587\u4ef6\u540d\u79f0",header_size:"\u5927\u5c0f",header_status:"\u72b6\u6001",status:{0:"\u7b49\u5f85\u4e0a\u4f20",1:"\u6b63\u5728\u4e0a\u4f20...",2:"\u5b8c\u6210",3:"\u9519\u8bef",4:"\u5df2\u53d6\u6d88"},error_queue_exceeded:"\u4e00\u6b21\u6700\u591a\u4e0a\u4f20{0}\u4e2a\u6587\u4ef6.",error_queue_slots_0:"There is no slot left",error_queue_slots_1:"There is only one slot left",error_queue_slots_2:"There are only {0} slots left",error_size_exceeded:"\u4e0a\u4f20\u6587\u4ef6\u6700\u5927\u4e0d\u5141\u8bb8\u8d85\u8fc720 MB.",
error_zero_byte_file:"\u9009\u4e2d\u6587\u4ef6\u5927\u5c0f\u662f0\u5b57\u8282.",error_invalid_filetype:"\u9009\u4e2d\u7684\u6587\u4ef6\u7c7b\u578b\u65e0\u6548.",error_file_not_found:"\u6587\u4ef6\u6ca1\u6709\u627e\u5230 404.",error_security_error:"Security Error. Not allowed to post to different url."},file_types:"*.*",file_types_description:"\u6240\u6709\u6587\u4ef6",file_size_limit:"20MB",file_upload_limit:"0",file_queue_limit:"0",file_post_name:"Filedata",flash_url:"dependences/swfupload/swfupload.swf",
debug:false,upload_cancelled:false,initComponent:function(){var a=Ext.id(),b=this.button.el.child("em");b.setStyle({position:"relative",display:"block"});b.createChild({tag:"div",id:a});this.suo=new SWFUpload({button_placeholder_id:a,button_width:b.getWidth()+20,button_height:b.getHeight(),button_cursor:SWFUpload.CURSOR.HAND,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,upload_url:this.upload_url,post_params:this.post_params,file_post_name:this.file_post_name,file_size_limit:this.file_size_limit,
file_queue_limit:this.file_queue_limit,file_types:this.file_types,file_types_description:this.file_types_description,file_upload_limit:this.file_upload_limit,flash_url:this.flash_url,swfupload_loaded_handler:this.swfUploadLoaded.createDelegate(this),file_dialog_start_handler:this.fileDialogStart.createDelegate(this),file_queued_handler:this.fileQueue.createDelegate(this),file_queue_error_handler:this.fileQueueError.createDelegate(this),file_dialog_complete_handler:this.fileDialogComplete.createDelegate(this),
upload_start_handler:this.uploadStart.createDelegate(this),upload_progress_handler:this.uploadProgress.createDelegate(this),upload_error_handler:this.uploadError.createDelegate(this),upload_success_handler:this.uploadSuccess.createDelegate(this),upload_complete_handler:this.uploadComplete.createDelegate(this),debug:this.debug,debug_handler:this.debug?this.debugHandler:Ext.emptyFn});Ext.get(this.suo.movieName).setStyle({position:"absolute",top:0,left:0});this.rec=Ext.data.Record.create([{name:"name"},
{name:"size"},{name:"id"},{name:"type"},{name:"creationdate",type:"date",dateFormat:"m/d/Y"},{name:"status"}]);this.store=new Ext.data.Store({reader:new Ext.data.JsonReader({id:"id"},this.rec)})},formatProgressBar:function(a,b,c){switch(c.data.fileState){case SWFUpload.FILE_STATUS.COMPLETE:returnValue=Ext.isIE?'<div class="x-progress-wrap" style="height: 18px"><div class="x-progress-inner"><div style="width: 100%;" class="x-progress-bar x-progress-text">100 %':'<div class="x-progress-wrap" style="height: 18px"><div class="x-progress-inner"><div id="progressBar_'+
c.data.id+'" style="width: 100%;" class="x-progress-bar"></div><div id="progressText_'+c.data.id+'" style="width: 100%;" class="x-progress-text x-progress-text-back" />100 %</div>';break;default:returnValue='<div class="x-progress-wrap" style="height: 18px"><div class="x-progress-inner"><div id="progressBar_'+c.data.id+'" style="width: 0%;" class="x-progress-bar"></div><div id="progressText_'+c.data.id+'" style="width: 100%;" class="x-progress-text x-progress-text-back" />0 %</div>';break}return returnValue},
formatStatus:function(a){return this.strings.status[a]},formatBytes:function(a){a||(a=0);var b=a;a=parseInt(a,10);for(b=0;a/1024>1;){a/=1024;b++}return b=Math.round(a)+" "+["B","KB","MB","GB"][b]},debugHandler:function(a){console.log(a)},swfUploadLoaded:function(){this.debug&&console.info("SWFUPLOAD LOADED");this.fireEvent("swfUploadLoaded",this)},fileDialogStart:function(){this.debug&&console.info("FILE DIALOG START");this.store.removeAll();this.store.commitChanges();this.fireEvent("fileDialogStart",
this)},fileQueue:function(a){this.debug&&console.info("FILE QUEUE");a.status=0;r=new this.rec(a);r.id=a.id;this.store.add(r);this.fireEvent("fileQueued",this,a)},fileQueueError:function(a,b,c){this.debug&&console.info("FILE QUEUE ERROR");switch(b){case -100:switch(c){case "0":c=this.strings.error_queue_slots_0;break;case "1":c=this.strings.error_queue_slots_1;break;default:c=String.format(this.strings.error_queue_slots_2,c)}Ext.MessageBox.alert(this.strings.text_error,String.format(this.strings.error_queue_exceeded+
" "+c,this.file_queue_limit));break;case -110:Ext.MessageBox.alert(this.strings.text_error,String.format(this.strings.error_size_exceeded,this.formatBytes(this.file_size_limit*1024)));break;case -120:Ext.MessageBox.alert(this.strings.text_error,this.strings.error_zero_byte_file);break;case -130:Ext.MessageBox.alert(this.strings.text_error,this.strings.error_invalid_filetype);break}this.fireEvent("fileQueueError",this,a,b)},fileDialogComplete:function(a){this.debug&&console.info("FILE DIALOG COMPLETE");
a>0&&this.startUpload();this.fireEvent("fileDialogComplete",this,a)},uploadStart:function(a){this.debug&&console.info("UPLOAD START");this.fireEvent("uploadStart",this,a);return true},progressCount:0,uploadProgress:function(a,b,c){var d=Math.ceil(b/c*100);if(d!=this.progressCount){Ext.getDom("progressBar_"+a.id).style.width=d+"%";Ext.getDom("progressText_"+a.id).innerHTML=d+" %";this.progressCount=d}this.store.getById(a.id).set("status",1);this.fireEvent("uploadProgress",this,a,b,c)},uploadError:function(a,
b,c){this.debug&&console.info("UPLOAD ERROR");if(c==500)Ext.MessageBox.alert(this.strings.text_error,"File too big");else switch(b){case -200:Ext.MessageBox.alert(this.strings.text_error,this.strings.error_file_not_found);break;case -230:Ext.MessageBox.alert(this.strings.text_error,this.strings.error_security_error);break;case -290:this.store.getById(a.id).set("status",4);this.store.getById(a.id).commit();break}this.fireEvent("fileUploadError",this,a,b,c)},uploadSuccess:function(a,b){this.debug&&
console.info("UPLOAD SUCCESS");b=Ext.decode(b);if(b.success){this.store.getById(a.id).data.fileState=SWFUpload.FILE_STATUS.COMPLETE;this.store.getById(a.id).set("status",2)}else{this.store.getById(a.id).set("status",3);this.store.getById(a.id).commit();b.msg&&Ext.MessageBox.alert(this.strings.text_error,b.msg)}this.fireEvent("fileUploadSuccess",this,a,b)},uploadComplete:function(a){this.debug&&console.info("UPLOAD COMPLETE");if(this.suo.getStats().files_queued&&!this.upload_cancelled)this.suo.startUpload();
else{this.fireEvent("fileUploadComplete",this,a);this.allUploadsComplete()}},allUploadsComplete:function(){this.uploadDialog.close();this.fireEvent("allUploadsComplete",this)},addPostParam:function(a,b){if(this.suo){this.suo.settings.post_params[a]=b;this.suo.setPostParams(this.suo.settings.post_params)}else this.post_params[a]=b},startUpload:function(){this.debug&&console.info("START UPLOAD");this.upload_cancelled=false;this.uploadFileGrid=new Ext.grid.GridPanel({autoExpandColumn:"name",enableColumnResize:false,
enableColumnMove:false,store:this.store,columns:[{id:"name",header:this.strings.header_filename,dataIndex:"name"},{id:"size",header:this.strings.header_size,width:80,dataIndex:"size",renderer:this.formatBytes},{id:"status",header:this.strings.header_status,width:100,dataIndex:"status",renderer:this.formatStatus.createDelegate(this)},{id:"progress",header:"",width:150,renderer:this.formatProgressBar}]});var a;try{a=MixkyApp.desktop.getManager()}catch(b){a=new Ext.WindowGroup}this.uploadDialog=new Ext.Window({layout:"fit",
width:400,height:300,modal:true,manager:a,maximizable:false,minimizable:false,closable:false,resizable:false,iconCls:"icon-sys-upload",title:this.strings.text_upload,items:this.uploadFileGrid,buttons:[{text:this.strings.text_cancel,iconCls:"icon-sys-cancel",handler:this.stopUpload.createDelegate(this),scope:this}]});this.uploadDialog.show();this.fireEvent("startUpload",this);this.suo.startUpload()},stopUpload:function(){this.debug&&console.info("STOP UPLOAD");this.suo.stopUpload();this.upload_cancelled=
true;this.uploadDialog.close();this.fireEvent("allUploadsComplete",this)},setButtonDisabled:function(a){this.suo.getMovieElement().style.display=a?"none":""},show:function(){this.single_select?this.suo.selectFile():this.suo.selectFiles()}});Mixky.plugins.UploadButton=function(a){Ext.apply(this,a);Mixky.plugins.UploadButton.superclass.constructor.call(this)};
Ext.extend(Mixky.plugins.UploadButton,Ext.Button,{uploadConfig:undefined,initComponent:function(){Mixky.plugins.UploadButton.superclass.initComponent.call(this);this.on("afterrender",function(){var a=Ext.apply({button:this},this.uploadConfig);this.uploadPlugin=new Mixky.plugins.UploadButtonPlugin(a)})},disable:function(){this.uploadPlugin.setButtonDisabled(true);Mixky.plugins.UploadButton.superclass.disable.call(this)},enable:function(){this.uploadPlugin.setButtonDisabled(false);Mixky.plugins.UploadButton.superclass.enable.call(this)},
beginUpload:function(){this.uploadPlugin.show()}});Ext.reg("mixkyuploadbutton",Mixky.plugins.UploadButton);Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.RepeatType={getEvent:function(a,b){var c=a.repeatType,d=c.rtype,e=c.exceptions;if(c.beginDay<=b&&("no"==c.endDay||b<=c.endDay)&&(!e||!e[b])){var f;if("day"==d)f=Ext.ux.calendar.RepeatType.getRepeatDayEvent(b,a);else if("week"==d)f=Ext.ux.calendar.RepeatType.getRepeatWeekEvent(b,a);else if("month"==d)f=Ext.ux.calendar.RepeatType.getRepeatMonthEvent(b,a);else if("year"==d)f=Ext.ux.calendar.RepeatType.getRepeatYearEvent(b,a);return f}},getRepeatDayEvent:function(a,b){var c=b.repeatType,
d=c.intervalSlot,e=c.dspan,f=c.rtime,g=Ext.ux.calendar.Mask.getDayOffset(c.beginDay,a);c=g%d;d=Math.floor(g/d);if(0==c&&(!f||d<f)){b=Ext.apply({},b);b.day=a;a=Date.parseDate(a,"Y-m-d");b.eday=a.add(Date.DAY,e).format("Y-m-d");delete b.lflag;delete b.rflag;return b}},getRepeatWeekEvent:function(a,b){var c=b.repeatType,d=c.beginDay,e=Date.parseDate(d,"Y-m-d").format("N"),f=Date.parseDate(a,"Y-m-d"),g=f.format("N"),h=c.rday;if("{}"==Ext.encode(h))h[e]=true;if(h[g]){f=c.intervalSlot;h=c.dspan;c=c.rtime;
e=Math.floor((Ext.ux.calendar.Mask.getDayOffset(d,a)-g-e)/7)+1;d=e%f;e=Math.floor(e/f);if(0==d&&(!c||e<c)){b=Ext.apply({},b);b.day=a;f=Date.parseDate(a,"Y-m-d");b.eday=f.add(Date.DAY,h).format("Y-m-d");delete b.lflag;delete b.rflag;return b}}},getRepeatMonthEvent:function(a,b){var c=b.repeatType,d=c.beginDay,e=d.split("-",3),f=parseInt(e[0]),g=parseInt(e[1]),h=parseInt(e[2]);e=a.split("-",3);var j=parseInt(e[0]),i=parseInt(e[1]);e=parseInt(e[2]);var n=c.rby;d=Date.parseDate(d,"Y-m-d").format("N");
var m=Math.floor((h-d)/7)+1,l=Date.parseDate(a,"Y-m-d");l=l.format("N");var o=Math.floor((e-l)/7)+1;if("date"==n&&h==e||"day"==n&&o==m&&l==d){e=c.intervalSlot;h=c.dspan;c=c.rtime;g=12*j+i-12*f-g;f=g%e;g=Math.floor(g/e);if(0==f&&(!c||g<c)){b=Ext.apply({},b);b.day=a;l=Date.parseDate(a,"Y-m-d");b.eday=l.add(Date.DAY,h).format("Y-m-d");delete b.lflag;delete b.rflag;return b}}},getRepeatYearEvent:function(a,b){var c=b.repeatType,d=c.beginDay.split("-",3),e=parseInt(d[0]),f=d[1],g=d[2];d=a.split("-",3);
var h=parseInt(d[0]),j=d[2];if(f==d[1]&&g==j){f=c.intervalSlot;d=c.dspan;c=c.rtime;h=h-e;e=h%f;h=Math.floor(h/f);if(0==e&&(!c||h<c)){b=Ext.apply({},b);b.day=a;a=Date.parseDate(a,"Y-m-d");b.eday=a.add(Date.DAY,d).format("Y-m-d");delete b.lflag;delete b.rflag;return b}}}};Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.Mask={repeatType:[["no","\u4e0d\u91cd\u590d"],["day","\u6bcf\u5929"],["week","\u6bcf\u5468"],["month","\u6bcf\u6708"],["year","\u6bcf\u5e74"]],colors:["668CD9","D96666","59BFB3","F2A442","4CB052","B373B3"],colorIndex:["blue","red","cyan","orange","green","purple"],getColorByIndex:function(a){for(var b=Ext.ux.calendar.Mask,c=0,d=b.colorIndex.length;c<d;c++)if(a==b.colorIndex[c])return b.colors[c];return null},getIndexByColor:function(a){for(var b=Ext.ux.calendar.Mask,c=0,d=b.colors.length;c<
d;c++)if(a==b.colors[c])return b.colorIndex[c];return null},getRepeatTypeStore:function(){return new Ext.data.SimpleStore({fields:["value","display"],data:Ext.ux.calendar.Mask.repeatType})},getCalendarStore:function(){return new Ext.data.SimpleStore({fields:["id","title","description","color"],data:[]})},getHourFormatStore:function(){var a=Ext.ux.calendar.Mask.Mask;return new Ext.data.SimpleStore({fields:["id","text"],data:[["12",a["12Hours"]],["24",a["24Hours"]]]})},parseHM:function(a){var b;b=a.split(":");
a=b[0];if("0"==a.charAt(0))a=a.charAt(1);a=parseInt(a);b=b[1];if("0"==b.charAt(0))b=b.charAt(1);b=parseInt(b);return{h:a,m:b}},calculateActiveRow:function(a){var b={},c=this.parseHM(a.activeStartTime),d=c.h*60+c.m;c=this.parseHM(a.activeEndTime);c=c.h*60+c.m;b.intervalSlot=parseInt(a.intervalSlot);b.rowCount=1440/b.intervalSlot;b.activeStartRow=Math.floor(d/b.intervalSlot);b.activeEndRow=Math.floor(c/b.intervalSlot);b.numInHour=Math.floor(60/b.intervalSlot);delete a.id;delete a["class"];b=Ext.apply(b,
a);b.startDay=parseInt(b.startDay);b.startRow=0;b.endRow=b.rowCount;if(b.hideInactiveRow){b.startRow=b.activeStartRow;b.endRow=b.activeEndRow}return b},getTimeStore:function(){return new Ext.data.SimpleStore({fields:["row","hour"],data:[]})},getHMFromRow:function(a,b,c){a=a*b;b=Math.floor(a/60);a%=60;if(10>a)a="0"+a;if(10>b)b="0"+b;var d=b+":"+a;if("12"==c)d=Date.parseDate(b+":"+a,"H:i").format("h:i A");return d},generateIntervalData:function(a,b,c,d){var e=Math.floor(1440/a);b=b||0;c=c||e;e=[];for(b=
b;b<=c;b++){var f=[];f.push(b);var g=this.getHMFromRow(a,b,d);f.push(g);e.push(f)}return e},getIntervalFromRow:function(a,b,c){a=a*b;b=Math.floor(a/60);a%=60;if(10>a)a="0"+a;if(10>b)b="0"+b;var d=b+":"+a;if("12"==c)d=Date.parseDate(b+":"+a,"H:i").format("h:i A");return d},getRowFromHM:function(a,b){if("23:59"==a)a="24:00";a=Ext.ux.calendar.Mask.parseHM(a);return Math.round(a.h*60/b+a.m/b)},getEDStore:function(){var a=Ext.ux.calendar.Mask.Mask;return new Ext.data.SimpleStore({fields:["value","display"],
data:[[true,a.enable],[false,a.disable]]})},getStartDayStore:function(){var a=Ext.ux.calendar.Mask.Mask;return new Ext.data.SimpleStore({fields:["value","display"],data:[[0,a.sunday],[1,a.monday]]})},getIntervalStore:function(){var a=Ext.ux.calendar.Mask.Mask;return new Ext.data.SimpleStore({fields:["value","display"],data:[[10,"10 "+a.minute],[15,"15 "+a.minute],[20,"20 "+a.minute],[30,"30 "+a.minute],[60,"60 "+a.minute]]})},getDayOffset:function(a,b){a instanceof Date||(a=Date.parseDate(a,"Y-m-d"));
b instanceof Date||(b=Date.parseDate(b,"Y-m-d"));a=a.getElapsed(b);return a=Math.round(a/864E5)},getWeekDayInMonth:function(a){var b=a.format("N"),c=a.format("d");b=Math.floor((c-b)/7)+1;a=a.format("l");return"\u7b2c"+b+"\u5468 "+a},getIntervalText:function(a,b){var c="";if("day"==a)c=1==b?"\u6bcf\u5929":"\u6bcf\u9694 "+b+" \u5929";else if("week"==a)c=1==b?"\u6bcf\u5468\u7684":"\u6bcf\u9694 "+b+" \u5468 \u7684 ";else if("month"==a)c=1==b?"\u6bcf\u6708\u7684 ":"\u6bcf\u9694 "+b+" \u6708\u7684 ";else if("year"==
a)c=1==b?"\u6bcf\u5e74\u7684 ":"\u6bcf\u9694 "+b+" \u5e74\u7684 ";return c}};Ext.ns("Ext.ux.calendar");Ext.ux.calendar.DataSource=function(a){Ext.apply(this,a);Ext.ux.calendar.DataSource.superclass.constructor.call(this)};
Ext.extend(Ext.ux.calendar.DataSource,Ext.util.Observable,{showAllCalendar:function(a,b){CalendarAppDirect.showAllTag(this.key,function(c,d){c&&c.success?a.call(b||this,c):MixkyApp.showDirectActionFail("\u663e\u793a\u6240\u6709\u5206\u7c7b\u9879",c,d)})},showOnlyCalendar:function(a,b,c){CalendarAppDirect.showOnlyTag(this.key,a,function(d,e){d&&d.success?b.call(c||this,d):MixkyApp.showDirectActionFail("\u4ec5\u663e\u793a\u5206\u7c7b\u9879",d,e)})},createUpdateCalendar:function(a,b,c){if(a.id===0)MixkyApp.showErrorMessage("\u4e0d\u5141\u8bb8\u4fee\u6539\u7cfb\u7edf\u9ed8\u8ba4\u6807\u7b7e",
"\u9519\u8bef\u63d0\u793a");else{a.hide=a.hide?1:0;CalendarAppDirect.updateTag(this.key,a,function(d,e){d&&d.success?b.call(c||this,d):MixkyApp.showDirectActionFail("\u6dfb\u52a0/\u66f4\u65b0\u5206\u7c7b\u9879",d,e)})}},deleteEventsByCalendar:function(a,b,c){CalendarAppDirect.deleteEventsByTag(this.key,a,function(d,e){d&&d.success?b.call(c||this,d):MixkyApp.showDirectActionFail("\u6e05\u7a7a\u5206\u7c7b\u9879\u65e5\u7a0b\u4fe1\u606f",d,e)})},deleteCalendar:function(a,b,c){a==0?MixkyApp.showErrorMessage("\u4e0d\u5141\u8bb8\u5220\u9664\u7cfb\u7edf\u9ed8\u8ba4\u6807\u7b7e",
"\u9519\u8bef\u63d0\u793a"):CalendarAppDirect.deleteTag(this.key,a,function(d,e){d&&d.success?b.call(c||this,d):MixkyApp.showDirectActionFail("\u5220\u9664\u5206\u7c7b\u9879\u65e5\u7a0b\u4fe1\u606f",d,e)})},loadCalendar:function(a,b){var c=this;CalendarAppDirect.loadTags(this.key,function(d,e){if(d&&d.success){c.initCalendarColor(d.results);sucessFn.call(b||this,d)}else MixkyApp.showDirectActionFail("\u5220\u9664\u5206\u7c7b\u9879\u65e5\u7a0b\u4fe1\u606f",d,e)})},loadEvent:function(a,b,c,d){a=a||
new Date;b=b||new Date;a=a.format("Y-m-d");b=b.format("Y-m-d");CalendarAppDirect.loadEvents(this.key,a,b,function(e,f){if(e&&e.success){e=e.results;var g={};g.whole=[];for(var h=Ext.ux.calendar.Mask.getRowFromHM,j=0,i=e.length;j<i;j++){f=e[j];var n=h(f.startTime,this.intervalSlot),m=h(f.endTime,this.intervalSlot);if(!this.hideInactiveRow||this.activeStartRow<=n&&m<=this.activeEndRow||0==n&&this.rowCount==m){var l=f.ymd,o=f.eymd;g[l]=g[l]||[];f={eventId:f.id,calendarId:f.calendarId,color:f.color,startRow:n,
endRow:m,subject:f.subject,content:f.description,day:l,eday:o,alertFlag:f.alertFlag,locked:f.locked,repeatType:f.repeatType};if(l!=o||0==n&&this.rowCount==m)g.whole.push(f);else{g[l]=g[l]||[];g[l].push(f)}}}c.call(d||this,g)}else MixkyApp.showDirectActionFail("\u88c5\u8f7d\u65e5\u7a0b\u4fe1\u606f",e,f)})},loadRepeatEvent:function(a,b){CalendarAppDirect.loadRepeatEvents(this.key,function(c,d){if(c&&c.success){c=c.results;d={};for(var e=Ext.ux.calendar.Mask.getRowFromHM,f=0,g=c.length;f<g;f++){var h=
c[f],j=e(h.startTime,b.intervalSlot),i=e(h.endTime,b.intervalSlot);h={eventId:h.id,calendarId:h.calendarId,color:h.color,startRow:j,endRow:i,subject:h.subject,content:h.description,repeatType:h.repeatType,alertFlag:h.alertFlag,locked:h.locked};d[h.eventId]=h}a.call(b||this,d)}else MixkyApp.showDirectActionFail("\u88c5\u8f7d\u91cd\u590d\u65e5\u7a0b\u9879\u4fe1\u606f",c,d)})},createEvent:function(a,b,c){var d=a.day||(new Date).format("Y-m-d");a={id:0,calendarId:a.calendarId,startDay:d,endDay:a.eday||
d,startTime:Ext.ux.calendar.Mask.getIntervalFromRow(c.intervalSlot,a.startRow),endTime:Ext.ux.calendar.Mask.getIntervalFromRow(c.intervalSlot,a.endRow),repeatType:a.repeatType,alertFlag:a.alertFlag?1:0,locked:a.locked?1:0,subject:a.subject,description:a.content};CalendarAppDirect.updateEvent(this.key,a,function(e,f){e&&e.success?b.call(c||this,e):MixkyApp.showDirectActionFail("\u6dfb\u52a0\u65e5\u7a0b",e,f)})},updateEvent:function(a,b,c){var d=a.day||(new Date).format("Y-m-d");a={id:a.eventId,calendarId:a.calendarId,
startDay:d,endDay:a.eday||d,startTime:Ext.ux.calendar.Mask.getIntervalFromRow(c.intervalSlot,a.startRow),endTime:Ext.ux.calendar.Mask.getIntervalFromRow(c.intervalSlot,a.endRow),repeatType:a.repeatType,oldRepeatType:a.oldRepeatType,alertFlag:a.alertFlag?1:0,locked:a.locked?1:0,subject:a.subject,description:a.content};CalendarAppDirect.updateEvent(this.key,a,function(e,f){e&&e.success?b.call(c||this,e):MixkyApp.showDirectActionFail("\u66f4\u65b0\u65e5\u7a0b",e,f)})},deleteEvent:function(a,b,c){CalendarAppDirect.deleteEvent(this.key,
a.eventId,function(d,e){d&&d.success?b.call(c||this,d):MixkyApp.showDirectActionFail("\u5220\u9664\u65e5\u7a0b",d,e)})},deleteRepeatEvent:function(a,b,c,d){CalendarAppDirect.deleteRepeatEvent(this.key,a.eventId,b,a.repeatType,function(e,f){e&&e.success?c.call(d||this,e):MixkyApp.showDirectActionFail("\u5220\u9664\u53ef\u91cd\u590d\u65e5\u7a0b",e,f)})},changeDay:function(a,b,c,d,e){CalendarAppDirect.changeDay(this.key,a,b,e,function(f,g){f&&f.success?c.call(d||this,f):MixkyApp.showDirectActionFail("\u590d\u5236/\u7c98\u5e16\u65e5\u7a0b",
f,g)})},deleteDay:function(a,b,c){Ext.Msg.confirm("\u5371\u9669\u64cd\u4f5c\u63d0\u793a","\u5220\u9664"+a+"\u6240\u6709\u65e5\u7a0b\uff0c\u60a8\u786e\u5b9a\u5417\uff1f",function(d){d=="yes"&&CalendarAppDirect.deleteDay(this.key,a,function(e,f){e&&e.success?b.call(c||this,e):MixkyApp.showDirectActionFail("\u5220\u9664\u65e5\u7a0b",e,f)})},this)},createUpdateRepeatEvent:function(a,b,c,d){var e=Ext.ux.calendar.Mask.getIntervalFromRow(d.intervalSlot,a.startRow),f=Ext.ux.calendar.Mask.getIntervalFromRow(d.intervalSlot,
a.endRow);e={calendarId:a.calendarId,startDay:a.day,endDay:a.eday,startTime:e,endTime:f,repeatType:"string"==Ext.type(a.repeatType)?a.repeatType:Ext.encode(a.repeatType),alertFlag:a.alertFlag?1:0,locked:a.locked?1:0,subject:a.subject,description:a.content};if(b)e.oldRepeatType="string"==Ext.type(b.repeatType)?b.repeatType:Ext.encode(b.repeatType);if("prepare"!=a.eventId)e.id=a.eventId;if(b)e.oldRepeatType="string"==Ext.type(b.repeatType)?b.repeatType:Ext.encode(b.repeatType);CalendarAppDirect.updateRepeatEvent(this.key,
e,function(g,h){g&&g.success?c.call(d||this,g):MixkyApp.showDirectActionFail("\u521b\u5efa\u66f4\u65b0\u91cd\u590d\u65e5\u7a0b",g,h)})},initialLoad:function(a,b,c){var d=this;CalendarAppDirect.initialLoad(this.key,function(e,f){if(e&&e.success){var g=e.cs[0];g=Ext.ux.calendar.Mask.calculateActiveRow(g);Ext.apply(this,g);e.cs=g;g=e.re;var h={},j=Ext.ux.calendar.Mask.getRowFromHM;d.initCalendarColor(e.owned);for(var i=0,n=g.length;i<n;i++){f=g[i];var m=j(f.startTime,this.intervalSlot),l=j(f.endTime,
this.intervalSlot);f={eventId:f.id,calendarId:f.calendarId,color:f.color,startRow:m,endRow:l,subject:f.subject,content:f.description,repeatType:f.repeatType,alertFlag:f.alertFlag,locked:f.locked};h[f.eventId]=f}e.re=h;b.call(c||this,e)}else MixkyApp.showDirectActionFail("\u521d\u59cb\u5316\u88c5\u8f7d",e,f)})},getSearchStore:function(){if(!this.searchStore)this.searchStore=new Ext.data.GroupingStore({proxy:new Ext.data.DirectProxy({paramsAsHash:true,paramOrder:["key","text","start","limit"],directFn:CalendarAppDirect.searchEvents}),
baseParams:{key:this.key},reader:new Ext.data.JsonReader({root:"results",id:"id",totalProperty:"totals"},[{name:"id"},{name:"calendarId"},{name:"startTime"},{name:"endTime"},{name:"subject"},{name:"description"},{name:"ymd"},{name:"eymd"},{name:"color"},{name:"isShared"},{name:"alertFlag"},{name:"locked"},{name:"repeatType"}]),sortInfo:{field:"ymd",direction:"DESC"},groupField:"ymd"});return this.searchStore},initCalendarColor:function(a){for(var b=Ext.ux.calendar.Mask.colorIndex.length,c=0;c<a.length;c++)if(!a[c].color||
a[c].color=="")a[c].color=Ext.ux.calendar.Mask.colorIndex[c%b]}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.BackThread=function(a){Ext.apply(this,a);this.runner=new Ext.util.TaskRunner;this.timelineTask={run:function(b){b=b.mainPanel.calendarContainer.getLayout().activeItem;if(b instanceof Ext.ux.calendar.DayView){b.setToday();b.updateTimeline()}else b instanceof Ext.ux.calendar.MonthView&&b.setToday()},args:[this.ehandler],interval:6E4};this.expireTask={run:function(b){b=b.mainPanel.calendarContainer.getLayout().activeItem;b instanceof Ext.ux.calendar.ResultView&&b.list.getView().refresh()},
args:[this.ehandler],interval:18E5};Ext.ux.calendar.BackThread.superclass.constructor.call(this);this.runner.start(this.timelineTask)};Ext.extend(Ext.ux.calendar.BackThread,Ext.util.Observable,{destroy:function(){this.runner.stopAll()}});Ext.ns("Ext.ux.calendar");Ext.ux.calendar.BasicView=Ext.extend(Ext.Panel,{daySet:[],checkLayout:Ext.emptyFn,renderEvent:Ext.emptyFn,resetSCover:Ext.emptyFn,resizePort:Ext.emptyFn});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.CalendarContainer=function(a){Ext.apply(this,a);var b=this.ehandler;a=b.calendarSetting;b=b.lang.CalendarContainer;var c=new Date;this.endDate=this.startDate=c;this.dayView=new Ext.ux.calendar.DayView({dayFormat:a.dayFormat,offsetPercent:0.05,shiftDay:1,dayNum:1,startColIndex:0,endColIndex:1,ehandler:this.ehandler});this.weekView=new Ext.ux.calendar.DayView({dayFormat:a.weekFormat,offsetPercent:0.1,shiftDay:7,dayNum:7,startColIndex:0,endColIndex:7,ehandler:this.ehandler});this.weekOnlyView=
new Ext.ux.calendar.DayView({dayFormat:a.weekFormat,offsetPercent:0.1,dayNum:5,shiftDay:7,startColIndex:0,endColIndex:5,ehandler:this.ehandler});this.monthView=new Ext.ux.calendar.MonthView({dayFormat:a.monthFormat,dayNum:7,shiftDay:7,startColIndex:0,endColIndex:7,ehandler:this.ehandler});this.resultView=new Ext.ux.calendar.ResultView({ehandler:this.ehandler});this.detailEditor=new Ext.ux.calendar.DetailEditor({ehandler:this.ehandler});this.backBtn=new Ext.Button({iconCls:"icon-sys-calendar-back",
handler:this.onBackFn,scope:this});this.nextBtn=new Ext.Button({iconCls:"icon-sys-calendar-next",handler:this.onNextFn,scope:this});this.todayBtn=new Ext.Button({text:b["todayBtn.text"],iconCls:"icon-sys-calendar-today",handler:this.onTodayFn,scope:this});this.refreshBtn=new Ext.Button({iconCls:"x-tbar-loading",handler:this.onRefreshFn,scope:this});this.dayBtn=new Ext.Button({iconCls:"icon-sys-calendar-dayview",text:b["dayBtn.text"],handler:this.onDayFn,scope:this});this.weekMenu=new Ext.menu.Menu({items:[{text:b["weekMenu.showAll.text"],
checked:true,group:"week",handler:this.onWeekAllFn,scope:this},{text:b["weekMenu.onlyWeek.text"],checked:false,group:"week",handler:this.onWeekOnlyFn,scope:this}]});this.weekBtn=new Ext.SplitButton({iconCls:"icon-sys-calendar-weekview",text:b["weekBtn.text"],pressed:true,arrowAlign:"right",menu:this.weekMenu,handler:this.onWeekFn,scope:this});this.monthMenu=new Ext.menu.Menu({items:[{text:b["monthMenu.showAll.text"],checked:true,group:"month",handler:this.onMonthAllFn,scope:this},{text:b["monthMenu.onlyWeek.text"],
checked:false,group:"month",handler:this.onMonthOnlyFn,scope:this}]});this.monthBtn=new Ext.SplitButton({iconCls:"icon-sys-calendar-monthview",text:b["monthBtn.text"],arrowAlign:"right",menu:this.monthMenu,handler:this.onMonthFn,scope:this});this.searchField=new Ext.form.TextField({width:250,listeners:{specialkey:{fn:function(d,e){e.getKey()==e.ENTER&&this.onSearchFn()},scope:this}}});this.searchBtn=new Ext.Button({iconCls:"icon-sys-calendar-search",handler:this.onSearchFn,scope:this});Ext.ux.calendar.CalendarContainer.superclass.constructor.call(this,
{border:false,region:"center",cls:"x-calendar-container",layout:"card",layoutConfig:{deferredRender:true},activeItem:1,items:[this.dayView,this.weekView,this.monthView,this.resultView,this.weekOnlyView,this.detailEditor],tbar:[this.backBtn,this.nextBtn,this.todayBtn,"-",b["searchCriteria.text"],this.searchField,this.searchBtn,"->",this.refreshBtn,"-",this.dayBtn,"-",this.weekBtn,"-",this.monthBtn,"-"]});this.addEvents("refresh","editcalendar");this.currentView=this.weekView;this.currentIdx=1;this.currentView.on("afterresize",
this.onAfterResizeFn,this,{single:true});this.weekView.on("viewDay",this.onDayChangeFn,this);this.weekOnlyView.on("viewDay",this.onDayChangeFn,this);this.monthView.on("viewDay",this.onDayChangeFn,this);this.monthView.on("viewWeek",this.onWeekChangeFn,this);this.dayView.on("viewWeek",this.onWeekChangeFn,this);this.relayEvents(this.dayView,["beforeremoteload","remoteload","hideeditor"]);this.relayEvents(this.weekView,["beforeremoteload","remoteload","hideeditor"]);this.relayEvents(this.weekOnlyView,
["beforeremoteload","remoteload","hideeditor"]);this.relayEvents(this.monthView,["beforeremoteload","remoteload","hideeditor"]);this.dayView.relayEvents(this,["canceldetail"]);this.weekView.relayEvents(this,["canceldetail"]);this.weekOnlyView.relayEvents(this,["canceldetail"]);this.monthView.relayEvents(this,["canceldetail"]);this.on("mousedown",this.onMMouseDownFn,this);this.on("showdetailsetting",this.onShowDetailSettingFn,this);this.on("refresh",this.refresh,this)};
Ext.extend(Ext.ux.calendar.CalendarContainer,Ext.Panel,{onAfterResizeFn:function(){try{this.ehandler.fireEvent("calendarloaded")}catch(a){}},onShowDetailSettingFn:function(a){this.getLayout().setActiveItem(5);this.detailEditor.setup(a)},onBackFn:function(){var a=this.currentView;this.getLayout().setActiveItem(this.currentIdx);a.goBack();this.changeLabel(a)},onNextFn:function(){var a=this.currentView;this.getLayout().setActiveItem(this.currentIdx);a.goNext();this.changeLabel(a)},onTodayFn:function(){this.showDay(new Date)},
onDayFn:function(a){if(this.currentView!=this.dayView){this.showPressed(a);a=this.dayView;this.getLayout().setActiveItem(0);a.showRange(this.startDate,this.endDate);this.changeLabel(a)}},onWeekFn:function(a){if(true===a.weekdayFlag)this.onWeekOnlyFn();else this.currentView!=this.weekView&&this.onWeekAllFn()},onWeekAllFn:function(){if(this.currentView!=this.weekView){var a=this.weekView;this.weekBtn.weekdayFlag=false;this.showPressed(this.weekBtn);this.getLayout().setActiveItem(1);a.showRange(this.startDate,
this.endDate,true);this.changeLabel(a)}},onWeekOnlyFn:function(){if(this.currentView!=this.weekOnlyView){this.weekBtn.weekdayFlag=true;this.showPressed(this.weekBtn);var a=this.weekOnlyView;this.getLayout().setActiveItem(4);a.showRange(this.startDate,this.endDate,true);this.changeLabel(a)}},onMonthFn:function(a){true==a.weekdayFlag?this.onMonthOnlyFn():this.onMonthAllFn()},onMonthAllFn:function(){var a=this.monthView;this.monthBtn.weekdayFlag=false;if(this.currentView!=this.monthView){this.showPressed(this.monthBtn);
this.getLayout().setActiveItem(2);a.startColIndex=0;a.endColIndex=7;a.colNum=7;a.showRange(this.startDate,this.endDate);this.changeLabel(a)}else{a.startColIndex=0;a.endColIndex=7;a.colNum=7;a.cleanup();a.recalculateSize(a.body.getWidth(),a.body.getHeight());a.showCache()}},onMonthOnlyFn:function(){var a=this.monthView;this.monthBtn.weekdayFlag=true;var b=1==a.startDay?1:0;if(this.currentView!=this.monthView){this.showPressed(this.monthBtn);this.getLayout().setActiveItem(2);a.colNum=5;a.startColIndex=
1-b;a.endColIndex=6-b;a.showRange(this.startDate,this.endDate);this.changeLabel(a)}else{a.colNum=5;a.startColIndex=1-b;a.endColIndex=6-b;a.cleanup();a.recalculateSize(a.body.getWidth(),a.body.getHeight());a.showCache()}},showPressed:function(a){this.dayBtn.el.removeClass("x-btn-pressed");this.weekBtn.el.removeClass("x-btn-pressed");this.monthBtn.el.removeClass("x-btn-pressed");a.el.addClass("x-btn-pressed");if(a==this.dayBtn){this.currentIdx=0;this.currentView=this.dayView}else if(a==this.weekBtn)if(true!==
this.weekBtn.weekdayFlag){this.currentIdx=1;this.currentView=this.weekView}else{this.currentIdx=4;this.currentView=this.weekOnlyView}else if(a==this.monthBtn||a==this.monthOnlyBtn){this.currentIdx=2;this.currentView=this.monthView}},showDay:function(a){var b=this.currentView;this.getLayout().setActiveItem(this.currentIdx);b.showDay(a);this.changeLabel(b)},showSingleDay:function(a){var b=this.dayView;b.daySet[0]=a;if(this.currentView!=this.dayView){this.showPressed(this.dayBtn);this.getLayout().setActiveItem(0);
b.resetView();b.fireEvent("checklayout",true);this.changeLabel(b)}},onDayChangeFn:function(a,b){this.showSingleDay(b)},onWeekChangeFn:function(a){this.showPressed(this.weekBtn);var b=this.currentView;this.getLayout().setActiveItem(this.currentIdx);b.showDay(a);this.changeLabel(b)},changeLabel:function(a){this.startDate=a.daySet[0];this.endDate=a.daySet[a.daySet.length-1];this.fireEvent("changedate",this.startDate,this.endDate)},onSearchFn:function(){var a=this.resultView;this.getLayout().setActiveItem(3);
a.list.getStore().removeAll();a.loadEvents.defer(1,a,[this.searchField.getValue()])},onCalendarLoadedFn:function(){this.currentView.checkLayout(true)},onRefreshFn:function(){this.refresh()},refresh:function(a){var b=this.ehandler,c=this.ownerCt.westPanel,d,e;if(c.myCalendarPanel)d=c.myCalendarPanel.body;if(c.otherCalendarPanel)e=c.otherCalendarPanel.body;b.fireEvent("reloadCalendar",d,e,a)},onMMouseDownFn:function(){this.fireEvent("canceldetail");this.fireEvent("hideeditor")}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.CalendarEditor=function(a){Ext.apply(this,a);a=this.ehandler.lang.CalendarEditor;this.nameField=new Ext.form.TextField({name:"name",fieldLabel:a["nameField.label"],allowBlank:false,anchor:"99%"});this.descriptionField=new Ext.form.TextArea({name:"description",fieldLabel:a["descriptionField.label"],anchor:"99%"});this.colorField=new Ext.ColorPalette({});this.colorField.on("select",this.onColorSelectFn,this);this.colorField.colors=Ext.ux.calendar.Mask.colors;this.clearBtn=new Ext.Button({iconCls:"icon-sys-calendar-delete",
minWidth:80,text:a["clearBtn.text"],handler:this.onClearFn,scope:this});this.saveBtn=new Ext.Button({iconCls:"icon-sys-calendar-accept",minWidth:80,text:a["saveBtn.text"],handler:this.onSaveFn,scope:this});this.cancelBtn=new Ext.Button({iconCls:"icon-sys-calendar-cancel",minWidth:80,text:a["cancelBtn.text"],handler:this.onCancelFn,scope:this});this.formpanel=new Ext.form.FormPanel({cls:"x-calendar-menu",border:false,style:"padding:10px;",labelWidth:70,items:[this.nameField,this.descriptionField,{border:false,
style:"padding-left:60px;",items:[this.colorField]}],buttonAlign:"right",buttons:[this.clearBtn,this.saveBtn,this.cancelBtn]});Ext.ux.calendar.CalendarEditor.superclass.constructor.call(this,{width:500,height:200,closable:false,closeAction:"hide",layout:"fit",modal:true,resizable:false,items:[{border:false,layout:"fit",items:[this.formpanel]}]})};
Ext.extend(Ext.ux.calendar.CalendarEditor,Ext.Window,{onColorSelectFn:function(a,b){this.color=Ext.ux.calendar.Mask.getIndexByColor(b)},popup:function(a){this.action=a.action;this.show();var b=this.ehandler.lang.CalendarEditor;if("add"==a.action){this.setTitle(b["new.title"]);this.setIconClass("icon-sys-calendar-calendar")}else{this.setTitle(b["edit.title"]);this.setIconClass("icon-sys-calendar-calendar_edit")}this.calendarEl=a.cEl?a.cEl:null;b=Ext.ux.calendar.Mask;if(a.data){a=this.calendar=a.data;
this.nameField.setValue(a.name);this.descriptionField.setValue(a.description);(a=Ext.ux.calendar.Mask.getColorByIndex(a.color))?this.colorField.select(a):this.colorField.select(b.colors[0])}else{this.nameField.reset();this.descriptionField.reset();this.colorField.select(b.colors[0])}},onClearFn:function(){this.formpanel.form.reset()},onSaveFn:function(){if(this.formpanel.form.isValid()){var a={};if(this.calendar){a.id=this.calendar.id;a.hide=this.calendar.hide}else a.hide=false;a.name=this.nameField.getValue();
a.description=this.descriptionField.getValue();a.color=this.color;var b=this.ehandler;b.ds.createUpdateCalendar(a,function(c){var d=this.calendarEl;if(d){c=d.calendar.color;Ext.apply(d.calendar,a);var e=d.calendar.color;b.calendarSet[d.calendar.id]=d.calendar;var f=d.child(".x-calendar-title-b");if(f)f.dom.innerHTML="<b>"+a.name+"</b>";if(c!=e){d.calendar.color=c;b.changeColor(d.calendar,e)}}else if(c.id){d=Ext.apply({},a);d.id=c.id;b.calendarSet[d.id]=d;b.createCalendar(b.mainPanel.westPanel.myCalendarPanel.body,
null,null,d);b.ss[b.ss.length]=Ext.util.CSS.createStyleSheet("."+b.id+"-x-calendar-"+d.id+"{}",Ext.id())}},this);this.hide()}},onCancelFn:function(){this.hide()}});Ext.ns("Ext.ux.calendar");Ext.ux.calendar.CalendarWin=Ext.extend(Ext.Window,{initComponent:function(){this.mainPanel=new Ext.ux.calendar.MainPanel({datasource:this.datasource,calendarSetting:this.calendarSetting});Ext.ux.calendar.CalendarWin.superclass.initComponent.call(Ext.apply(this,{layout:"fit",items:[this.mainPanel]}))}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.CommentTip=Ext.extend(Ext.Tip,{closable:true,closeAction:"hide",showTip:function(a,b,c,d,e){this.setTitle(a);if(this.rendered)this.body.update(b);else this.html=b;this.showBy(c,d);e=e||5E3;(function(){this.hide()}).defer(e,this)}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.DayView=Ext.extend(Ext.ux.calendar.BasicView,{createByDblclick:false,hideInactiveRow:false,activeStartRow:0,activeEndRow:48,startRow:0,endRow:48,cls:"x-dayview-ct",lineNum:3,border:false,weekNum:1,dayNum:1,dayFormat:"m/d(D)",thin:4,leftWidth:70,scrollOffset:17,offsetPercent:0.1,headerHeight:30,rowHeight:26,poolMaxDepth:4,poolDepth:0,generateCSS:function(){var a="."+this.id+"-x-dayview-viewer-row-height{}."+this.id+"-x-dayview-pool{overflow:hidden;}."+this.id+"-x-dayview-pool-height{}."+
this.id+"-x-dayview-pool-width{}."+this.id+"-x-dayview-pool-viewer-width{}."+this.id+"-x-dayview-lefter-width{width:"+this.leftWidth+"px;}",b=Ext.id();this.ss=Ext.util.CSS.createStyleSheet(a,b)},updateTimeline:function(){for(var a=new Date,b=a.format("Y-m-d"),c=0,d=this.daySet.length;c<d;c++)if(b==this.daySet[c].format("Y-m-d"))break;if(this.timelinePn&&this.timeindexPn){this.timeindexPn.removeClass("x-dayview-timeindex");this.timelinePn.removeClass("x-dayview-timeline")}if(c!=d){b=c%this.dayNum;
c=parseInt(a.format("G"));a=a.format("i");if("0"==a[0])a=a.slice(1);d=parseInt(a);a=this.intervalSlot;c=c*this.numInHour+Math.floor(d/a);d=d%a;b=Ext.get(this.id+"-x-dayview-viewer-"+c+"-"+b);c=Ext.get(this.id+"-x-dayview-lefter-"+c+"-0");if(b&&c){a=Math.floor(d/a*100);b.addClass("x-dayview-timeline");b.setStyle("background-position","0% "+a+"%");c.addClass("x-dayview-timeindex");c.setStyle("background-position","0% "+a+"%");this.timelinePn=b;this.timeindexPn=c}}},generateHTML:function(){this.generateCSS();
for(var a="",b=this.numInHour,c=this.startRow;c<this.endRow;c++){a+='<tr id="'+this.id+"-x-dayview-lefter-row-"+c+'">';for(var d=0;d<1;d++){var e=Ext.ux.calendar.Mask.getIntervalFromRow(this.intervalSlot,c,this.hourFormat);e=0!=c%b&&c!=this.activeStartRow?'<div class="x-dayview-viewer-row-height" style="text-align:right;"><i><b class="x-dayview-lefter-inner x-dayview-lefter-fine-inner">'+e+"</b></i></div>":'<div class="x-dayview-viewer-row-height"><b class="x-dayview-lefter-inner">'+e+"</b></div>";
a+='<td id="'+this.id+"-x-dayview-lefter-"+c+"-"+d+'" class="'+this.id+"-x-dayview-lefter-td x-dayview-lefter-row-height x-dayview-lefter-cell "+(0!=(c+1)%b?"x-dayview-lefter-odd-row":"x-dayview-lefter-even-row")+'">'+e+"</td>"}a+="</tr>"}e="";for(c=this.startRow;c<this.endRow;c++){e+='<tr id="'+this.id+"-x-dayview-viewer-row-"+c+'">';for(d=0;d<this.dayNum;d++)e+='<td class="'+this.id+"-x-dayview-viewer-td "+this.id+"-x-dayview-viewer-col-"+d+" "+(0!=(c+1)%b?"x-dayview-odd-row":"x-dayview-even-row")+
'"><div id="'+this.id+"-x-dayview-viewer-"+c+"-"+d+'" class="x-dayview-viewer-row-height x-dayview-viewer-cell"></div></td>';e+="</tr>"}a='<div id="'+this.id+'-x-dayview-port" class="x-dayview-port x-dayview-inactive" unselectable="on" onselectstart="return false;"><div id="'+this.id+'-x-dayview-body" class="x-dayview-body x-dayview-inactive" unselectable="on" onselectstart="return false;"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="x-dayview-lefter '+this.id+
'-x-dayview-lefter-width"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody>'+a+'</tbody></table></td><td class="x-dayview-viewer"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody>'+e+"</tbody></table></td></tr></tbody></table></div></div>";c="";this.dayTpl=new Ext.XTemplate('<tpl for="."><td class="x-dayview-header-days"><div class="'+this.id+'-x-dayview-pool-height"><b><u id="'+this.id+'-x-dayview-day-link-0-{idx}" class="x-dayview-header-day-link">{day}</u></b></div></td></tpl>');
c=[];for(d=0;d<this.dayNum;d++)c[c.length]={idx:d,day:this.daySet[d].format(this.dayFormat)};c=this.dayTpl.apply(c);d=this.daySet[0].getWeekOfYear();d=1==this.dayNum?'<u><b id="'+this.id+'-x-dayview-wn" class="x-dayview-wn-link">'+d+"</b></u>":'<b id="'+this.id+'-x-dayview-wn">'+d+"</b>";d='<div id="'+this.id+'-x-dayview-header" class="x-dayview-header" unselectable="on" onselectstart="return false;"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="x-dayview-header-lefter '+
this.id+'-x-dayview-lefter-width"><div class="x-dayview-wn">'+d+'</div></td><td class="x-dayview-header-viewer"><table width="100%" height="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr>'+c+'</tr></tbody></table></td><td width="'+this.scrollOffset+'px;"></td></tr></tbody></table></div>';b="";for(c=0;c<this.dayNum;c++)b+='<td id="'+this.id+"-x-dayview-bg-0-"+c+'" class="x-dayview-bg-cell">&nbsp;</td>';b='<table class="x-dayview-bg" width="100%" height="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr>'+
b+"</tr></tbody></table>";return d+('<div id="'+this.id+'-x-dayview-pool" class="x-dayview-pool" unselectable="on" onselectstart="return false;"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="x-dayview-header-lefter '+this.id+'-x-dayview-lefter-width" style="vertical-align:top;"><div id="'+this.id+'-x-dayview-pool-switch" class="x-dayview-pool-collapse"></div></td><td><div id="'+this.id+'-x-dayview-pool-viewer" class="'+this.id+'-x-dayview-pool-width x-dayview-pool-viewer">'+
b+'<table id="'+this.id+'-x-dayview-pool-ct" width="100%" class="x-dayview-ct" cellspacing="0" cellpadding="0" border="0"><tbody><tr></tr></tbody></table><div class="x-dayview-pool-rest"></div></div></td><td width="'+this.scrollOffset+'px;"></tr></tbody></table></div>')+a},setToday:function(){for(var a=(new Date).format("Y-m-d"),b=this.daySet.length,c,d=0;d<b;d++)if(this.daySet[d].format("Y-m-d")===a){c=d;break}for(d=0;d<this.dayNum;d++)(b=Ext.get(this.id+"-x-dayview-bg-0-"+d))&&b.setStyle("background-color",
"white");if(a=false!=Ext.type(c))(b=Ext.get(this.id+"-x-dayview-bg-0-"+c))&&b.setStyle("background-color","rgb(255,255,214)");for(d=this.activeStartRow;d<this.activeEndRow;d++)for(b=0;b<this.dayNum;b++){var e=Ext.get(this.id+"-x-dayview-viewer-"+d+"-"+b);if(e){e=Ext.get(e.dom.parentNode);a&&b==c?e.setStyle("background-color","rgb(255,255,214)"):e.setStyle("background-color","white")}}},getStartDate:function(a){if(1==this.dayNum)a=a;else if(5==this.dayNum){var b=a.format("N");if(7==b)b=0;b=1-b;a=a.add(Date.DAY,
b)}else if(1==this.startDay){b=a.format("N");b=1-b;a=a.add(Date.DAY,b)}else{b=a.format("w");a=a.add(Date.DAY,-b)}return a},initComponent:function(){this.id=Ext.id();this.daySet=[];this.ehandler.applyCalendarSetting(this);for(var a=this.getStartDate(new Date),b=0,c=this.dayNum;b<c;b++)this.daySet[this.daySet.length]=a.add(Date.DAY,b);this.html=this.generateHTML();Ext.ux.calendar.DayView.superclass.initComponent.call(this);this.addEvents("checklayout","sizechanged","afterresize","beforeremoteload",
"remoteload","canceldetail","viewDay","viewWeek");this.on("afterrender",this._onAfterRenderFn,this);this.on("checklayout",this.checkLayout,this);this.on("canceldetail",this.onCancelDetailFn,this);this.on("afterlayout",this._onReSizingFn,this);this.on("bodyresize",this._onReSizingFn,this);this.on("sizechanged",this.onSizeChangedFn,this,{buffer:50});Ext.EventManager.on(document,"mouseup",this._onMouseUpFn,this)},_onReSizingFn:function(){this.fireEvent("sizechanged")},onSizeChangedFn:function(){this.handleResize(this.body.getWidth(),
this.body.getHeight())},onCancelDetailFn:function(){if(this.detailing){this.detailing=false;this.detailCt.setStyle("display","none")}},resetDragEventEl:function(){if(this.dragEventEl){var a=this.ehandler;delete this.dragEventEl.row;delete this.dragEventEl;delete this.moving;a.floating=false}},resetPrepareEl:function(){if(this.preEl){this.ehandler.showEditor(this.preEl,this,"add");delete this.preEl}},resetSCover:function(){delete this.startPos;delete this.endPos;this.hideSCovers()},endDragEventEl:function(a){var b=
a.cview,c=this.ehandler;c.floating=false;var d=a.bindEvent,e=a.col,f=a.nol;if(false==Ext.type(f)){f=e;a.nol=f}a=a.row||d.startRow;var g=d.endRow-d.startRow;if(f==e){d.startRow=a;d.endRow=a+g;if("string"==Ext.type(d.repeatType))c.updateEvent(d,b,e);else{var h=Ext.apply({},d);d.repeatType="exception";h.startRow=h.oldStartRow;h.endRow=h.oldEndRow;c.updateRepeatEvent(d,this,h)}}else{h=Ext.apply({},d);d.startRow=a;d.endRow=a+g;var j=b.daySet[f];a=Ext.ux.calendar.Mask.getDayOffset(d.day,d.eday);d.day=j.format("Y-m-d");
j=j.add(Date.DAY,a);d.eday=j.format("Y-m-d");if("string"==Ext.type(h.repeatType))c.ds.updateEvent(d,function(){var i=c.calendarLayout.getLayout(b.daySet[e],b);i=i.updateLayout(h,"delete");c.renderEvent(b,i.elist,e);i=c.calendarLayout.getLayout(j,b);i=i.updateLayout(d,"add");c.renderEvent(b,i.elist,f);c.fireEvent("changeEventCache",c)},this);else{d.repeatType="exception";h.startRow=h.oldStartRow;h.endRow=h.oldEndRow;c.updateRepeatEvent(d,this,h)}}},endResizeEventEl:function(a){var b=this.ehandler;
b.floating=false;var c=a.bindEvent;if("string"==Ext.type(c.repeatType))b.updateEvent(c,this,a.col);else{a=Ext.apply({},c);c.repeatType="exception";a.startRow=a.oldStartRow;a.endRow=a.oldEndRow;b.updateRepeatEvent(c,this,a)}},_onMouseUpFn:function(a){var b=this.ehandler;this.resetPrepareEl();this.dragEventEl&&this.moving&&this.endDragEventEl(this.dragEventEl,a);this.resetDragEventEl();if(!this.dragging)if(this.startPos){a=Ext.apply({},this.startPos);var c=Ext.apply({},this.endPos);this.startPos=null;
b.prepareLegend(Ext.get(this.id+"-x-dayview-bg-0-"+c.y),a,c,this)}this.resizeEventEl&&this.endResizeEventEl(this.resizeEventEl);this.resetResizeEventEl()},getCellIndex:function(a){a=a.toString().split("-");var b=a.length,c=a[b-1];return{x:parseInt(a[b-2]),y:parseInt(c)}},_onAfterRenderFn:function(){this.initEls();this.setToday()},_onPortClickFn:function(a){var b=this.ehandler;a=a.getTarget();a=Ext.get(a);if(a.hasClass("x-event-pin"))if(a.hasClass("x-calendar-event-pin-off")){a.removeClass("x-calendar-event-pin-off");
a.addClass("x-calendar-event-pin-on");b.editDisabled=true}else{a.removeClass("x-calendar-event-pin-on");a.addClass("x-calendar-event-pin-off");b.editDisabled=false}else if(a.hasClass("x-event-content-link")){a=a.parent(".x-event-cover");a.bindEvent.locked||b.showEditor(a,this,"update")}else(a=a.hasClass("x-event-cover")?a:a.parent(".x-event-cover"))&&b.setEditingStatus(a,true,false)},_onPortMouseOverFn:function(a){a=a.getTarget();a=Ext.get(a);var b=false;if(a.hasClass("x-event-cover"))b=true;else if(a=
a.parent(".x-event-cover"))b=true;if(b){b=this.ehandler;b.editDisabled||b.setEditingStatus(a,true)}},_onBodyClickFn:function(a){a=a.getTarget();var b=Ext.get(a);a=this.ehandler;if(b.hasClass("x-dayview-pool-collapse")){b.removeClass("x-dayview-pool-collapse");b.addClass("x-dayview-pool-expand");this.lineNum=Math.floor(this.body.getHeight()/17)-5;this.checkLayout(Ext.isIE)}else if(b.hasClass("x-dayview-pool-expand")){b.addClass("x-dayview-pool-collapse");b.removeClass("x-dayview-pool-expand");this.lineNum=
3;this.checkLayout(Ext.isIE)}else if(b.hasClass("x-event-detail-tool-close"))this.fireEvent("canceldetail");else if(!a.readOnly&&(b.hasClass("x-whole-title-b")||b.hasClass("x-legend-title-b")))(b=b.parent(".x-whole-cover"))&&!b.bindEvent.locked&&a.showEditor(b,this,"update");else if(b.hasClass("x-dayview-header-day-link"))this.fireEvent("viewDay",this,this.daySet[this.getCellIndex(b.dom.id).y]);else if(b.hasClass("x-dayview-wn-link")){a=this.daySet[0];this.fireEvent("viewWeek",a,a)}},_onBodyContextMenuFn:function(a){a.stopEvent();
var b=this.ehandler,c=a.getTarget(),d=Ext.get(c);d.hasClass("x-calendar-event")||(d=d.parent(".x-calendar-event"));if(d){b.showContextMenu(a,d);this.menu.hide()}else if(this.createByDblclick){c=Ext.get(c);c.hasClass("x-dayview-pool-viewer")||(c=c.parent(".x-dayview-pool-viewer"));if(c){this.menu.pn=this.calculatePos(a);this.menu.showAt(a.getXY());b.cmenu.hide()}}},_onBodyDblclickFn:function(a){var b=this.ehandler,c=a.getTarget(),d=Ext.get(c);d.hasClass("x-calendar-event")||(d=d.parent(".x-calendar-event"));
if(d&&!d.bindEvent.locked)b.showEditor(d,this,"update");else if(this.createByDblclick){c=Ext.get(c);c.hasClass("x-dayview-pool-viewer")||(c=c.parent(".x-dayview-pool-viewer"));if(c){a=this.calculatePos(a);c=Ext.apply({},a);this.selectRange(a,c);this.startPos=null;b.prepareLegend(Ext.get(this.id+"-x-dayview-bg-0-"+a.y),a,c,this)}}},resetResizeEventEl:function(){this.resizeEventEl&&delete this.resizeEventEl},_onPortMouseDownFn:function(a){a.stopEvent();this.fireEvent("hideeditor");this.fireEvent("canceldetail");
if(0==a.button){a=a.getTarget();a=Ext.get(a);var b=this.ehandler;if(a.hasClass("x-dayview-viewer-cell")){if(!this.createByDblclick){this.preEl=b.prepareEvent(a,this);this.preEl.base=this.preEl.bindEvent.startRow;b.setEditingStatus(this.preEl,true);b.floating=true}}else if(a.hasClass("x-event-bottom-default")){b=a.parent(".x-event-cover");a=b.bindEvent;if(a.locked)this.resetResizeEventEl();else{a.oldStartRow=a.startRow;a.oldEndRow=a.endRow;this.resizeEventEl=b}}else if(!a.hasClass("x-event-pin")&&
!a.hasClass("x-event-content-link")){delete this.preEl;b=a;b.hasClass("x-event-cover")||(b=a.parent(".x-event-cover"));if(b){a=b.bindEvent;if(a.locked)this.resetDragEventEl();else{a.oldStartRow=a.startRow;a.oldEndRow=a.endRow;b.span=a.endRow-a.startRow;this.dragEventEl=b}}}}},movePrepareEl:function(a,b){var c=a.bindEvent,d=a.base,e=Ext.get(this.id+"-x-dayview-viewer-"+d+"-0"),f=e.getTop();e=e.getBottom();b=b.getXY()[1];if(b>=f){b=b-f;var g=Math.round(b/26);b=g*26;c.startRow=d;c.endRow=d+g+1;if(this.endRow<
c.endRow){c.endRow=this.endRow;b=26*(this.endRow-d-1)}a.contentEl.setHeight(b);a.titleEl.dom.innerHTML="<b>"+this.ehandler.generateTitle(c)+"</b>";a.setY(f)}else{b=e-b;g=Math.round(b/26);b=g*26;c.startRow=d-g;c.endRow=d+1;if(this.startRow>c.startRow){c.startRow=this.startRow;b=26*(c.endRow-c.startRow-1)}a.contentEl.setHeight(b);a.titleEl.dom.innerHTML="<b>"+this.ehandler.generateTitle(c)+"</b>";c=e-a.getHeight();a.setY(c)}},resizingEventEl:function(a,b){a.setStyle("cursor","s-resize");var c=a.bindEvent,
d=this.ehandler;d.floating=true;var e=b.getXY(),f=this.cbody.getLeft(),g=Ext.get(this.id+"-x-dayview-viewer-"+this.startRow+"-0"),h=g.getXY();b=g.getWidth();g=g.getHeight()+1;e=this.startRow+Math.ceil((e[1]-h[1])/g);if(this.endRow<e)e=this.endRow;f=Ext.get(this.id+"-x-dayview-viewer-"+(this.endRow==e?this.endRow-1:e)+"-"+a.col).getLeft()-f;c.endRow=e;if(this.endRow<c.endRow)c.endRow=this.endRow;if(c.endRow<=c.startRow)c.endRow=c.startRow+1;g=g*(c.endRow-c.startRow)-24;a.setStyle("left",f+"px");a.setStyle("width",
b+"px");a.contentEl.setHeight(g);a.titleEl.dom.innerHTML="<b>"+d.generateTitle(c)+"</b>";d.setEditingStatus(a,true)},moveEventEl:function(a,b){var c=this.ehandler,d=b.getXY(),e=this.cbody.getLeft(),f=this.cbody.getTop(),g=Ext.get(this.id+"-x-dayview-viewer-"+this.startRow+"-0"),h=g.getXY();b=g.getWidth();var j=g.getHeight()+1;g=d[0]-h[0];d=this.startRow+Math.ceil((d[1]-h[1])/j);h=Math.floor(g/b);d-=1;if(this.startRow>d)d=this.startRow;else if(this.endRow<=d)d=this.endRow-1;if(0>h)h=0;else if(this.dayNum<=
h)h=this.dayNum-1;g=Ext.get(this.id+"-x-dayview-viewer-"+d+"-"+h);e=g.getLeft()-e;f=g.getTop()-f;a.setStyle("left",e+"px");a.setStyle("top",f+"px");a.setStyle("width",b+"px");c.floating=true;c.setEditingStatus(a,true);b=a.bindEvent;f=a.span||b.endRow-b.startRow;b.startRow=d;b.endRow=b.startRow+f;if(this.endRow-1<b.startRow)b.startRow=this.endRow-1;if(this.endRow<b.endRow)b.endRow=this.endRow;a.contentEl.setHeight(26*(b.endRow-b.startRow-1));a.titleEl.dom.innerHTML="<b>"+c.generateTitle(b)+"</b>";
a.nol=h;a.row=d},_onPortMouseMoveFn:function(a){if(0==a.button)if(this.preEl)this.movePrepareEl(this.preEl,a);else if(this.dragEventEl){this.moving=true;this.moveEventEl(this.dragEventEl,a)}else this.resizeEventEl&&this.resizingEventEl(this.resizeEventEl,a);else{this.resetResizeEventEl();this.resetDragEventEl();this.resetPrepareEl()}},initEls:function(){this.port=Ext.get(this.id+"-x-dayview-port");this.cbody=Ext.get(this.id+"-x-dayview-body");this.lefter=Ext.get(this.id+"-x-dayview-lefter");this.cheader=
Ext.get(this.id+"-x-dayview-header");this.cpool=Ext.get(this.id+"-x-dayview-pool");this.cptable=Ext.get(this.id+"-x-dayview-pool-ct");this.pviewer=Ext.get(this.id+"-x-dayview-pool-viewer");this.pswitch=Ext.get(this.id+"-x-dayview-pool-switch");this.port.un("mouseover",this._onPortMouseOverFn,this);this.port.on("mouseover",this._onPortMouseOverFn,this);this.body.un("mousedown",this._onBodyMouseDownFn,this);this.body.on("mousedown",this._onBodyMouseDownFn,this);this.body.un("click",this._onBodyClickFn,
this);this.body.on("click",this._onBodyClickFn,this);if(!this.ehandler.readOnly){this.body.un("contextmenu",this._onBodyContextMenuFn,this);this.body.un("dblclick",this._onBodyDblclickFn,this);this.body.un("mousemove",this._onBodyMouseMoveFn,this);this.port.un("mousedown",this._onPortMouseDownFn,this);this.port.un("mousemove",this._onPortMouseMoveFn,this);this.body.on("mousemove",this._onBodyMouseMoveFn,this);this.body.on("contextmenu",this._onBodyContextMenuFn,this);this.body.on("dblclick",this._onBodyDblclickFn,
this);this.port.on("mousedown",this._onPortMouseDownFn,this);this.port.on("mousemove",this._onPortMouseMoveFn,this);if(this.createByDblclick){this.port.un("dblclick",this._onPortDblclickFn,this);this.port.on("dblclick",this._onPortDblclickFn,this)}this.port.un("click",this._onPortClickFn,this);this.port.un("contextmenu",this._PortContextMenuFn,this);this.port.on("click",this._onPortClickFn,this);this.port.on("contextmenu",this._PortContextMenuFn,this);this.initMenu();1<this.dayNum&&this.initDragZone(this.body)}this.initSelectCover();
this.initDetailCt()},_PortContextMenuFn:function(a){a.preventDefault();var b=a.getTarget();b=Ext.get(b);if(b.hasClass("x-dayview-viewer-cell")){this.menu.pn=b;this.menu.showAt(a.getXY());this.ehandler.cmenu.hide()}},initMenu:function(){this.addItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-event_add",text:this.ehandler.lang.DayView["addItem.text"],handler:this.onAddFn,scope:this});this.menu=new Ext.menu.Menu({items:[this.addItem]});this.menu=Ext.menu.MenuMgr.get(this.menu)},onAddFn:function(a){if(a=
a.parentMenu.pn)if(a instanceof Ext.Element)this.addEvent2Row(a);else{this.endPos=this.startPos=a;this.ehandler.prepareLegend(null,this)}},addEvent2Row:function(a){var b=this.ehandler;b.floating=true;this.preEl=b.prepareEvent(a,this);this.preEl.base=this.preEl.bindEvent.startRow;b.showEditor(this.preEl,this,"add");b.floating=false;delete this.preEl},_onPortDblclickFn:function(a){a=a.getTarget();a=Ext.get(a);a.hasClass("x-dayview-viewer-cell")&&this.addEvent2Row(a)},initDetailCt:function(){var a=this.ehandler.detailTpl.apply({});
this.detailCt=Ext.DomHelper.append(this.body,a,true);this.detailCt.setStyle("display","none");this.detailTitle=this.detailCt.child(".x-event-detail-title-td");this.detailViewer=this.detailCt.child(".x-event-detail-viewer");this.detailFoot=this.detailCt.child(".x-event-detail-foot-text")},initDragZone:function(a){var b=new Ext.dd.StatusProxy({dropNotAllowed:"x-dd-drop-ok"});a.dragzone=new Ext.dd.DragZone(a,{cview:this,ddGroup:"x-mycalendar",proxy:b,onStartDrag:function(){this.cview.dragging=true;(function(){var c=
this.dragData.bindEvent;c=Ext.DomQuery.select("div[name=x-event-"+c.day+"-"+c.eday+"-"+c.eventId+"]",this.cview.body.dom);for(var d=0,e=c.length;d<e;d++)Ext.get(c[d]).setOpacity(0.3)}).defer(1,this)},getDragData:function(c){c=c.getTarget();var d=Ext.get(c);d.hasClass("x-calendar-event")||(d=d.parent(".x-calendar-event"));if(d){c=d.bindEvent;if(!c.locked){var e=d.dom.cloneNode(true);d=d.getWidth();e.style.width=200<d?"200px":d+"px";return{ddel:e,bindEvent:c}}}return false},getRepairXY:function(){return null},
onDrag:function(c){var d=this.dragData.bindEvent,e=this.cview;d=Ext.ux.calendar.Mask.getDayOffset(d.day,d.eday);c=e.calculatePos(c);d=e.addSpan2Pos(c,d);e.selectRange(c,d)},endDrag:function(){var c=this.dragData.bindEvent,d=Ext.apply({},c),e=this.cview,f=e.startPos,g=e.ehandler,h=Ext.ux.calendar.Mask.getDayOffset(c.day,c.eday),j=e.daySet[f.y],i=j.format("Y-m-d");if(c.day!=i){c.eday=j.add(Date.DAY,h).format("Y-m-d");c.day=i;delete e.startPos;if("string"==Ext.type(c.repeatType))g.updateEvent(c,e,f.y);
else{c.repeatType="exception";g.updateRepeatEvent(c,e,d)}}else{c=Ext.DomQuery.select("div[name=x-event-"+c.day+"-"+c.eday+"-"+c.eventId+"]",this.cview.body.dom);d=0;for(f=c.length;d<f;d++)Ext.get(c[d]).setOpacity(1)}e.dragging=false;e.resetSCover();e.fireEvent("canceldetail")}})},addSpan2Pos:function(a,b){a=Ext.apply({},a);a.y+=b;if(a.y>=this.dayNum)a.y=this.dayNum-1;return a},alignDetailCt:function(){if(this.detailing){var a=this.detailing.x,b=this.detailing.y,c=this.detailing.events;this.detailCt.setStyle("display",
"");a=Ext.get(this.id+"-x-dayview-bg-"+a+"-"+b);b=c.length*17;var d=this.port.getBottom()-a.getTop()-30,e=this.port.getRight()-a.getRight();c=[0,0];b>d?this.detailViewer.setHeight(d):this.detailViewer.setStyle("height","");if(1<this.dayNum&&e<this.detailCt.getWidth()){b="r";c[0]=-1}else b="l";d=a.getWidth();200<d?this.detailCt.setWidth(d):this.detailCt.setWidth(200);b="t"+b;this.detailCt.alignTo(a,b+"-"+b,c)}},showDetails:function(a){var b=this.ehandler.lang.DayView,c=this.ehandler,d=c.calendarLayout.getWholeList(this,
a,false,true),e=this.getIndexFromDay(a)%this.shiftDay;this.detailing={x:0,y:e,events:d};this.detailTitle.dom.innerHTML='<b><u id="'+Ext.id()+"x-dayview-day-link-0-"+e+'" class="x-dayview-header-day-link">'+a+"</u></b>";this.detailFoot.dom.innerHTML=d.length+" "+b.events;c.bindEvent2Detail(this,d,this.detailViewer);this.alignDetailCt()},_onBodyMouseDownFn:function(a){a.stopEvent();this.fireEvent("hideeditor");var b=a.getTarget();b=Ext.get(b);var c;if(b.hasClass("x-event-more"))this.showDetails(b.dom.getAttribute("name"));
else{if(this.detailing)if(b.hasClass("x-event-detail-ct")||b.parent(".x-event-detail-ct"))return;else this.fireEvent("canceldetail");if(!this.createByDblclick&&!this.ehandler.readOnly){c=b.hasClass("x-calendar-event")?b:b.parent(".x-calendar-event");if(!c)if(c=b.parent(".x-dayview-pool-viewer")){a=this.calculatePos(a);this.selectRange(a,a)}}}},calculatePos:function(a){a=a.getXY();var b=this.pviewer.getXY();a=Math.floor((a[0]-b[0])/this.cw);if(0>a)a=0;else if(a>=this.dayNum)a=this.dayNum-1;return{x:0,
y:a}},_onBodyMouseMoveFn:function(a){if(0==a.button)this.startPos&&this.selectRange(null,this.calculatePos(a));else this.resetSCover()},hideSCovers:function(){this.scover.dom.style.display="none"},selectRange:function(a,b){this.hideSCovers();if(a)this.startPos=a;this.endPos=b;if(this.startPos.y>this.endPos.y){a=this.endPos.y;b=this.startPos.y}else{b=this.endPos.y;a=this.startPos.y}var c=this.cw,d=this.pviewer.getHeight(),e=c*a,f=this.scover;f.dom.style.display="";f.setWidth(c*(b-a+1));f.setHeight(d);
f.setLeft(e+"px");f.setTop("0px")},initSelectCover:function(){var a=document.createElement("div");a.className="x-event-select-cover";a=Ext.get(a);this.pviewer.appendChild(a);this.scover=a},resizePort:function(a){var b=this.body.getHeight(),c=this.cpool.getHeight();b=b-this.cheader.getHeight()-c-1;b!=this.port.getHeight()&&this.port.setHeight(b);if(true==a){a=this.ehandler;b=a.calendarLayout;c=0;for(var d=this.dayNum;c<d;c++){var e=b.getLayout(this.daySet[c],this);if(e){e=e.reLayout();a.renderEvent(this,
e.elist,c)}}this.adjustScroller()}},handleResize:function(a,b){if(typeof a=="number"){this.cheader.setWidth(a);Ext.isIE||(a-=2);var c=a-this.scrollOffset;this.leftWidth=70+c%7;Ext.util.CSS.updateRule("."+this.id+"-x-dayview-lefter-width","width",this.leftWidth+"px");this.port.setWidth(a);a=c-this.leftWidth;this.cw=Math.round(a/this.dayNum)}typeof b=="number"&&this.resizePort(true);this.alignDetailCt();this.updateTimeline();this.fireEvent("afterresize",this,a,b)},adjustScroller:function(){if(!this.hideInactiveRow){var a=
Ext.get(this.id+"-x-dayview-viewer-"+this.activeStartRow+"-0");a=Ext.get(a.dom.parentNode);this.port.dom.scrollTop=a.getHeight()*this.activeStartRow}},checkLayout:function(a,b){var c=this.ehandler,d=this.daySet[0],e=this.daySet[this.daySet.length-1];if(c.isInDayCache(d,e)&&!b){for(var f=c.calendarLayout,g={},h={},j=0,i=this.dayNum;j<i;j++){var n=this.daySet[j].format("Y-m-d"),m=f.getLayout(n,this);h[n]=f.getWholeList(this,n);if(true!==m.visited[this.id]||a){g[j]=m;this.cleanup(j)}}f.showWeek(this,
this.cptable.dom.firstChild,0,h,true);this.resizePort();for(var l in g){m=g[l];a=m.reLayout(false,true);c.renderEvent(this,a.elist,l)}this.adjustScroller()}else{this.fireEvent("beforeremoteload");this.cleanup();c.ds.loadEvent(d,e,function(o){c.calendarLayout.updateWholeList(o.whole,"add");this.showEvents(o,b);c.pushDayCache(d,e);this.adjustScroller();this.resizePort(Ext.isIE);this.fireEvent("remoteload")},this)}this.setToday();this.updateTimeline()},showEvents:function(a,b){for(var c={},d=this.ehandler,
e=d.calendarLayout,f=0,g=this.dayNum;f<g;f++){var h=this.daySet[f].format("Y-m-d"),j=e.getLayout(h,this,a[h]||[],true,b);if(j){j=j.reLayout();d.renderEvent(this,j.elist,f);c[h]=j.wlist}}e.showWeek(this,this.cptable.dom.firstChild,0,c,true)},refreshLefter:function(){for(var a=this.numInHour,b=0;b<this.rowCount;b++)for(var c=0;c<1;c++){var d=Ext.ux.calendar.Mask.getIntervalFromRow(this.intervalSlot,b,this.hourFormat);d=0!=b%a&&b!=this.activeStartRow?'<div class="x-dayview-viewer-row-height" style="text-align:right;"><i><b class="x-dayview-lefter-inner x-dayview-lefter-fine-inner">'+
d+"</b></i></div>":'<div class="x-dayview-viewer-row-height"><b class="x-dayview-lefter-inner">'+d+"</b></div>";var e=Ext.get(this.id+"-x-dayview-lefter-"+b+"-"+c);if(e)e.dom.firstChild.innerHTML=d}},refreshDate:function(){for(var a=0;a<this.dayNum;a++){var b=Ext.get(this.id+"-x-dayview-day-link-0-"+a);if(b){var c=this.daySet[a].format(this.dayFormat);b.dom.innerHTML=c}}Ext.get(this.id+"-x-dayview-wn").dom.innerHTML=this.daySet[0].getWeekOfYear()},resetView:function(){this.refreshDate();this.setToday()},
cleanup:function(a,b){if(!b)if(false==Ext.type(a))for(b=0;b<this.rowCount;b++)for(a=0;a<this.dayNum;a++){var c=Ext.get(this.id+"-x-dayview-viewer-"+b+"-"+a);if(c)c.dom.innerHTML=""}else for(b=0;b<this.rowCount;b++)if(c=Ext.get(this.id+"-x-dayview-viewer-"+b+"-"+a))c.dom.innerHTML="";if(this.cptable)for(a=this.cptable.dom.firstChild;0<a.childNodes.length;)Ext.get(a.lastChild).remove()},getIndexFromDay:function(a){for(var b=0,c=this.daySet.length;b<c;b++)if(a==this.daySet[b].format("Y-m-d"))return b},
locateDay:function(a){a=this.getStartDate(a);this.daySet[0]=a;for(var b=1;b<this.dayNum;b++)this.daySet[b]=a.add(Date.DAY,b)},showDay:function(a){this.locateDay(a);this.resetView();this.checkLayout(true)},goBack:function(){var a=this.shiftDay||this.dayNum,b=this.dayNum,c=this.daySet[0].add(Date.DAY,-1*a),d=this.weekNum||1;this.daySet=[];for(var e=0;e<d;e++)for(var f=0;f<b;f++)this.daySet[this.daySet.length]=c.add(Date.DAY,e*a+f);this.resetView();this.checkLayout(true)},goNext:function(){var a=this.shiftDay||
this.dayNum,b=this.dayNum,c=this.daySet[0].add(Date.DAY,a),d=this.weekNum||1;this.daySet=[];for(var e=0;e<d;e++)for(var f=0;f<b;f++)this.daySet[this.daySet.length]=c.add(Date.DAY,e*a+f);this.resetView();this.checkLayout(true)},isShift:function(a,b){var c,d=a.format("Y-m-d"),e=this.daySet[0].format("Y-m-d");c=d<e?e:d;d=b.format("Y-m-d");e=this.daySet[this.daySet.length-1].format("Y-m-d");if(c>(d>e?e:d)){a=this.getStartDate(a);this.daySet=[];for(b=0;b<this.weekNum;b++)for(c=0;c<this.dayNum;c++)this.daySet[this.daySet.length]=
a.add(Date.DAY,b*this.shiftDay+c);return true}else return false},showRange:function(a,b,c){if(this.isShift(a,b)){c=true;this.resetView()}this.checkLayout(c)}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.DetailEditor=function(a){Ext.apply(this,a);this.ehandler.applyCalendarSetting(this);a=this.ehandler.lang.Editor;this.startDayField=new Ext.form.DateField({fieldLabel:a["startDayField.label"],value:new Date,format:"Y-m-d",allowBlank:false,anchor:"95%",editable:false,disabled:this.singleDay});this.startDayField.on("select",this.onStartEndDayCheckFn,this);this.startTimeField=new Ext.form.ComboBox({hideLabel:true,labelSeparator:"",store:Ext.ux.calendar.Mask.getTimeStore(),displayField:"hour",
valueField:"row",typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true,allowBlank:false,editable:false,anchor:"95%"});this.startTimeField.on("select",this.onStartTimeSelectFn,this);this.endDayField=new Ext.form.DateField({fieldLabel:a["endDayField.label"],labelSeparator:"",format:"Y-m-d",value:new Date,allowBlank:false,anchor:"95%",editable:false,disabled:this.singleDay});this.endDayField.on("select",this.onStartEndDayCheckFn,this);this.endTimeField=new Ext.form.ComboBox({hideLabel:true,
labelSeparator:"",store:Ext.ux.calendar.Mask.getTimeStore(),displayField:"hour",valueField:"row",typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true,allowBlank:false,editable:false,anchor:"95%"});this.wholeField=new Ext.form.Checkbox({hideLabel:true,labelSeparator:"",boxLabel:a["wholeField.label"]});this.wholeField.on("check",this.onWholeCheck,this);this.repeatTypeField=new Ext.form.ComboBox({fieldLabel:a["repeatTypeField.label"],store:Ext.ux.calendar.Mask.getRepeatTypeStore(),displayField:"display",
valueField:"value",typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true,allowBlank:false,editable:false,anchor:"99%"});this.subjectField=new Ext.form.TextField({fieldLabel:a["subjectField.label"],anchor:"99%"});this.contentField=new Ext.form.TextArea({fieldLabel:a["contentField.label"],height:70,anchor:"99%"});var b='<tpl for="."><div class="x-combo-list-item">'+this.ehandler.cTplStr+"</div></tpl>";this.calendarField=new Ext.form.ComboBox({fieldLabel:a["calendarField.label"],store:Ext.ux.calendar.Mask.getCalendarStore(),
displayField:"title",valueField:"id",typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true,allowBlank:false,anchor:"99%",editable:false,tpl:b});this.alertCB=new Ext.form.Checkbox({labelSeparator:"",anchor:"99%",disabled:true,boxLabel:a["alertCB.label"]});this.lockCB=new Ext.form.Checkbox({labelSeparator:"",anchor:"99%",boxLabel:a["lockCB.label"]});this.returnBtn=new Ext.Button({iconCls:"icon-sys-calendar-door_out",text:a["returnBtn.text"],handler:this.onReturnFn,scope:this});this.saveBtn=
new Ext.Button({iconCls:"icon-sys-calendar-accept",minWidth:80,text:a["saveBtn.text"],hidden:this.ehandler.readOnly,handler:this.onSaveFn,scope:this});this.cancelBtn=new Ext.Button({iconCls:"icon-sys-calendar-cancel",minWidth:80,text:a["cancelBtn.text"],handler:this.onCancelFn,scope:this});this.timepanel=new Ext.Panel({border:false,layout:"column",items:[{columnWidth:0.33,border:false,layout:"form",items:[this.startDayField]},{columnWidth:0.15,border:false,layout:"form",items:[this.startTimeField]},
{columnWidth:0.22,border:false,layout:"form",labelWidth:15,items:[this.endDayField]},{columnWidth:0.15,border:false,layout:"form",items:[this.endTimeField]},{columnWidth:0.15,border:false,items:[this.wholeField]}]});this.repeatIntervalField=new Ext.form.NumberField({fieldLabel:a["repeatIntervalField.label"],labelSeparator:"",value:1,allowBlank:false,anchor:"99%"});this.repeatIntervalField.on("valid",this.onRepeatIntervalValidFn,this);this.intervalUnitLabel=new Ext.util.LabelField({hideLabel:true,
labelSeparator:""});this.repeatStartField=new Ext.form.DateField({fieldLabel:a["repeatStartField.label"],format:"Y-m-d",allowBlank:false,anchor:"90%"});this.repeatStartField.on("select",this.onRepeatStartSelectFn,this);this.repeatNoEndRG=new Ext.form.Radio({boxLabel:a["repeatNoEndRG.label"],name:"repeat-end-type"});this.repeatEndTimeRG=new Ext.form.Radio({boxLabel:a["repeatEndTimeRG.label"],name:"repeat-end-type"});this.repeatEndTimeField=new Ext.form.NumberField({width:50,value:10,allowBlank:false,
disabled:true});this.repeatEndDateRG=new Ext.form.Radio({boxLabel:a["repeatEndDateRG.label"],name:"repeat-end-type"});this.repeatEndDateField=new Ext.form.DateField({hideLabel:true,labelSeparator:"",format:"Y-m-d",allowBlank:false,anchor:"99%",disabled:true,value:(new Date).add(Date.DAY,365)});b={check:{fn:this.refreshRepeatInfo,scope:this}};var c=[],d=new Date,e=d.format("N");d=d.add(Date.DAY,1-e);for(e=0;e<7;e++)c.push({boxLabel:d.add(Date.DAY,e).format("D"),listeners:b});this.weekCheckGroup=new Ext.form.CheckboxGroup({fieldLabel:a["weekCheckGroup.label"],
items:c,anchor:"100%"});this.monthRadioGroup=new Ext.form.RadioGroup({fieldLabel:a["monthRadioGroup.label"],items:[{boxLabel:a.repeatByDate,name:"repeat-month-group",checked:true},{boxLabel:a.repeatByDay,name:"repeat-month-group",listeners:b}],anchor:"60%"});this.generalForm=new Ext.form.FormPanel({border:false,style:"padding:10px;",frame:true,autoHeight:true,labelWidth:80,items:[this.timepanel,{border:false,layout:"column",items:[{border:false,columnWidth:0.7,layout:"form",items:[this.calendarField]},
{border:false,columnWidth:0.15,items:[this.alertCB]},{border:false,columnWidth:0.15,items:[this.lockCB]}]},this.subjectField,this.contentField]});this.repeatInfoPanel=new Ext.Panel({border:false,html:'<div class="x-repeat-event-info-ct"><div class="x-repeat-event-info"></div></div>'});b=Ext.isIE?"3.0.3"==Ext.version?[0.4,0.2,0.38,0.4,0.6]:[0.2,0.1,0.3,0.2,0.3]:[0.4,0.2,0.38,0.4,0.6];this.repeatForm=new Ext.form.FormPanel({border:false,style:"padding:10px;",frame:true,autoHeight:true,labelWidth:80,
items:[this.repeatTypeField,{border:false,style:"padding-left:85px;",layout:"column",items:[{border:false,columnWidth:0.25,layout:"form",items:[this.repeatIntervalField]},{border:false,columnWidth:0.2,items:[this.intervalUnitLabel]}]},this.repeatInfoPanel,{border:false,style:"padding-left:85px;",layout:"form",items:[this.weekCheckGroup]},{border:false,style:"padding-left:85px;",layout:"form",items:[this.monthRadioGroup]},{border:false,style:"padding-left:85px;",layout:"column",items:[{border:false,
columnWidth:0.5,layout:"form",labelWidth:75,items:[this.repeatStartField]},{border:false,columnWidth:0.5,items:[this.repeatNoEndRG,{border:false,layout:"column",items:[{border:false,columnWidth:b[0],items:[this.repeatEndTimeRG]},{border:false,columnWidth:b[1],items:[this.repeatEndTimeField]},{border:false,columnWidth:b[2],layout:"form",labelWidth:95,items:[{xtype:"textfield",fieldLabel:a.repeatEndTimeUnit,labelSeparator:"",hidden:true}]}]},{border:false,layout:"column",items:[{border:false,columnWidth:b[3],
items:[this.repeatEndDateRG]},{border:false,columnWidth:b[4],layout:"form",items:[this.repeatEndDateField]}]}]}]}]});Ext.ux.calendar.DetailEditor.superclass.constructor.call(this,{border:false,autoScroll:true,items:[{border:false,width:650,layout:"form",items:[this.generalForm,this.repeatForm]}],buttonAlign:"center",buttons:[this.returnBtn,this.saveBtn,this.cancelBtn]});this.addEvents("showdetailsetting");this.repeatTypeField.on("select",this.onRepeatTypeSelectFn,this);this.calendarField.on("select",
this.onCalendarSelectFn,this);this.repeatNoEndRG.on("check",this.onRepeatNoEndCheckFn,this);this.repeatEndTimeRG.on("check",this.onRepeatEndTimeCheckFn,this);this.repeatEndDateRG.on("check",this.onRepeatEndDateCheckFn,this)};
Ext.extend(Ext.ux.calendar.DetailEditor,Ext.ux.calendar.BasicView,{onRepeatIntervalValidFn:function(){this.refreshRepeatInfo()},onRepeatStartSelectFn:function(){this.refreshRepeatInfo()},refreshRepeatInfo:function(){var a=this.repeatStartField.getValue(),b=this.repeatIntervalField.getValue(),c=Ext.ux.calendar.Mask.getIntervalText,d=this.ehandler.lang.Editor,e=this.repeatTypeField.getValue(),f="";if("day"==e)this.updateRepeatInfo(c(e,b));else if("week"==e){for(var g=a.add(Date.DAY,1-a.format("N")),
h=this.weekCheckGroup.items,j=0,i=0,n=h.getCount();i<n;i++)if(h.get(i).checked){j++;f+=g.add(Date.DAY,i).format("l")+" "}if(7==j)f=d.repeatDayInfo;else if(0==j)f=a.format("l");this.updateRepeatInfo(c(e,b)+f)}else if("month"==e){f=this.monthRadioGroup.items.get(1).checked?Ext.ux.calendar.Mask.getWeekDayInMonth(a):a.format("d");this.updateRepeatInfo(c(e,b)+f)}else"year"==e&&this.updateRepeatInfo(c(e,b)+a.format("m-d"))},updateRepeatInfo:function(a){this.repeatInfoPanel.body.dom.firstChild.firstChild.innerHTML=
a},onRepeatTypeSelectFn:function(a){this.resetRepeatSetting(a.getValue(),this.bindEl.bindEvent)},resetRepeatSetting:function(a,b){var c=b.repeatType||"no",d=this.ehandler.lang.Editor,e=this.repeatForm.items;if("no"==a||"exception"==a){e.get(1).hide();e.get(2).hide();e.get(3).hide();e.get(4).hide();e.get(5).hide()}else{e.get(1).show();e.get(2).show();if("day"==a||"year"==a){"day"==a?this.intervalUnitLabel.setText(d["intervalUnitLabel.day.text"]):this.intervalUnitLabel.setText(d["intervalUnitLabel.year.text"]);
e.get(3).hide();e.get(4).hide()}else if("week"==a){this.intervalUnitLabel.setText(d["intervalUnitLabel.week.text"]);e.get(3).show();this.weekCheckGroup.reset();d=this.weekCheckGroup.items;d.each(function(h){h.checked=false});if("string"!=Ext.type(c)){var f=c.rday;for(var g in f)d.get(g-1).setValue(true)}e.get(4).hide()}else if("month"==a){this.intervalUnitLabel.setText(d["intervalUnitLabel.month.text"]);e.get(3).hide();e.get(4).show();this.monthRadioGroup.reset();g=this.monthRadioGroup.items;g.each(function(h){h.checked=
false});if("string"!=Ext.type(c))"day"==c.rby?g.get(1).setValue(true):g.get(0).setValue(true)}e.get(5).show();this.repeatForm.doLayout();this.repeatNoEndRG.checked=false;this.repeatEndTimeRG.checked=false;this.repeatEndDateRG.checked=false;if("string"!=Ext.type(c)){this.repeatIntervalField.setValue(c.intervalSlot);this.repeatStartField.setValue(c.beginDay);if("no"==c.endDay)false!=Ext.type(c.rtime)?this.repeatEndTimeRG.setValue(true):this.repeatNoEndRG.setValue(true);else{this.repeatEndDateRG.setValue(true);
this.repeatEndDateField.setValue(c.endDay)}}else{"day"==a?this.repeatIntervalField.setValue(Ext.ux.calendar.Mask.getDayOffset(b.day,b.eday)+1):this.repeatIntervalField.setValue(1);this.repeatStartField.setValue(b.day);this.repeatNoEndRG.setValue(true)}this.refreshRepeatInfo()}},onRepeatNoEndCheckFn:function(a,b){if(b){this.repeatEndTimeField.disable();this.repeatEndDateField.disable()}},onRepeatEndTimeCheckFn:function(a,b){if(b){this.repeatEndTimeField.enable();this.repeatEndDateField.disable()}},
onRepeatEndDateCheckFn:function(a,b){if(b){this.repeatEndTimeField.disable();this.repeatEndDateField.enable()}},onReturnFn:function(){var a=this.bview;this.ownerCt.getLayout().setActiveItem(a);a.checkLayout(true)},onStartEndDayCheckFn:function(a){var b=this.startDayField.getValue(),c=b.format("Y-m-d"),d=this.endDayField.getValue(),e=d.format("Y-m-d");if(c>=e){if(a==this.startDayField)this.endDayField.setValue(b);else a==this.endDayField&&this.startDayField.setValue(d);a=this.startTimeField.getValue();
b=this.endTimeField.getValue();this.reloadEndTimeStore(a);if(a>b){b=a+this.numInHour;if(b>=this.activeEndRow)b=this.activeEndRow-1;this.endTimeField.setValue(b)}}},reloadStartTimeStore:function(a){var b=this.startTimeField.store;b.removeAll();a=a?Ext.ux.calendar.Mask.generateIntervalData(this.intervalSlot,0,this.rowCount-1,this.ehandler.hourFormat):Ext.ux.calendar.Mask.generateIntervalData(this.intervalSlot,this.activeStartRow,this.activeEndRow-1,this.ehandler.hourFormat);b.loadData(a)},reloadEndTimeStore:function(a,
b){var c=this.endTimeField.store;c.removeAll();if(b)a=Ext.ux.calendar.Mask.generateIntervalData(this.intervalSlot,0,this.rowCount,this.ehandler.hourFormat);else{if(false==Ext.type(a))a=this.activeStartRow;else a++;a=Ext.ux.calendar.Mask.generateIntervalData(this.intervalSlot,a,this.activeEndRow,this.ehandler.hourFormat)}c.loadData(a)},onStartTimeSelectFn:function(a){a=a.getValue();var b,c=this.startDayField.getValue().format("Y-m-d"),d=this.endDayField.getValue().format("Y-m-d");if(this.bindEl){var e=
this.bindEl.bindEvent;if(c!=d)this.reloadEndTimeStore();else{b=a+(e.endRow-e.startRow);this.reloadEndTimeStore(a)}}if(false!=Ext.type(b))this.activeEndRow>=b?this.endTimeField.setValue(b):this.endTimeField.setValue(this.activeEndRow)},onCalendarSelectFn:function(a,b){if((a=this.bindEl)&&!a.hold){var c=a.bindEvent,d=a.cview,e=d.ehandler,f=e.calendarSet[b.data.id].color;b=Ext.DomQuery.select("div[name=x-event-"+c.day+"-"+c.eday+"-"+c.eventId+"]",d.body.dom);for(var g=0,h=b.length;g<h;g++){a=Ext.get(b[g]);
if(a instanceof Ext.Element)if(0==c.startRow&&this.rowCount==c.endRow)this.oldColor!=f&&e.changeWholeColor(a,this.oldColor,f);else if(this.oldColor!=f)d instanceof Ext.ux.calendar.DayView?e.changeEventColor(a,this.oldColor,f):e.changeLegendColor(a,this.oldColor,f)}}this.oldColor=f},onWholeCheck:function(){var a=this.startDayField.getValue().format("Y-m-d"),b=this.endDayField.getValue().format("Y-m-d");if(this.bindEl){var c=this.bindEl.bindEvent;if(this.wholeField.checked){a=Ext.ux.calendar.Mask.getHMFromRow;
this.reloadStartTimeStore(true);this.reloadEndTimeStore(null,true);this.startTimeField.setRawValue(a(this.intervalSlot,0,this.hourFormat));this.endTimeField.setRawValue(a(this.intervalSlot,this.rowCount,this.hourFormat));this.startTimeField.disable();this.endTimeField.disable()}else{var d,e;d=this.activeStartRow<=c.startRow?c.startRow:this.activeStartRow;e=this.activeEndRow>=c.endRow?c.endRow:this.activeEndRow-1;this.reloadStartTimeStore();this.startTimeField.setValue(d);a==b&&this.rowCount!=c.endRow?
this.reloadEndTimeStore(d):this.reloadEndTimeStore();this.endTimeField.setValue(e);this.startTimeField.enable();this.endTimeField.enable()}this.startDayField.setValue(c.day);this.endDayField.setValue(c.eday)}},onSaveFn:function(){if(this.generalForm.form.isValid()){if(this.bindEl){var a=this.bindEl,b=a.bindEvent,c=Ext.apply({},b),d=a.cview,e=d.ehandler;"add"==this.action&&!a.hold&&a.remove();if(this.wholeField.checked){b.allDay=true;b.startRow=0;b.endRow=this.rowCount}else{b.startRow=parseInt(this.startTimeField.getValue());
b.endRow=parseInt(this.endTimeField.getValue())}b.day=this.startDayField.getValue().format("Y-m-d");a=this.endDayField.getValue();if(0==b.endRow){a=a.add(Date.DAY,-1);b.endRow=this.rowCount}b.eday=a.format("Y-m-d");b.subject=this.subjectField.getValue();b.content=this.contentField.getValue();b.calendarId=this.calendarField.getValue();b.color=e.calendarSet[b.calendarId].color;b.alertFlag=this.alertCB.checked;b.locked=this.lockCB.checked;b=this.handleRepeatType(b);if("add"==this.action)"string"==Ext.type(b.repeatType)?
e.createEvent(b,d):e.createRepeatEvent(b,d);else if("update"==this.action)if("string"==Ext.type(c.repeatType)&&"string"==Ext.type(b.repeatType)){b.repeatType=c.repeatType;e.updateEvent(b,d,null,c,this.noLayout)}else if("string"==Ext.type(b.repeatType)){a=e.lang.EventHandler;Ext.Msg.show({title:a["updateRepeatPopup.title"],msg:a["updateRepeatPopup.msg"],buttons:Ext.Msg.YESNOCANCEL,fn:function(f){if("yes"==f)e.updateRepeatEvent(b,d,c);else if("no"==f){b.repeatType="exception";e.updateRepeatEvent(b,
d,c)}},icon:Ext.MessageBox.QUESTION})}else e.updateRepeatEvent(b,d,c)}d.fireEvent("canceldetail");this.onReturnFn()}},handleRepeatType:function(a){var b=Ext.apply({},a),c=this.repeatTypeField.getValue();if("no"==c)b.repeatType="no";else{a={rtype:c,intervalSlot:this.repeatIntervalField.getValue(),dspan:Ext.ux.calendar.Mask.getDayOffset(a.day,a.eday),beginDay:this.repeatStartField.getValue().format("Y-m-d")};if(this.repeatNoEndRG.checked)a.endDay="no";else if(this.repeatEndTimeRG.checked){a.endDay=
"no";a.rtime=this.repeatEndTimeField.getValue()}else if(this.repeatEndDateRG.checked)a.endDay=this.repeatEndDateField.getValue().format("Y-m-d");if("week"==c){c={};for(var d=this.weekCheckGroup.items,e=false,f=0,g=d.getCount();f<g;f++)if(d.get(f).checked){e=true;c[f+1]=true}if(!e){d=Date.parseDate(b.day,"Y-m-d").format("N");c[d]=true}a.rday=c}else if("month"==c){d=this.monthRadioGroup.items;a.rby=true==d.get(0).checked?"date":"day"}b.repeatType=a}return b},onCancelFn:function(){var a=this.bindEl;
if(a=this.bindEl){var b=a.cview,c=a.bindEvent,d=b.ehandler;if(!a.hold)if("add"==this.action)this.bindEl.remove();else{var e=d.calendarSet[c.calendarId].color;if(0==c.startRow&&this.rowCount==c.endRow)this.oldColor!=e&&d.changeWholeColor(a,this.oldColor,e);else if(this.oldColor!=e)b instanceof Ext.ux.calendar.DayView?d.changeEventColor(a,this.oldColor,e):d.changeLegendColor(a,this.oldColor,e)}this.onReturnFn()}},setup:function(a){this.noLayout=a.noLayout;this.bindEl=a.bindEl;this.action=a.action;this.bview=
a.cview;if(this.bindEl){var b=this.bindEl;a=b.cview.ehandler;b instanceof Ext.Element&&a.setEditingStatus(b,true);b=b.bindEvent;if(b.endRow==this.rowCount&&b.startRow==0)this.wholeField.setValue(true);else if(this.wholeField.getValue())this.wholeField.setValue(false);else{this.reloadStartTimeStore();b.day!=b.eday?this.reloadEndTimeStore():this.reloadEndTimeStore(b.startRow)}this.repeatStartField.setValue(b.day);this.startTimeField.setValue(b.startRow);this.endTimeField.setValue(b.endRow);this.subjectField.setValue(b.subject);
this.contentField.setValue(b.content);this.startDayField.setValue(b.day);this.endDayField.setValue(b.eday);var c="no",d=b.repeatType;if(d&&"string"!=Ext.type(d))c=d.rtype;if("exception"==c)c="no";this.repeatTypeField.setValue(c);this.resetRepeatSetting(c,b);b.alertFlag?this.alertCB.setValue(true):this.alertCB.setValue(false);b.locked?this.lockCB.setValue(true):this.lockCB.setValue(false);this.reloadCalendar(a);this.calendarField.setValue(b.calendarId);this.oldColor=a.calendarSet[b.calendarId].color}else this.wholeField.setValue(true);
this.generalForm.doLayout();this.repeatForm.doLayout()},reloadCalendar:function(a){var b=this.calendarField.store;b.removeAll();for(var c in a.calendarSet){var d=a.calendarSet[c];if(true!==d.hide){d=new b.recordType({id:d.id,title:d.name,description:d.description,color:d.color});b.add(d)}}}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.Editor=function(a){Ext.apply(this,a);this.ehandler.applyCalendarSetting(this);a=this.ehandler.lang.Editor;this.timeField=new Ext.util.LabelField({fieldLabel:a["startDayField.label"],anchor:"99%"});this.subjectField=new Ext.form.TextField({fieldLabel:a["subjectField.label"],anchor:"99%"});this.contentField=new Ext.form.TextArea({fieldLabel:a["contentField.label"],height:80,anchor:"99%"});var b='<tpl for="."><div class="x-combo-list-item">'+this.ehandler.cTplStr+"</div></tpl>";this.calendarField=
new Ext.form.ComboBox({fieldLabel:a["calendarField.label"],store:Ext.ux.calendar.Mask.getCalendarStore(),displayField:"title",valueField:"id",typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true,allowBlank:false,anchor:"99%",editable:false,tpl:b,initList:function(){Ext.form.ComboBox.prototype.initList.call(this);this.list.setZIndex(999999)}});this.alertCB=new Ext.form.Checkbox({anchor:"99%",disabled:true,boxLabel:a["alertCB.label"]});this.deleteBtn=new Ext.Button({iconCls:"icon-sys-calendar-delete",
text:a["deleteBtn.text"],disabled:true,handler:this.onRemoveFn,scope:this});this.saveBtn=new Ext.Button({iconCls:"icon-sys-calendar-accept",text:a["saveBtn.text"],handler:this.onSaveFn,scope:this});this.detailBtn=new Ext.Button({iconCls:"icon-sys-calendar-detail",text:a.detailSetting,handler:this.onDetailFn,scope:this});this.cancelBtn=new Ext.Button({iconCls:"icon-sys-calendar-cancel",minWidth:80,text:a["cancelBtn.text"],handler:this.onCancelFn,scope:this});this.formpanel=new Ext.form.FormPanel({border:false,
style:"padding:10px;",labelWidth:75,frame:true,items:[this.timeField,this.subjectField,this.contentField,{border:false,layout:"column",items:[{columnWidth:0.7,border:false,layout:"form",items:[this.calendarField]},{columnWidth:0.3,border:false,items:[this.alertCB]}]}],buttonAlign:"center",buttons:[this.detailBtn,this.deleteBtn,this.saveBtn,this.cancelBtn]});Ext.ux.calendar.Editor.superclass.constructor.call(this,{style:"left:-1000px;top:-1000px;",title:" ",width:460,height:250,baseCls:"x-tip",closable:true,
closeAction:"onCancelFn",resizable:false,frame:true,layout:"fit",floating:{shadow:true,shim:true,useDisplay:true,constrain:false},items:[this.formpanel]});this.addEvents("showdetailsetting","hided","hideeditor","showed");this.on("render",this.onRenderFn,this);this.on("showed",this.onShowFn,this);this.on("hided",this.onHideFn,this);this.on("hideeditor",this.onHideEditorFn,this);this.calendarField.on("select",this.onCalendarSelectFn,this)};
Ext.extend(Ext.ux.calendar.Editor,Ext.Panel,{initComponent:function(){Ext.ux.calendar.Editor.superclass.initComponent.call(this);if(this.closable&&!this.title)this.elements+=",header"},afterRender:function(){Ext.ux.calendar.Editor.superclass.afterRender.call(this);this.closable&&this.addTool({id:"close",handler:this[this.closeAction],scope:this})},onRenderFn:function(a){a.getEl().on("mousedown",function(){this.mdFlag=true},this);a.getEl().on("mouseup",function(b){delete this.mdFlag;b.stopPropagation()},
this)},onDetailFn:function(){this.hideEditor();this.fireEvent("showdetailsetting",this.obj)},onCalendarSelectFn:function(a,b){if((a=this.bindEl)&&!a.hold){var c=a.bindEvent,d=a.cview,e=d.ehandler,f=e.calendarSet[b.data.id].color;b=Ext.DomQuery.select("div[name=x-event-"+c.day+"-"+c.eday+"-"+c.eventId+"]",d.body.dom);for(var g=0,h=b.length;g<h;g++){a=Ext.get(b[g]);if(0==c.startRow&&this.rowCount==c.endRow)this.oldColor!=f&&e.changeWholeColor(a,this.oldColor,f);else if(this.oldColor!=f)d instanceof
Ext.ux.calendar.DayView?e.changeEventColor(a,this.oldColor,f):e.changeLegendColor(a,this.oldColor,f)}}this.oldColor=f},onRemoveFn:function(){var a=this.bindEl,b=a.bindEvent,c=a.cview,d=c.ehandler,e=a.col,f=d.lang.EventHandler;if(a)if("string"==Ext.type(b.repeatType)){d.freeEventEl(a);d.deleteEvent(b,c,e)}else Ext.Msg.show({title:f["deleteRepeatPopup.title"],msg:f["deleteRepeatPopup.msg"],buttons:Ext.Msg.YESNOCANCEL,fn:function(g){if("yes"==g){d.freeEventEl(a);d.deleteRepeatEvent(b,c)}else if("no"==
g){d.freeEventEl(a);d.deleteRepeatEvent(b,c,true)}},icon:Ext.MessageBox.QUESTION});c.fireEvent("canceldetail");this.hideEditor()},onSaveFn:function(){if(this.formpanel.form.isValid()){var a=this.ehandler,b=this.cview;if(this.bindEl){var c=this.bindEl,d=c.bindEvent,e=Ext.apply({},d);"add"==this.action&&!c.hold&&c.remove();d.repeatType=d.repeatType||"no";d.allDay=false;d.alertFlag=this.alertCB.checked;if(!d.locked)d.locked=false;d.subject=this.subjectField.getValue();d.content=this.contentField.getValue();
d.calendarId=this.calendarField.getValue();d.color=a.calendarSet[d.calendarId].color;if("add"==this.action)"string"==Ext.type(d.repeatType)?a.createEvent(d,b):a.createRepeatEvent(d,b);else if("update"==this.action)if("string"==Ext.type(e.repeatType)&&"string"==Ext.type(d.repeatType))a.updateEvent(d,b,null,e,this.noLayout);else if("string"==Ext.type(d.repeatType)){c=a.lang.EventHandler;Ext.Msg.show({title:c["updateRepeatPopup.title"],msg:c["updateRepeatPopup.msg"],buttons:Ext.Msg.YESNOCANCEL,fn:function(f){if("yes"==
f)a.updateRepeatEvent(d,b,e);else if("no"==f){d.repeatType="exception";a.updateRepeatEvent(d,b,e)}},icon:Ext.MessageBox.QUESTION})}else a.updateRepeatEvent(d,b,e)}b.fireEvent("canceldetail");this.hideEditor()}},onCancelFn:function(){var a=this.bindEl;if(a){var b=this.cview,c=a.bindEvent,d=this.ehandler;if(!a.hold)if("add"==this.action)a.remove();else{var e=d.calendarSet[c.calendarId].color;if(0==c.startRow&&this.rowCount==c.endRow)this.oldColor!=e&&d.changeWholeColor(a,this.oldColor,e);else if(this.oldColor!=
e)b instanceof Ext.ux.calendar.DayView?d.changeEventColor(a,this.oldColor,e):d.changeLegendColor(a,this.oldColor,e)}this.hideEditor()}},popup:function(a){var b=this.ehandler;b.floating=true;this.obj=a;this.noLayout=a.noLayout;this.bindEl=a.bindEl;this.cview=a.cview;this.action=a.action;a=b.lang.Editor;if("add"==this.action){this.deleteBtn.disable();this.setIconClass("x-event-editor-title-add");this.setTitle(a["new.title"])}else{this.deleteBtn.enable();this.setTitle(a["edit.title"]);this.setIconClass("x-event-editor-title-edit")}this.showAt(this.adjustXY(this.bindEl))},
adjustXY:function(a){var b=a.getXY(),c=a.cview;a=[0,0];var d=this.width,e=this.height,f=b[0]+d;a[0]=b[0];var g=c.body.getRight();if(f>g)a[0]=g-d;a[1]=b[1]-e;c=c.body.getTop();if(a[1]<c)a[1]=b[1]>c?b[1]+20:c+20;return a},reloadCalendar:function(a){var b=this.calendarField.store;b.removeAll();for(var c in a.calendarSet){var d=a.calendarSet[c];if(true!==d.hide){d=new b.recordType({id:d.id,title:d.name,description:d.description,color:d.color});b.add(d)}}},onShowFn:function(){var a=this.ehandler;if(this.bindEl){var b=
this.bindEl;b.hold||a.setEditingStatus(b,true);b=b.bindEvent;this.timeField.setText("<b>"+a.generateInfo(b)+"</b>");this.subjectField.setValue(b.subject);this.contentField.setValue(b.content);b.alertFlag?this.alertCB.setValue(true):this.alertCB.setValue(false);this.reloadCalendar(a);this.calendarField.setValue(b.calendarId);this.oldColor=a.calendarSet[b.calendarId].color}},onHideFn:function(){this.ehandler.floating=false;var a=this.cview;this.bindEl&&a.resetSCover();delete this.bindEl;delete this.cview;
delete this.noLayout;delete this.action},hideEditor:function(){if(!this.hided){this.hided=true;this.showAt([-1000,-1000],true);this.fireEvent("hided")}},showAt:function(a,b){if(!b){this.fireEvent("showed");delete this.hided}this.setPagePosition(a[0],a[1])},onHideEditorFn:function(){this.mdFlag||this.onCancelFn()}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.EventHandler=function(a){Ext.apply(this,a);this.applyCalendarSetting(this);this.calendarSet={};this.dayCache={};this.id=Ext.id();Ext.ux.calendar.EventHandler.superclass.constructor.call(this);this.calendarLayout=new Ext.ux.calendar.CalendarLayout({ehandler:this});if(a=this.ds.initialObj){for(var b=0,c=a.owned.length;b<c;b++){var d=a.owned[b];this.calendarSet[d.id]=d}b=0;for(c=a.shared.length;b<c;b++){d=a.shared[b];this.calendarSet[d.id]=d}this.calendarLayout.repeatSet=a.re}this.detailTpl=
new Ext.XTemplate('<div class="x-event-detail-ct"><div class="x-event-detail-title"><table width="100%" border="0"><tbody><tr><td class="x-event-detail-title-td">{title}</td><td class="x-event-detail-tool"><img class="x-event-detail-tool-close" src="'+Ext.BLANK_IMAGE_URL+'"></img></td></tr></tbody></table></div><div class="x-event-detail-viewer"></div><div class="x-event-detail-foot"><table width="100%" border="0"><tbody><tr><td class="x-event-detail-foot-tool"><img class="x-event-detail-foot-info" src="'+
Ext.BLANK_IMAGE_URL+'"></img></td><td><b class="x-event-detail-foot-text"></b></td></tr></tbody></table></div></div>');this.eventTpl=new Ext.XTemplate('<div eid="{id}" name="x-event-{day}-{eday}-{id}" class="'+this.id+"-x-calendar-{calendarId}-event x-event-cover "+this.id+'-x-calendar-{calendarId} x-calendar-event" style="{cover-style}" unselectable="on" onselectstart="return false;"><div style="height:18px;"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td style="{left-style}"><div class="x-calendar-{color}-event-ltcorner-clear  x-event-lt-default">&nbsp;</div></td><td><div class="x-calendar-{color}-event-top-clear x-event-inner x-event-title-default" style="{title-style}"><b qtip="{time}<br><b><u>{subject}</u></b><br>{content}">{title}</b></div></td><td style="{right-style}"><div class="x-calendar-{color}-event-rtcorner-clear  x-event-rt-default">&nbsp;</div></td></tr></tbody></table></div><div class="x-calendar-{color}-event-lr x-event-content-default" style="{content-style}"><img class="x-calendar-event-pin-off x-event-pin" src="'+
Ext.BLANK_IMAGE_URL+'"></img><tpl if="this.isRepeat(repeatType)"><img class="x-repeat-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isException(repeatType)"><img class="x-exception-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isAlert(alertFlag)"><img class="x-alert-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isLocked(locked)"><img class="x-locked-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><u class="x-event-content-link" qtip="{time}<br><b><u>{subject}</u></b><br>{content}">{subject}</u><br>{content}</div><div><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td style="{left-style}"><div class="x-calendar-{color}-event-lbcorner">&nbsp;</div></td><td><div style="{bottom-style}" class="x-calendar-{color}-event-bottom x-event-bottom-default">&nbsp;</div></td><td style="{right-style}"><div class="x-calendar-{color}-event-rbcorner">&nbsp;</div></td></tr></tbody></table></div></div>',
{isRepeat:function(e){return"string"!=Ext.type(e)},isException:function(e){return"exception"==e},isAlert:function(e){return e},isLocked:function(e){return e}});this.eventTpl.compile();this.legendTpl=new Ext.XTemplate('<div eid="{id}" name="x-event-{day}-{eday}-{id}" class="'+this.id+"-x-calendar-{calendarId}-legend x-legend-cover "+this.id+'-x-calendar-{calendarId} x-calendar-event" unselectable="on" onselectstart="return false;"><b class="x-legend-title-b x-legend-title-{color}" qtip="{time}<br><b><u>{subject}</u></b><br>{content}"><tpl if="this.isRepeat(repeatType)"><img class="x-repeat-event" src="'+
Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isException(repeatType)"><img class="x-exception-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isAlert(alertFlag)"><img class="x-alert-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isLocked(locked)"><img class="x-locked-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl>{title} {subject}</b></div>',{isRepeat:function(e){return"string"!=Ext.type(e)},isException:function(e){return"exception"==e},isAlert:function(e){return e},
isLocked:function(e){return e}});this.legendTpl.compile();this.wholeTpl=new Ext.XTemplate('<div eid="{id}" name="x-event-{day}-{eday}-{id}" class="'+this.id+"-x-calendar-{calendarId}-whole x-whole-cover "+this.id+'-x-calendar-{calendarId} x-calendar-event" unselectable="on" onselectstart="return false;"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="x-whole-td"><div class="x-calendar-{color}-whole-left x-whole-left">&nbsp;</div><tpl if="this.isLeftJoin(lflag)"><div class="x-whole-left-join"></div></tpl></td><td class="x-whole-title-{color} x-whole-title">&nbsp;<b class="x-whole-title-b" qtip="{time}<br><b><u>{subject}</u></b><br>{content}"><tpl if="this.isRepeat(repeatType)"><img class="x-repeat-white-event" src="'+
Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isException(repeatType)"><img class="x-exception-white-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isAlert(alertFlag)"><img class="x-alert-white-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isLocked(locked)"><img class="x-locked-white-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl>{subject}</b></td><td class="x-whole-td"><div class="x-calendar-{color}-whole-right x-whole-right">&nbsp;</div><tpl if="this.isRightJoin(rflag)"><div class="x-whole-right-join"></div></tpl></td></tr></tbody></table></div>',
{isLeftJoin:function(e){return e},isRightJoin:function(e){return e},isRepeat:function(e){return"string"!=Ext.type(e)},isException:function(e){return"exception"==e},isAlert:function(e){return e},isLocked:function(e){return e}});this.wholeTpl.compile();this.cTplStr='<div id="'+this.id+'-x-calendar-{calendarId}" class="'+this.id+'-x-calendar-{calendarId}-whole x-calendar-cover" unselectable="on" onselectstart="return false;"><div class="x-calendar-title-b" style="width:135px;"><b>{title}</b></div><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="x-calendar-td"><div class="x-calendar-{color}-whole-left x-whole-left">&nbsp;</div></td><td class="x-whole-title-{color} x-calendar-title">&nbsp;</td><td class="x-calendar-td"><div class="x-calendar-{color}-whole-right x-whole-right">&nbsp;</div></td></tr></tbody></table></div>';
this.calendarDropTpl=new Ext.XTemplate('<div class="x-calendardrop-cover" hidefocus="true" unselectable="on" onselectstart="return false;"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td>'+this.cTplStr+'</td><td class="x-legend-tool-td"><div class="x-legend-tool"></div></td></tr></tbody></table><div>');this.calendarDropTpl.compile();this.calendarTpl=new Ext.XTemplate(this.cTplStr);this.calendarTpl.compile();this.initMenu();this.initContextMenu();this.addEvents("calendarloaded",
"reloadCalendar","createEvent","updateEvent","deleteEvent","changeDay","deleteCalendar","clearCalendar","changeEventCache","changeCalendarColor");this.on("reloadCalendar",this.reloadCalendar,this);this.on("changeCalendarColor",this.onChangeCalendarColorFn,this);this.on("changeEventCache",this.onChangeEventCacheFn,this)};
Ext.extend(Ext.ux.calendar.EventHandler,Ext.util.Observable,{ss:[],hourFormat:"",baseIndex:100,widthRatio:0.95,posRatio:1.05,applyCalendarSetting:function(a){var b=Ext.apply({},this.calendarSetting);delete b.dayFormat;delete b.weekFormat;delete b.monthFormat;Ext.apply(a,b)},onChangeCalendarColorFn:function(){},onChangeEventCacheFn:function(){},showMenu:function(a,b){if(this.menu){this.menu.calendarEl=a;var c=this.lang.EventHandler;if(true===this.calendarSet[a.calendar.id].hide){this.viewItem.setText(c["viewItem.show.text"]);
this.viewItem.setIconClass("icon-sys-calendar-calendar_show")}else{this.viewItem.setText(c["viewItem.hide.text"]);this.viewItem.setIconClass("icon-sys-calendar-calendar_hide")}a=0;for(var d in this.calendarSet)a++;1>=a?this.deleteItem.hide():this.deleteItem.show();if(this.readOnly){d=2;for(a=this.menu.items.getCount();d<a;d++)this.menu.items.get(d).hide()}this.menu.bindEl=b;this.menu.show(b,this.menuAlign)}return this},onMenuShowFn:function(a){var b=a.calendarEl.calendar;if(b.id==0){a.items.get(2).disable();
a.items.get(3).disable()}else{a.items.get(2).enable();a.items.get(3).enable()}if(b=Ext.ux.calendar.Mask.getColorByIndex(b.color)){a.palette.still=true;a.palette.select("#"+b);delete a.palette.still}},hideMenu:function(){this.menu&&this.menu.hide();return this},showContextMenu:function(a,b){a.stopEvent();if(this.cmenu){this.cmenu.eventEl=b;if(b.bindEvent.locked){this.editItem.hide();this.lockItem.hide();this.unlockItem.show()}else{this.editItem.show();this.lockItem.show();this.unlockItem.hide()}this.cmenu.showAt(a.getXY())}},
hideContextMenu:function(){this.cmenu&&this.cmenu.hide();return this},initMenu:function(){var a=this.lang.EventHandler;this.showOnlyItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-calendar_show",text:a["showOnlyItem.text"],handler:this.onShowOnlyFn,scope:this});this.viewItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-calendar_hide",text:a["viewItem.hide.text"],handler:this.onViewFn,scope:this});this.editItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-calendar_edit",text:a["editItem.text"],
handler:this.onEditFn,scope:this});this.deleteItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-delete",text:a["deleteItem.text"],handler:this.onDeleteFn,scope:this});this.clearItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-clear_event",text:a["clearItem.text"],handler:this.onClearFn,scope:this});a=new Ext.ColorPalette({});this.menu=new Ext.menu.Menu({cls:"x-calendar-menu",items:[this.showOnlyItem,this.viewItem,this.editItem,this.deleteItem,this.clearItem,"-",a]});this.menu.palette=a;this.menu=
Ext.menu.MenuMgr.get(this.menu);this.menu.palette.colors=Ext.ux.calendar.Mask.colors;this.menu.palette.on("select",this.onCalendarColorChangedFn,this);this.menu.on("show",this.onMenuShowFn,this)},initContextMenu:function(){var a=this.lang.EventHandler;this.lockItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-event_lock",text:a["lockItem.text"],handler:this.onLockEventFn,scope:this});this.unlockItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-event_unlock",text:a["unlockItem.text"],handler:this.onUnlockEventFn,
scope:this});this.editItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-event_edit",text:a["editEvent.title"],handler:this.onEditEventFn,scope:this});this.deleteItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-delete",text:a["deleteEvent.title"],handler:this.onDeleteEventFn,scope:this});this.cmenu=new Ext.menu.Menu({items:[this.lockItem,this.unlockItem,this.editItem,this.deleteItem]});this.cmenu=Ext.menu.MenuMgr.get(this.cmenu)},onLockEventFn:function(a){a=a.parentMenu.eventEl;var b=a.cview,c=
b.ehandler,d=a.bindEvent,e=Ext.apply({},d);d.locked=true;if("string"==Ext.type(d.repeatType))c.updateEvent(d,b);else{a=c.lang.EventHandler;Ext.Msg.show({title:a["updateRepeatPopup.title"],msg:a["updateRepeatPopup.msg"],buttons:Ext.Msg.YESNOCANCEL,fn:function(f){if("yes"==f)c.updateRepeatEvent(d,b,e);else if("no"==f){d.repeatType="exception";c.updateRepeatEvent(d,b,e)}else d.locked=false},icon:Ext.MessageBox.QUESTION})}},onUnlockEventFn:function(a){a=a.parentMenu.eventEl;var b=a.cview,c=b.ehandler,
d=a.bindEvent,e=Ext.apply({},d);d.locked=false;if("string"==Ext.type(d.repeatType))c.updateEvent(d,b);else{a=c.lang.EventHandler;Ext.Msg.show({title:a["updateRepeatPopup.title"],msg:a["updateRepeatPopup.msg"],buttons:Ext.Msg.YESNOCANCEL,fn:function(f){if("yes"==f)c.updateRepeatEvent(d,b,e);else if("no"==f){d.repeatType="exception";c.updateRepeatEvent(d,b,e)}else d.locked=true},icon:Ext.MessageBox.QUESTION})}},onEditEventFn:function(a){a=a.parentMenu.eventEl;var b=a.cview;b.ehandler.showEditor(a,b,
"update")},onDeleteEventFn:function(a){var b=a.parentMenu.eventEl,c=b.cview,d=c.ehandler,e=b.bindEvent;a=d.lang.EventHandler;if("string"==Ext.type(e.repeatType)){d.freeEventEl(b);d.deleteEvent(e,c,b.col)}else Ext.Msg.show({title:a["deleteRepeatPopup.title"],msg:a["deleteRepeatPopup.msg"],buttons:Ext.Msg.YESNOCANCEL,fn:function(f){if("yes"==f){d.freeEventEl(b);d.deleteRepeatEvent(e,c)}else if("no"==f){d.freeEventEl(b);d.deleteRepeatEvent(e,c,true)}},icon:Ext.MessageBox.QUESTION})},onClearFn:function(a){var b=
this.lang.EventHandler;Ext.Msg.confirm(b["clearCalendar.title"],b["clearCalendar.msg"],function(c){if(c=="yes"){var d=a.parentMenu.calendarEl.calendar,e=d.id;this.ds.deleteEventsByCalendar(e,function(){delete this.calendarSet[e];var f=this.mainPanel.calendarContainer.currentView;this.calendarLayout.resetLayout({hideCalendar:false,deleteCalendar:true},true);f.checkLayout();this.fireEvent("changeEventCache",this);this.calendarSet[e]=d},this)}},this)},onDeleteFn:function(a){var b=this.lang.EventHandler;
Ext.Msg.confirm(b["deleteCalendar.title"],b["deleteCalendar.msg"],function(c){if(c=="yes"){var d=a.parentMenu.calendarEl,e=d.calendar.id;this.ds.deleteCalendar(e,function(){delete this.calendarSet[e];var f=this.mainPanel.calendarContainer.currentView;this.calendarLayout.resetLayout({hideCalendar:false,deleteCalendar:true},true);f.checkLayout();this.fireEvent("changeEventCache",this);d.remove()},this)}},this)},copyCalendarSet:function(){var a={},b=this.calendarSet;for(var c in b)a[c]=Ext.apply({},
b[c]);return a},onShowAllFn:function(){var a=this.mainPanel.calendarContainer.getLayout().activeItem;this.ds.showAllCalendar(function(){var b=this.calendarSet;for(var c in b){var d=b[c];d.hide=false;this.showCalendarColor(Ext.get(this.id+"-x-calendar-"+c),d.color)}this.calendarLayout.resetLayout({hideCalendar:true,deleteCalendar:false},true);a.checkLayout()},this)},onShowOnlyFn:function(a){var b=this.mainPanel.calendarContainer.getLayout().activeItem,c=a.parentMenu.calendarEl,d=c.calendar,e=d.id;
d.hide=false;this.ds.showOnlyCalendar(e,function(){this.showCalendarColor(c,d.color);var f=this.calendarSet;for(var g in f)if(g!=e){var h=f[g];h.hide=true;this.hideCalendarColor(Ext.get(this.id+"-x-calendar-"+g),h.color)}this.calendarLayout.resetLayout({hideCalendar:true,deleteCalendar:false},true);b.checkLayout()},this)},onViewFn:function(a){var b=a.parentMenu.calendarEl,c=b.calendar,d=this.lang.EventHandler;c.hide=!c.hide;this.ds.createUpdateCalendar(c,function(){if(d["viewItem.hide.text"]==a.text){a.setText(d["viewItem.show.text"]);
this.hideCalendar(c,true);this.hideCalendarColor(b,c.color)}else{a.setText(d["viewItem.hide.text"]);this.hideCalendar(c,false);this.showCalendarColor(b,c.color)}},this)},hideCalendar:function(a,b){var c=a.id,d=this.mainPanel.calendarContainer.currentView;a.hide=b;this.calendarSet[c].hide=b;this.calendarLayout.resetLayout({hideCalendar:true,deleteCalendar:false},true);d.checkLayout()},onEditFn:function(a){a=a.parentMenu.calendarEl;this.ceditor.popup({data:a.calendar,cEl:a})},prepareLegend:function(a,
b,c,d){var e=d.ehandler;b=b.x*d.shiftDay+b.y;c=c.x*d.shiftDay+c.y;var f=b;if(b>c){b=c;c=f}var g;for(var h in e.calendarSet){g=e.calendarSet[h];if(true!==g.hide)break}e={eventId:"prepare",calendarId:g.id,color:g.color,startRow:0,endRow:this.rowCount,day:d.daySet[b].format("Y-m-d"),eday:d.daySet[c].format("Y-m-d"),repeatType:"no"};a.hold=true;a.cview=d;a.bindEvent=e;this.showEditor(a,d,"add")},prepareEvent:function(a,b){var c=b.getCellIndex(a.dom.id);a=b.ehandler;var d=c.x;c=c.y;var e;for(var f in a.calendarSet){e=
a.calendarSet[f];if(true!==e.hide)break}e={eventId:"prepare",calendarId:e.id,color:e.color,startRow:d,endRow:d+this.numInHour,day:b.daySet[c].format("Y-m-d"),eday:b.daySet[c].format("Y-m-d"),span:1,colIndex:0,repeatType:"no"};return this.renderEvent(b,[e],c,true)},generateInfo:function(a){var b=a.startRow,c=a.endRow;if(0==b&&this.rowCount==c){b=a.day;if(a.day!=a.eday)b+=" to "+a.eday;b+=" "+this.lang.EventHandler.wholeDay}else{b=a.day+" "+Ext.ux.calendar.Mask.getIntervalFromRow(this.intervalSlot,
b,this.hourFormat)+" to ";if(a.day!=a.eday)b+=a.eday+" ";b+=Ext.ux.calendar.Mask.getIntervalFromRow(this.intervalSlot,c,this.hourFormat)}return b},generateTitle:function(a){var b=a.startRow;a=a.endRow;return 0==b&&this.rowCount==a?this.lang.EventHandler.wholeDay:Ext.ux.calendar.Mask.getIntervalFromRow(this.intervalSlot,b,this.hourFormat)+"-"+Ext.ux.calendar.Mask.getIntervalFromRow(this.intervalSlot,a,this.hourFormat)},getContentEl:function(a){return a.child(".x-event-content-default")},getTitleEl:function(a){return a.child(".x-event-title-default")},
getBottomEl:function(a){return a.child(".x-event-bottom-default")},getLeftTopEl:function(a){return a.child(".x-event-lt-default")},getRightTopEl:function(a){return a.child(".x-event-rt-default")},renderEvent:function(a,b,c,d){for(var e=a.cbody.getLeft(),f=a.cbody.getTop(),g,h=0,j=b.length;h<j;h++){var i=b[h];i=Ext.DomQuery.select("div[eid="+i.eventId+"]",a.body.dom);for(var n=0,m=i.length;n<m;n++){var l=Ext.get(i[n]);if(l.col==c||l.nol==c){if(this.editingId==l.dom.id){delete this.editingId;this.editDisabled=
false}this.freeEventEl(l)}}}h=0;for(j=b.length;h<j;h++){i=b[h];n=Ext.get(a.id+"-x-dayview-viewer-"+i.startRow+"-"+c);m=n.getLeft();g=n.getWidth();var o=Math.round(g*a.offsetPercent),k=g-o;if(d)k=g;var p=n.getTop();g=(n.getHeight()+1)*(i.endRow-i.startRow)-24;l=k/Math.pow(i.span,this.posRatio)*i.colIndex;k=k-l;o=Math.round(m-e+o+l);if(d)o=Math.round(m-e+l);m=Math.round(p-f);l=true==i.last&&0!=i.colIndex?1:Math.pow(this.widthRatio,i.span-1-i.colIndex);p=Math.floor(k*l);l=p-5-5;m="top:"+m+"px;left:"+
o+"px;width:"+p+"px;z-index:"+(this.baseIndex+i.colIndex)+";";g="height:"+g+"px;";if(Ext.isIE)g+="width:"+p+"px;";o="width:"+l+"px;";l="width:"+l+"px;";p=i.subject||"";if(""===p.trim())p=this.lang.EventHandler.untitled;k=i.color;if(this.calendarSet)k=this.calendarSet[i.calendarId].color;g=this.eventTpl.apply({id:i.eventId,calendarId:i.calendarId,color:k,"cover-style":m,"content-style":g,"title-style":o,"bottom-style":l,"left-style":"width:5px;","right-style":"width:5px;",title:this.generateTitle(i),
time:this.generateInfo(i),subject:p,content:i.content||"",day:i.day,eday:i.eday,repeatType:i.repeatType,alertFlag:i.alertFlag,locked:i.locked});g=Ext.DomHelper.insertHtml("beforeEnd",n.dom,g);if(g=Ext.get(g)){m=this.getContentEl(g);l=this.getTitleEl(g);o=this.getBottomEl(g);p=this.getLeftTopEl(g);k=this.getRightTopEl(g);i.eId=g.id;g.bindEvent=Ext.apply({},i);g.cview=a;g.col=c;g.cEl=n;g.titleEl=l;g.contentEl=m;g.bottomEl=o;g.ltEl=p;g.rtEl=k;g.leftStyle=5;g.rightStyle=5;m.coverEl=g;m.bindEvent=Ext.apply({},
i);m.cview=a;m.cEl=n;m.col=c}}a.resizePort();this.floating=false;return g},getIndexFromDay:function(a,b){return a.getIndexFromDay(b)},createEvent:function(a,b,c){this.ds.createEvent(a,function(d){a.eventId=d.id;this.createEventToLayout(a,b,c);this.fireEvent("changeEventCache",this)},this)},createEventToLayout:function(a,b,c){if(false===Ext.type(c))c=this.getIndexFromDay(b,a.day);var d=this.calendarLayout;if(0==a.startRow&&this.rowCount==a.endRow||a.day!=a.eday){d.updateWholeList([a],"add");b.checkLayout(Ext.isIE)}else if(d=
d.getLayout(a.day,b)){a=d.updateLayout(a,"add");b instanceof Ext.ux.calendar.DayView?this.renderEvent(b,a.elist,c):b.checkLayout()}},createRepeatEvent:function(a,b){this.ds.createUpdateRepeatEvent(a,null,function(c){a.eventId=c.id;this.calendarLayout.updateRepeatEventList(b,[a],"add");this.fireEvent("changeEventCache",this)},this)},updateEvent:function(a,b,c,d,e){this.ds.updateEvent(a,function(){"function"===Ext.type(e)&&e(a);var f=0==a.startRow&&this.rowCount==a.endRow||a.day!=a.eday,g=false,h,j=
this.calendarLayout;if(d){if(false===Ext.type(c))c=this.getIndexFromDay(b,d.day);g=0==d.startRow&&this.rowCount==d.endRow||d.day!=d.eday;var i=this.calendarLayout.getLayout(d.day,b);if(d.day!=a.day){h=this.getIndexFromDay(b,a.day);i=i.updateLayout(d,"delete");if(i.elist&&b instanceof Ext.ux.calendar.DayView){for(var n=Ext.DomQueryselect("div[name=x-event-"+d.day+"-"+d.eday+"-"+d.eventId+"]",b.body.dom),m=0,l=n.length;m<l;m++)this.freeEventEl(Ext.get(n[m]));this.renderEvent(b,i.elist,c)}}else{h=c;
if(g!=f){i=i.updateLayout(d,"delete");if(i.elist&&b instanceof Ext.ux.calendar.DayView){n=Ext.DomQuery.select("div[name=x-event-"+d.day+"-"+d.eday+"-"+d.eventId+"]",b.body.dom);m=0;for(l=n.length;m<l;m++)this.freeEventEl(Ext.get(n[m]));this.renderEvent(b,i.elist,c)}}}}else h=false==Ext.type(c)?this.getIndexFromDay(b,a.day):c;if(f)j.updateWholeList([a],"update");else if(j=j.getLayout(a.day,b)){i=j.updateLayout(a,"update");false!=Ext.type(h)&&i.elist&&b instanceof Ext.ux.calendar.DayView&&this.renderEvent(b,
i.elist,h)}if((g||f)&&b instanceof Ext.ux.calendar.DayView)b.checkLayout(Ext.isIE);b instanceof Ext.ux.calendar.MonthView&&b.checkLayout(true);this.fireEvent("changeEventCache",this)},this)},deleteEvent:function(a,b,c){this.ds.deleteEvent(a,function(){this.deleteEventFromLayout(a,b,c);if(Ext.isIE&&(a.day!=a.eday||0==a.startRow&&this.rowCount==a.endRow))b.checkLayout(true);this.fireEvent("changeEventCache",this)},this)},deleteEventFromLayout:function(a,b,c){var d=this.calendarLayout;if(0==a.startRow&&
this.rowCount==a.endRow||a.day!=a.eday){d.updateWholeList([a],"delete");b.checkLayout()}else if(d=d.getLayout(a.day,b)){a=d.updateLayout(a,"delete");false!=Ext.type(c)&&b instanceof Ext.ux.calendar.DayView&&this.renderEvent(b,a.elist,c)}},deleteRepeatEvent:function(a,b,c){if(c){var d=a.repeatType.exceptions||{};d[a.day]=true;a.repeatType.exceptions=d}this.ds.deleteRepeatEvent(a,c,function(){var e=this.calendarLayout;c?e.updateRepeatEventList(b,[a],"update"):e.updateRepeatEventList(b,[a],"delete");
this.fireEvent("changeEventCache",this)},this)},showEditor:function(a,b,c,d){this.editor.popup({bindEl:a,cview:b,action:c,noLayout:d})},setPinOn:function(a){a=a.child("img");a.removeClass("x-calendar-event-pin-off");a.addClass("x-calendar-event-pin-on")},setPinOff:function(a){a=a.child("img");a.removeClass("x-calendar-event-pin-on");a.addClass("x-calendar-event-pin-off")},onPinElClickFn:function(a){a.stopEvent();a=a.getTarget();a=Ext.get(a);if(a.hasClass("x-calendar-event-pin-off")){a.removeClass("x-calendar-event-pin-off");
a.addClass("x-calendar-event-pin-on");this.editDisabled=true}else{a.removeClass("x-calendar-event-pin-on");a.addClass("x-calendar-event-pin-off");this.editDisabled=false}},setEditingStatus:function(a,b,c){var d=null;if(a.hasClass("x-event-cover"))d="event";var e=Ext.get(this.editingId),f=a.bindEvent,g=a.titleEl,h=a.contentEl,j=a.bottomEl,i=false;if(true!=this.floating)if(true!==this.editDisabled)i=true;else if(true===b){i=true;if(this.editingId!=a.dom.id)this.editDisabled=false;e&&this.setPinOff(e)}if(i){e&&
this.removeEditingStatus(e);this.editingId=a.dom.id;a.setStyle("z-index",3009);d&&a.addClass("x-event-editing");b=this.calendarSet[f.calendarId].color;if(a.hasClass("x-event-cover")){if(g){g.addClass("x-calendar-"+b+"-event-top");g.removeClass("x-calendar-"+b+"-event-top-clear")}if(e=a.ltEl){e.addClass("x-calendar-"+b+"-event-ltcorner");e.removeClass("x-calendar-"+b+"-event-ltcorner-clear")}if(e=a.rtEl){e.addClass("x-calendar-"+b+"-event-rtcorner");e.removeClass("x-calendar-"+b+"-event-rtcorner-clear")}}}e=
b=a.getWidth();if(a.leftStyle&&a.rightStyle)e=b-a.leftStyle-a.rightStyle;g&&d&&g.setWidth(e);Ext.isIE&&h&&d&&h.setWidth(b);j&&j.setWidth(e);if(false!==Ext.type(c))this.editDisabled=c;this.editDisabled&&this.setPinOn(a)},removeEditingStatus:function(a){var b=a.bindEvent,c=this.baseIndex;if(b.colIndex)c+=b.colIndex;a.setStyle("z-index",c.toString());a.removeClass("x-event-editing");c=this.calendarSet[b.calendarId].color;var d=a.titleEl;if(d){d.removeClass("x-calendar-"+c+"-event-top");a.cview instanceof
Ext.ux.calendar.DayView&&!(0==b.startRow&&this.rowCount==b.endRow)&&d.addClass("x-calendar-"+c+"-event-top-clear")}if(b=a.ltEl){b.removeClass("x-calendar-"+c+"-event-ltcorner");b.addClass("x-calendar-"+c+"-event-ltcorner-clear")}if(a=a.rtEl){a.removeClass("x-calendar-"+c+"-event-rtcorner");a.addClass("x-calendar-"+c+"-event-rtcorner-clear")}},generateLegend:function(a,b){a=b.subject||"";if(""===a.trim())a=this.lang.EventHandler.untitled;var c=b.color;if(this.calendarSet)c=this.calendarSet[b.calendarId].color;
return 0==b.startRow&&this.rowCount==b.endRow||b.day!=b.eday?this.wholeTpl.apply({id:b.eventId,lflag:b.lflag||false,rflag:b.rflag||false,calendarId:b.calendarId,color:c,title:this.generateTitle(b),time:this.generateInfo(b),subject:a,content:b.content||"",day:b.day,eday:b.eday,repeatType:b.repeatType,alertFlag:b.alertFlag,locked:b.locked}):this.legendTpl.apply({id:b.eventId,calendarId:b.calendarId,color:c,title:this.generateTitle(b),time:this.generateInfo(b),subject:a,content:b.content||"",day:b.day,
eday:b.eday,repeatType:b.repeatType,alertFlag:b.alertFlag,locked:b.locked})},deleteLegend:function(a,b,c){c=b.getCellIndex(c.dom.id);this.calendarLayout.getLayout(b.daySet[c.x*b.dayNum+c.y],b).updateLayout(a,"delete")},createCalendar:function(a,b,c,d){b=this.calendarDropTpl.apply({"legend-style":"height:9px;",title:d.name,calendarId:d.id,color:d.color});a="beforeBegin"==c?Ext.DomHelper.insertHtml("beforeBegin",a.dom.firstChild,b):Ext.DomHelper.insertHtml("beforeEnd",a.dom,b);if(a=Ext.get(a)){a.addClassOnOver("x-calendar-over");
a.calendar=d;this.initCalendar(a)}return a},initCalendar:function(a){a.on("click",this.onCalendarElClickFn,{cEl:a,sp:this});a.on("dblclick",this.onCalendarElDblClickFn,{cEl:a,sp:this})},onCalendarElDblClickFn:function(){var a=this.cEl;this.sp.ceditor.popup({data:a.calendar,cEl:a})},onCalendarElClickFn:function(a){var b=this.sp,c=this.cEl,d=c.calendar;a=Ext.get(a.getTarget());if(a.hasClass("x-legend-tool")){b.menu.palette.calendar=d;b.showMenu(c,a)}else{d.hide=!d.hide;b.ds.createUpdateCalendar(d,function(){if(d.hide){b.hideCalendar(d,
true);b.hideCalendarColor(c,d.color)}else{b.hideCalendar(d,false);b.showCalendarColor(c,d.color)}},this)}},onCalendarColorChangedFn:function(a,b){if(true!==a.still){(b=Ext.ux.calendar.Mask.getIndexByColor(b))&&this.changeColor(a.calendar,b);this.menu.hide()}},changeEventColor:function(a,b,c){var d=a.child(".x-calendar-"+b+"-event-ltcorner-clear");if(d){d.removeClass("x-calendar-"+b+"-event-ltcorner-clear");d.addClass("x-calendar-"+c+"-event-ltcorner-clear")}if(d=a.child(".x-calendar-"+b+"-event-ltcorner")){d.removeClass("x-calendar-"+
b+"-event-ltcorner");d.addClass("x-calendar-"+c+"-event-ltcorner")}if(d=a.child(".x-calendar-"+b+"-event-rtcorner-clear")){d.removeClass("x-calendar-"+b+"-event-rtcorner-clear");d.addClass("x-calendar-"+c+"-event-rtcorner-clear")}if(d=a.child(".x-calendar-"+b+"-event-rtcorner")){d.removeClass("x-calendar-"+b+"-event-rtcorner");d.addClass("x-calendar-"+c+"-event-rtcorner")}if(d=a.child(".x-calendar-"+b+"-event-top-clear")){d.removeClass("x-calendar-"+b+"-event-top-clear");d.addClass("x-calendar-"+
c+"-event-top-clear")}if(d=a.child(".x-calendar-"+b+"-event-top")){d.removeClass("x-calendar-"+b+"-event-top");d.addClass("x-calendar-"+c+"-event-top")}if(d=a.child(".x-calendar-"+b+"-event-lr")){d.removeClass("x-calendar-"+b+"-event-lr");d.addClass("x-calendar-"+c+"-event-lr")}if(d=a.child(".x-calendar-"+b+"-event-lbcorner")){d.removeClass("x-calendar-"+b+"-event-lbcorner");d.addClass("x-calendar-"+c+"-event-lbcorner")}if(d=a.child(".x-calendar-"+b+"-event-rbcorner")){d.removeClass("x-calendar-"+
b+"-event-rbcorner");d.addClass("x-calendar-"+c+"-event-rbcorner")}if(a=a.child(".x-calendar-"+b+"-event-bottom")){a.removeClass("x-calendar-"+b+"-event-bottom");a.addClass("x-calendar-"+c+"-event-bottom")}},changeWholeColor:function(a,b,c){var d=a.child(".x-whole-title-"+b);if(d){d.removeClass("x-whole-title-"+b);d.addClass("x-whole-title-"+c)}if(d=a.child(".x-calendar-"+b+"-whole-left")){d.removeClass("x-calendar-"+b+"-whole-left");d.addClass("x-calendar-"+c+"-whole-left")}if(a=a.child(".x-calendar-"+
b+"-whole-right")){a.removeClass("x-calendar-"+b+"-whole-right");a.addClass("x-calendar-"+c+"-whole-right")}},changeCalendarColor:function(a,b,c){var d,e=a.child(".x-whole-title-"+b);if(e){d=false;e.removeClass("x-whole-title-"+b);e.addClass("x-whole-title-"+c)}else{d=true;(e=a.child(".x-calendar-title-b"))&&e.setStyle("color","#"+Ext.ux.calendar.Mask.getColorByIndex(c))}if(false==d){if(d=a.child(".x-calendar-"+b+"-whole-left")){d.removeClass("x-calendar-"+b+"-whole-left");d.addClass("x-calendar-"+
c+"-whole-left")}if(a=a.child(".x-calendar-"+b+"-whole-right")){a.removeClass("x-calendar-"+b+"-whole-right");a.addClass("x-calendar-"+c+"-whole-right")}}},hideCalendarColor:function(a,b){var c=a.child(".x-calendar-"+b+"-whole-left");c&&c.removeClass("x-calendar-"+b+"-whole-left");(c=a.child(".x-calendar-"+b+"-whole-right"))&&c.removeClass("x-calendar-"+b+"-whole-right");(c=a.child(".x-whole-title-"+b))&&c.removeClass("x-whole-title-"+b);if(a=a.child(".x-calendar-title-b")){b=Ext.ux.calendar.Mask.getColorByIndex(b);
a.setStyle("color","#"+b)}},showCalendarColor:function(a,b){var c=a.child(".x-whole-left");c&&c.addClass("x-calendar-"+b+"-whole-left");(c=a.child(".x-whole-right"))&&c.addClass("x-calendar-"+b+"-whole-right");(c=a.child(".x-calendar-title"))&&c.addClass("x-whole-title-"+b);(a=a.child(".x-calendar-title-b"))&&a.setStyle("color","white")},changeLegendColor:function(a,b,c){alert("changeLegendColor");if(a=a.child(".x-legend-title-"+b)){a.removeClass("x-legend-title-"+b);a.addClass("x-legend-title-"+
c)}},changeColor:function(a,b){var c=a.color;a.color=b;this.ds.createUpdateCalendar(a,function(d){if(d.success||"true"==d.success){this.calendarSet[a.id].color=b;(d=Ext.get(this.id+"-x-calendar-"+a.id))&&this.changeCalendarColor(d,c,a.color);var e=this.mainPanel.body,f=Ext.DomQuery.select("."+this.id+"-x-calendar-"+a.id+"-event",e.dom);if(f){d=0;for(var g=f.length;d<g;d++)this.changeEventColor(Ext.get(f[d]),c,a.color)}if(f=Ext.DomQuery.select("."+this.id+"-x-calendar-"+a.id+"-whole",e.dom)){d=0;for(g=
f.length;d<g;d++)this.changeWholeColor(Ext.get(f[d]),c,a.color)}if(e=Ext.DomQuery.select("."+this.id+"-x-calendar-"+a.id+"-legend",e.dom)){d=0;for(g=e.length;d<g;d++)this.changeLegendColor(Ext.get(e[d]),c,a.color)}d=this.mainPanel.calendarContainer.getLayout().activeItem;d instanceof Ext.ux.calendar.ResultView&&d.list.getView().refresh();this.fireEvent("changeCalendarColor",this,a,c,a.color)}},this)},freeEventEl:function(a){a.remove()},pushDayCache:function(a,b){var c=a.format("Y-m-d");a=a;for(b=
b.format("Y-m-d");c<=b;){this.dayCache[c]=a;a=a.add(Date.DAY,1);c=a.format("Y-m-d")}},isInDayCache:function(a,b){var c=true,d=a.format("Y-m-d");a=a;for(b=b.format("Y-m-d");d<=b;){if(!this.dayCache[d]){c=false;break}a=a.add(Date.DAY,1);d=a.format("Y-m-d")}return c},bindEvent2Detail:function(a,b,c){for(var d="",e=0,f=b.length;e<f;e++){var g=b[e];d+=this.generateLegend(this,g)}c.dom.innerHTML=d;e=0;for(f=c.dom.childNodes.length;e<f;e++){g=Ext.apply({},b[e]);d=Ext.get(c.dom.childNodes[e]);d.bindEvent=
g;d.cview=a}},updateRepeatEvent:function(a,b,c){if("string"==Ext.type(a.repeatType)){var d=c.repeatType.exceptions||{};d[c.day]=true;c.repeatType.exceptions=d}this.ds.createUpdateRepeatEvent(a,c,function(e){var f=this.calendarLayout;if(e.id)a.eventId=e.id;if("string"==Ext.type(c.repeatType)){this.deleteEventFromLayout(c,b);f.updateRepeatEventList(b,[a],"update")}else if("string"==Ext.type(a.repeatType)){this.createEventToLayout(a,b);"exception"==a.repeatType?f.updateRepeatEventList(b,[c],"update"):
f.updateRepeatEventList(b,[c],"delete")}else f.updateRepeatEventList(b,[a],"update");this.fireEvent("changeEventCache",this)},this)},loadRepeatEvent:function(a,b){this.ds.loadRepeatEvent(function(c){this.calendarLayout.repeatSet=c;a.call(b)},this)},getStartDateInWeek:function(a,b){if(1==this.startDay){b=a.format("N");a=a.add(Date.DAY,1-b)}else{var c=-a.format("w");if(5==b.dayNum&&b instanceof Ext.ux.calendar.DayView||5==b.colNum&&b instanceof Ext.ux.calendar.MonthView)c++;a=a.add(Date.DAY,c)}return a},
loadCalendar:function(a,b){this.ds.loadCalendar(function(c){var d=c.owned;c=c.shared;this.calendarSet={};if(0<d.length||0<c.length){for(var e,f=0,g=d.length;f<g;f++){e=d[f];this.calendarSet[e.id]=e}f=0;for(g=c.length;f<g;f++){e=c[f];this.calendarSet[e.id]=e}this.loadRepeatEvent(function(){this.fireEvent("calendarloaded")},this);a&&this.renderOwnedCalendar(a);b&&this.renderSharedCalendar(b)}},this)},renderOwnedCalendar:function(a){var b=this.calendarSet;a.dom.innerHTML="";for(var c in b){var d=b[c];
if(!d.isShared){var e=this.createCalendar(a,null,null,d);d.hide&&this.hideCalendarColor(e,d.color)}}},renderSharedCalendar:function(a){var b=this.calendarSet;a.dom.innerHTML="";for(var c in b){var d=b[c];if(d.isShared){var e=this.createCalendar(a,null,null,d);d.hide&&this.hideCalendarColor(e,d.color)}}},reloadCalendar:function(a,b,c){this.dayCache={};this.calendarLayout.layoutSet={};this.calendarLayout.wholeList=[];c?this.loadCalendar(a,b):this.loadRepeatEvent(function(){this.fireEvent("calendarloaded")},
this)}});Ext.ns("Ext.ux.calendar");Ext.ux.calendar.Block=function(a){var b={};b.id=0;b.colNum=0;b.startRow=100;b.endRow=-1;b.eventList=[];b.addEvent=function(c){if(c.startRow<b.startRow)b.startRow=c.startRow;if(c.endRow>b.endRow)b.endRow=c.endRow;b.eventList[b.eventList.length]=c};Ext.apply(b,a);return b};Ext.ns("Ext.ux.calendar");Ext.ux.calendar.BlockMap=function(a,b){var c={};c.event=a;c.block=b;return c};Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.CalendarLayout=function(a){Ext.apply(this,a);this.layoutSet={};this.wholeList=[];this.repeatSet={};Ext.ux.calendar.CalendarLayout.superclass.constructor.call(this)};
Ext.extend(Ext.ux.calendar.CalendarLayout,Ext.util.Observable,{getWholeList:function(a,b,c,d){var e=this.ehandler,f=e.calendarSet,g=[],h=[],j;if(d)j=e=b;else if(1==a.dayNum)j=e=b;else{j=a.colNum||a.dayNum;var i=Date.parseDate(b,"Y-m-d");i=e.getStartDateInWeek(i,a);e=i.format("Y-m-d");j=i.add(Date.DAY,j-1).format("Y-m-d")}i=0;for(var n=this.wholeList.length;i<n;i++){var m=this.wholeList[i];if(f[m.calendarId]){if(!f[m.calendarId].hide||c)if(m.day==b||e==b&&m.day<b&&m.eday>=b){if(m.day<e)m.lflag=true;
else delete m.lflag;if(m.eday>j)m.rflag=true;else delete m.rflag;g.push(m)}h.push(m)}}this.wholeList=h;return g=this.combine2List(this.getRepeatEvent(a,b,true,c,d),g)},updateWholeList:function(a,b){if(a)if("add"==b)this.wholeList=this.combine2List(this.wholeList,a);else if("update"==b){b=0;for(var c=a.length;b<c;b++)this.deleteFromList(this.wholeList,a[b]);this.wholeList=this.combine2List(this.wholeList,a)}else if("delete"==b){b=0;for(c=a.length;b<c;b++)this.deleteFromList(this.wholeList,a[b])}},
deleteFromList:function(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c].eventId==b.eventId){a.splice(c,1);break}},deleteDayFromWholeList:function(a,b,c){var d=this.ehandler.calendarSet;b=b||a;var e,f,g=this.wholeList.length,h=[];for(e=0;e<g;e++){var j=this.wholeList[e];if(j.day>a)return h;else if(!d[j.calendarId].hide&&j.day>=a&&j.eday<=b)break}for(f=e;f<g;f++){j=this.wholeList[f];if(!d[j.calendarId].hide&&j.day>=a&&j.eday<=b)h.push(Ext.apply({},j));else break}c||this.wholeList.splice(e,f-e);return h},
changeDayInWholeList:function(a,b,c){var d=this.ehandler.calendarSet,e,f,g=this.wholeList.length;for(e=0;e<g;e++){var h=this.wholeList[e];if(h.day>a){e=g;break}else if(!d[h.calendarId].hide&&h.day>=a&&h.eday<=a)break}var j=[];for(f=e;f<g;f++){h=this.wholeList[f];if(!d[h.calendarId].hide&&h.day>=a&&h.eday<=a){h=Ext.apply({},h);h.day=b;h.eday=b;j.push(h)}else break}c||this.wholeList.splice(e,f-e);this.wholeList=this.combine2List(this.wholeList,j)},getLayout:function(a,b,c,d,e){if(a instanceof Date)a=
a.format("Y-m-d");var f=function(){var g=new Ext.ux.calendar.LayoutGrid({owner:this,ehandler:this.ehandler,cview:b,day:a,hideCalendar:true});g.viewChanged=true;g.generateLayout(c||[]);this.layoutSet[a]=g};if(e)f.call(this);else if(this.layoutSet[a]){this.layoutSet[a].viewChanged=this.layoutSet[a].cview!==b?true:false;this.layoutSet[a].cview=b}else if(true==d)f.call(this);else return null;return this.layoutSet[a]},resetSingleLayout:function(a,b,c){a.hideCalendar=b.hideCalendar;a.deleteCalendar=b.deleteCalendar;
a.updateRepeat=b.updateRepeat;delete a.layouted;b=a.visited;c&&a.reLayout();if(a.hideCalendar){for(var d in b)b[d]="hideCalendar";a.visited=b}else if(a.deleteCalendar){for(d in b)b[d]="deleteCalendar";a.visited=b}else if(a.updateRepeat){for(d in b)b[d]="updateRepeat";a.visited=b}else a.visited={}},resetLayout:function(a,b){for(var c in this.layoutSet)this.resetSingleLayout(this.layoutSet[c],a,b)},checkRepeat:function(a,b,c){for(var d=b.length;c<d;c++){var e=b[c];if(!(e.day==a.day&&e.eday==a.eday&&
e.startRow==a.startRow&&e.endRow==a.endRow))return false;if(e.eventId==a.eventId)return true}return false},combine2List:function(a,b){var c=[],d=0,e=0;if(a)d=a.length;if(b)e=b.length;var f,g;for(g=f=0;f<d&&g<e;){var h=a[f],j=b[g],i=h.day+"-"+h.startRow,n=h.eday+"-"+h.endRow,m=j.day+"-"+j.startRow,l=j.eday+"-"+j.endRow;if(i<m||i==m&&n>l){c.push(h);f++}else{this.checkRepeat(j,a,f)||c.push(j);g++}}if(f==d)for(;g<e;g++){j=b[g];c.push(j)}if(g==e)for(;f<d;f++){h=a[f];c.push(h)}return c},updateRepeatEventList:function(a,
b,c){if("add"==c||"update"==c){c=0;for(var d=b.length;c<d;c++){var e=b[c];this.repeatSet[e.eventId]=e}}else if("delete"==c){c=0;for(d=b.length;c<d;c++){e=b[c];delete this.repeatSet[e.eventId]}}this.resetLayout({hideCalendar:false,deleteCalendar:false,updateRepeat:true},true);a.checkLayout()},getRepeatEvent:function(a,b,c,d,e){var f=this.ehandler,g,h,j;if(c){g=Date.parseDate(b,"Y-m-d");if(e)j=h=b;else if(1==a.dayNum)j=h=b;else{j=a.colNum||a.dayNum;a=f.getStartDateInWeek(g,a);h=a.format("Y-m-d");j=
a.add(Date.DAY,j-1).format("Y-m-d")}}a=[];e={};var i=this.repeatSet,n=f.calendarSet;for(var m in i){var l=i[m],o=n[l.calendarId];if(o){if(!o.hide||d){var k;o=l.repeatType.dspan;if(c){if(0<o||0==l.startRow&&f.rowCount==l.endRow)if(h==b)for(var p=0;p<=o;p++){k=g.add(Date.DAY,-p).format("Y-m-d");if(k=Ext.ux.calendar.RepeatType.getEvent(l,k)){if(k.day<h)k.lflag=true;else delete k.lflag;if(k.eday>j)k.rflag=true;else delete k.rflag;a=this.combine2List(a,[k])}}else if(k=Ext.ux.calendar.RepeatType.getEvent(l,
b)){if(k.day<h)k.lflag=true;else delete k.lflag;if(k.eday>j)k.rflag=true;else delete k.rflag;a=this.combine2List(a,[k])}}else if(0==o&&(0!=l.startRow||f.rowCount!=l.endRow))if(k=Ext.ux.calendar.RepeatType.getEvent(l,b))a=this.combine2List(a,[k])}e[l.eventId]=l}}this.repeatSet=e;return a},showWeek:function(a,b,c,d,e){var f=this.ehandler;a.cleanup(c,true);for(var g=a.colNum||a.dayNum,h=a.shiftDay||a.dayNum,j=a.daySet,i=[],n=[],m=0;m<h;m++)n.push(0);f=f.getStartDateInWeek(a.daySet[c*h],a).format("Y-m-d");
var l=a.startColIndex,o=a.endColIndex;for(m=0;m<g;m++){var k=c*h+m+l;k=j[k];var p=k.format("Y-m-d");k=d[p];if(!e){k=this.getLayout(p,a,k||[],true);k=k.reLayout();k=k.wlist.concat(k.elist)}p=0;for(var q=k.length;p<q;p++){var t=Ext.apply({},k[p]),s=Ext.ux.calendar.Mask.getDayOffset(f<t.day?t.day:f,t.eday);s=m+s;if(s>=g)s=g-1;this.insert2Table(i,m,s,t,n,a.lineNum)}}for(m=0;m<l;m++){k=c*h+m;k=j[k];p=k.format("Y-m-d");k=d[p];if(!e){k=this.getLayout(p,a,k||[],true);k=k.reLayout();k.wlist.concat(k.elist)}}for(m=
o;m<a.dayNum;m++){k=c*h+m;k=j[k];p=k.format("Y-m-d");k=d[p];if(!e){k=this.getLayout(p,a,k||[],true);k=k.reLayout();k.wlist.concat(k.elist)}}this.checkMore(a,n,i);if((c=this.generateTR(a,i,c))&&0<c.length){if(b.insertAdjacentHTML&&!Ext.isIE){c=c.join("");b.insertAdjacentHTML("beforeEnd",c)}else{p=0;for(q=c.length;p<q;p++)Ext.DomHelper.append(b,c[p])}this.bindEvent2Table(a,i,b)}},insert2Table:function(a,b,c,d,e,f){for(var g=false,h,j=0,i=a.length;j<i;j++){h=a[j];g=true;for(var n=b;n<=c;n++)if(h[n]){g=
false;break}if(g)break}if(!g)if(!f||a.length<f){h={};a.push(h);g=true}else for(n=b;n<=c;n++)e[n]++;if(g){a=c-b+1;for(n=b;n<=c;n++)h[n]={span:a,event:d}}return g},checkMore:function(a,b,c){if(0<c.length){a=a.colNum||a.dayNum;for(var d=c[c.length-1],e=0;e<a;){var f=d[e];if(f){f=f.span;for(var g=false,h=0;h<f;h++)if(0<b[e+h]){g=true;break}if(g)for(h=0;h<f;h++){g=e+h;var j=d[g];j.span=1;j.event=0>=b[g]?1:b[g]+1}e+=f}else{if(0<b[e])d[e]={span:1,event:b[e]};e++}}}return c},generateTR:function(a,b,c){for(var d=
this.ehandler,e=d.lang.EventHandler,f=a.colNum||a.dayNum,g=a.shiftDay,h=a.daySet,j=a.startColIndex,i=[],n=b.length,m=0;m<n;m++){for(var l=b[m],o="",k=0;k<f;)if(l[k]){var p=l[k].span,q=l[k].event;q="number"==Ext.type(q)?'<div class="x-event-more-ct"><u><b name="'+h[c*g+k+j].format("Y-m-d")+'" class="x-event-more">&nbsp;&nbsp;&nbsp;&nbsp;'+q+" "+e.more+"...</b></u></div>":d.generateLegend(a,q);o+='<td colspan="'+p+'">'+q+"</td>";k+=p}else{o+="<td></td>";k++}o="<tr>"+o+"</tr>";i.push(o)}if(0<i.length)return i},
bindEvent2Table:function(a,b,c){for(var d=a.colNum||a.dayNum,e=b.length,f=0;f<e;f++)for(var g=b[f],h=0;h<d;)if(g[h]){for(var j=g[h].span,i=g[h].event,n=Ext.DomQuery.select("div[name=x-event-"+i.day+"-"+i.eday+"-"+i.eventId+"]",c),m=0,l=n.length;m<l;m++){var o=Ext.get(n[m]);o.bindEvent=i;o.cview=a}h+=j}else h++}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.LayoutGrid=function(a){Ext.apply(this,a);this.CALENDAR_ROW_NUM=this.ehandler.rowCount;this.blockId=0;this.grid=[];this.wholeList=[];this.heventList=[];this.hwholeList=[];this.visited={};this.crossVisited={}};
Ext.ux.calendar.LayoutGrid.prototype={getAllEvents:function(){var a=this.getEventList();return a=this.owner.getWholeList(this.cview,this.day,true,true).concat(a)},getEventList:function(){for(var a=[],b=-1,c=0;c<this.CALENDAR_ROW_NUM;c++){var d=this.grid[c];if(-1==b){if(null!=d.block){b=d.block.id;a=a.concat(d.block.eventList)}}else if(null!=d.block)if(b!=d.block.id){b=d.block.id;a=a.concat(d.block.eventList)}}return a},removeOutDeletedCalendar:function(a){var b=this.ehandler,c,d,e=[];c=0;for(d=this.heventList.length;c<
d;c++){var f=this.heventList[c];b.calendarSet[f.calendarId]&&e.push(f)}this.heventList=e;e=[];c=0;for(d=a.length;c<d;c++){f=a[c];b.calendarSet[f.calendarId]&&e.push(f)}return e},refreshRepeatEvent:function(a){var b,c,d=[];b=0;for(c=this.heventList.length;b<c;b++){var e=this.heventList[b];"string"==Ext.type(e.repeatType)&&d.push(e)}this.heventList=d;d=[];b=0;for(c=a.length;b<c;b++){e=a[b];"string"==Ext.type(e.repeatType)&&d.push(e)}return d=this.owner.combine2List(this.owner.getRepeatEvent(this.cview,
this.day),d)},filterEvent:function(a){var b=this.ehandler,c=[],d=[],e,f;if(this.deleteCalendar){this.deleteCalendar=false;a=this.removeOutDeletedCalendar(a)}if(this.hideCalendar){this.hideCalendar=false;e=0;for(f=this.heventList.length;e<f;e++){var g=this.heventList[e];b.calendarSet[g.calendarId].hide?d.push(g):c.push(g)}this.heventList=d;d=[];e=0;for(f=a.length;e<f;e++){g=a[e];b.calendarSet[g.calendarId].hide?this.heventList.push(g):d.push(g)}a=this.owner.combine2List(d,c);a=this.refreshRepeatEvent(a)}if(this.updateRepeat){this.updateRepeat=
false;a=this.refreshRepeatEvent(a)}return a},reLayout:function(a,b){return this.generateLayout(this.getEventList(),true,a,b)},increaseLine:function(a,b,c){for(;c>a.areaList.length;)a.areaList[a.areaList.length]=null;a.areaList[a.areaList.length]=b},addArea:function(a,b,c){if(a.areaList.length<c+1)this.increaseLine(a,b,c);else a.areaList[c]=b},generateArea:function(a,b,c){for(var d=a.startRow;d<a.endRow;d++){var e=this.grid[d];e.block=b;this.addArea(e,a,c)}},getColIndex:function(a){var b,c;b=0;for(c=
a.areaList.length;b<c;b++)if(null==a.areaList[b])break;return b},generateLayout:function(a,b,c,d){var e=[],f=[];if(!b)this.heventList=[];e=a;d||(f=this.owner.getWholeList(this.cview,this.day,null,c));e=this.filterEvent(e);if(this.layouted)this.visited[this.cview.id]=true;else{this.visited={};if(this.cview)this.visited[this.cview.id]=true;this.layouted=true;for(a=0;a<this.CALENDAR_ROW_NUM;a++)this.grid[a]=new Ext.ux.calendar.Line;this.blockId=0;e=this.Layouting(e)}this.inited=true;return{elist:e,wlist:f}},
Layouting:function(a){for(var b=this.ehandler,c=[],d=null,e=0,f=a.length;e<f;e++){var g=a[e],h=this.grid[g.startRow],j=this.getColIndex(h);if(g.colIndex!=j){g.colIndex=j;g.changed=true}if(0==h.areaList.length){d=new Ext.ux.calendar.Block;d.id=this.blockId++}else if(null!=d)if(d.colNum<j)d.colNum=j;h.block=d;c[c.length]=new Ext.ux.calendar.BlockMap(g,d);d.addEvent(g);this.generateArea(g,d,j)}e=0;for(f=c.length;e<f;e++){g=c[e];d=g.block.colNum+1;if(d!=g.event.span){g.event.span=d;g.event.changed=true}}f=
[];e=0;for(c=a.length;e<c;e++){g=a[e];b.calendarSet[g.calendarId].hide||(f[f.length]=g)}a=f;b={};e=0;for(c=a.length;e<c;e++){g=a[e];h=g.startRow;f=g.endRow;for(h=h;h<f;h++)if(b[h]){if(b[h].colIndex<g.colIndex)b[h]=g}else b[h]=g}e=0;for(c=a.length;e<c;e++){g=a[e];h=g.startRow;f=g.endRow;d=true;for(h=h;h<f;h++)if(b[h]&&g.colIndex<b[h].colIndex&&b[h].startRow>=g.startRow){d=false;break}if(true===d){if(true!==g.last){g.last=true;g.changed=true}}else{if(true===g.last)g.changed=true;delete g.last}}return a},
updateLayout:function(a,b,c){this.visited={};this.visited[this.cview.id]=true;if(0==a.startRow&&this.CALENDAR_ROW_NUM==a.endRow||a.day!=a.eday){this.owner.updateWholeList([a],b);return this.owner.getWholeList(this.cview,this.day)}else{var d=[],e=a.startRow,f=a.endRow,g,h,j=-1;g=0;for(h=this.grid.length;g<h;g++){var i=this.grid[g];if(j==-1)for(var n=0,m=i.areaList.length;n<m;n++){var l=i.areaList[n];if(null!=l)if(l.eventId==a.eventId){j=n;if(e>g)e=g;if(f<g+1)f=g+1}}else if(i.areaList.length>j)if(null!=
i.areaList[j]){if(i.areaList[j].eventId==a.eventId)if(f<g+1)f=g+1}else break;else break}h=-1;for(g=e;g<f;g++){i=this.grid[g];if(-1==h){if(null!=i.block){h=i.block.id;d=d.concat(i.block.eventList)}}else if(null!=i.block)if(h!=i.block.id){h=i.block.id;d=d.concat(i.block.eventList)}}if(b=="update"||b=="delete"){g=0;for(h=d.length;g<h;g++){i=d[g];if(a.eventId==i.eventId){if("update"==b&&true!==c&&a.startRow==i.startRow&&a.endRow==i.endRow){Ext.apply(i,a);return{elist:[a]}}d.splice(g,1);break}}}if(b==
"update"||b=="add"){g=0;for(h=d.length;g<h;g++){b=d[g].startRow;c=d[g].endRow;if(b>a.startRow){d.splice(g,0,a);break}else if(b==a.startRow&&c<=a.endRow){d.splice(g,0,a);break}}if(g==h)d[d.length]=a}if(d[0])if(e>d[0].startRow)e=d[0].startRow;if(null!=this.grid[f-1].block)if(f<this.grid[f-1].block.endRow)f=this.grid[f-1].block.endRow;for(g=e;g<f;g++){if(this.grid[g].areaList.length>0)this.grid[g].areaList.length=0;this.grid[g].block=null}g=0;for(h=d.length;g<h;g++)d[g].changed=false;a.changed=true;
d=this.Layouting(d);e=[];g=0;for(h=d.length;g<h;g++){a=d[g];a.changed==true&&e.push(a)}return{elist:e}}}};Ext.ns("Ext.ux.calendar");Ext.ux.calendar.Line=function(a){var b={};b.areaList=[];b.block=null;Ext.apply(b,a);return b};Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.MainPanel=function(a){Ext.apply(this,a);this.datasource=this.datasource||new Ext.ux.calendar.DataSource;this.datasource.mainPanel=this;this.commentTip=new Ext.ux.calendar.CommentTip;this.ehandler=new Ext.ux.calendar.EventHandler({ds:this.datasource,mainPanel:this,commentTip:this.commentTip,calendarSetting:this.calendarSetting,lang:this.lang});this.editor=new Ext.ux.calendar.Editor({ehandler:this.ehandler});this.ceditor=new Ext.ux.calendar.CalendarEditor({ehandler:this.ehandler});this.ehandler.editor=
this.editor;this.ehandler.ceditor=this.ceditor;this.westPanel=new Ext.ux.calendar.WestPanel({ehandler:this.ehandler});this.calendarContainer=new Ext.ux.calendar.CalendarContainer({ehandler:this.ehandler});this.backthread=new Ext.ux.calendar.BackThread({ehandler:this.ehandler});Ext.ux.calendar.MainPanel.superclass.constructor.call(this,{border:false,layout:"border",items:[this.westPanel,this.calendarContainer]});this.ehandler.on("calendarloaded",this.calendarContainer.onCalendarLoadedFn,this.calendarContainer);
this.on("afterrender",this.onAfterRenderFn,this);this.on("destroy",this.onDestroyFn,this);this.westPanel.relayEvents(this.calendarContainer,["changedate"]);this.relayEvents(this.calendarContainer,["beforeremoteload","remoteload"]);this.calendarContainer.relayEvents(this.editor,["showdetailsetting"]);this.editor.relayEvents(this.calendarContainer,["hideeditor"]);this.on("beforeremoteload",this._onBeforeRemoteLoadFn,this);this.on("remoteload",this._onRemoteLoadFn,this,{delay:500})};
Ext.extend(Ext.ux.calendar.MainPanel,Ext.Panel,{_onBeforeRemoteLoadFn:function(){this.loadMask.show()},_onRemoteLoadFn:function(){this.loadMask.hide()},onAfterRenderFn:function(a){this.calendarContainer.relayEvents(a.body,["mousedown"]);this.editor.render(a.body);this.loadMask=new Ext.LoadMask(a.body,{msg:this.lang.MainPanel["loadMask.msg"]})},onDestroyFn:function(){this.backthread.destroy()}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.MonthView=Ext.extend(Ext.ux.calendar.BasicView,{legendHeight:17,border:false,dayFormat:"m/d",templateRowNum:6,weekNum:5,dayNum:7,rowNum:6,colNum:7,menuAlign:"tr-br?",poolDepth:0,leftWidth:25,showMenu:function(a){if(this.menu){this.menu.bindEl=a;this.menu.show(Ext.get(a.dom.parentNode),this.menuAlign)}return this},hideMenu:function(){this.menu&&this.menu.hide();return this},initMenu:function(){var a=this.ehandler.lang.MonthView;this.addItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-new",
text:a["addItem.text"],handler:this.onAddFn,scope:this});this.clearItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-clear_event",text:a["clearItem.text"],handler:this.onClearFn,scope:this});this.cutItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-cut",text:a["cutItem.text"],handler:this.onCutFn,scope:this});this.copyItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-copy",text:a["copyItem.text"],handler:this.onCopyFn,scope:this});this.pasteItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-paste",
text:a["pasteItem.text"],handler:this.onPasteFn,scope:this});this.menu=new Ext.menu.Menu({items:[this.addItem,this.clearItem,"-",this.cutItem,this.copyItem,this.pasteItem]});this.menu=Ext.menu.MenuMgr.get(this.menu)},getCellIndex:function(a){a=a.toString().split("-");var b=a.length,c=a[b-1];return{x:parseInt(a[b-2]),y:parseInt(c)}},generateHTML:function(){this.generateCSS();this.viewerTpl=new Ext.XTemplate('<div id="'+this.id+'-x-monthview-viewer"><table width="100%" cellspacing="0" cellpadding="0" border="0" unselectable="on" onselectstart="return false;"><tbody><tr><td class="x-monthview-lefter"><div id="'+
this.id+'-x-monthview-lefter"><tpl for="."><div class="x-monthview-lefter-inner '+this.id+'-x-monthview-row"><u><b id="'+this.id+'-x-monthview-week-{idx}-0" class="x-monthview-lefter-inner-b">{week}</b></u></div></tpl></div></td><td class="x-monthview-port-td"><div id="'+this.id+'-x-monthview-port" class="x-monthview-port"><tpl for="."><div class="'+this.id+'-x-monthview-row x-monthview-row" unselectable="on"><table class="x-monthview-bg" width="100%" height="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><tpl for="arr"><td id="'+
this.id+'-x-monthview-viewer-{parent.idx}-{idx}" class="'+this.id+'-x-monthview-viewer-col-{idx} x-monthview-viewer-cell">&nbsp;</td></tpl></tr></tbody></table><table id="'+this.id+'-x-monthview-ct-{idx}" class="x-monthview-ct" width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><tpl for="arr"><td id="'+this.id+'-x-monthview-viewer-title-{parent.idx}-{idx}" class="'+this.id+'-x-monthview-viewer-col-{idx} x-monthview-viewer-title"><div><table width="100%" height="100%" border="0"><tbody><tr><td><u id="'+
this.id+'-x-monthview-viewer-link-{parent.idx}-{idx}" class="x-monthview-viewer-link"><b class="x-monthview-viewer-link-b">{day}</b></u></td>'+(this.ehandler.readOnly?"":'<td class="x-monthview-viewer-tool"><img id="'+this.id+'-x-monthview-tool-add-{parent.idx}-{idx}" class="x-monthview-tool-add" src="'+Ext.BLANK_IMAGE_URL+'"></img><img id="'+this.id+'-x-monthview-tool-drop-{parent.idx}-{idx}" class="x-monthview-tool-drop" src="'+Ext.BLANK_IMAGE_URL+'"></img></td>')+"</tr></tbody></table></div></td></tpl></tr></tbody></table></div></tpl></div></div></td></tr></tbody></table>");
this.viewerTpl.compile();for(var a=[],b=this.daySet[0],c=b.getWeekOfYear(),d=0;d<this.templateRowNum;d++){for(var e=[],f=0;f<this.dayNum;f++)e[e.length]={idx:f,day:b.add(Date.DAY,d*this.dayNum+f).format(this.dayFormat)};f=(c+d)%53;if(0==f)f=53;a[a.length]={idx:d,week:f,arr:e}}a=this.viewerTpl.apply(a);b="";for(f=0;f<this.dayNum;f++)b+='<td class="'+this.id+"-x-monthview-viewer-col-"+f+' x-dayview-header-days"><div><b style="line-height:15px;">'+this.ehandler.lang.MonthView.dayPre+this.daySet[f].format("l")+
"</b></div></td>";return'<div id="'+this.id+'-x-monthview-header" class="x-monthview-header" unselectable="on"><table width="100%" height="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr>'+b+"</tr></tbody></table></div>"+a},generateCSS:function(){for(var a="."+this.id+"-x-monthview-viewer-row-height{}."+this.id+"-x-monthview-row{}."+this.id+"-x-monthview-viewer-list{}",b=0;b<this.dayNum;b++)a+="."+this.id+"-x-monthview-viewer-col-"+b+"{}";b=Ext.id();this.ss=Ext.util.CSS.createStyleSheet(a,
b)},setToday:function(){var a=this.daySet[0],b=a.format("n");if(1!=a.format("j")){b=(b+1)%12;if(0==b)b=12}a=(new Date).format("Y-m-d");for(var c=0,d=this.daySet.length;c<d;c++){var e=this.daySet[c].format("Y-m-d"),f=this.daySet[c].format("n");if(e==a){e=Math.floor(c/this.dayNum);f=c%this.dayNum;(e=Ext.get(this.id+"-x-monthview-viewer-title-"+e+"-"+f))&&e.setStyle("background-color","rgb(255,255,200)")}else if(b!=f){e=Math.floor(c/this.dayNum);f=c%this.dayNum;(e=Ext.get(this.id+"-x-monthview-viewer-title-"+
e+"-"+f))&&e.setStyle("background-color","rgb(235,235,235)")}else{e=Math.floor(c/this.dayNum);f=c%this.dayNum;(e=Ext.get(this.id+"-x-monthview-viewer-title-"+e+"-"+f))&&e.setStyle("background-color","rgb(241,244,250)")}}},getStartDate:function(a){if(1==this.startDay){var b=a.format("N");b=1-b;a=a.add(Date.DAY,b)}else{b=a.format("w");a=a.add(Date.DAY,-b)}return a},initComponent:function(){this.id=Ext.id();this.ehandler.applyCalendarSetting(this);var a=(new Date).getFirstDateOfMonth();this.recalculateWeek(a);
a=this.getStartDate(a);this.daySet=[];for(var b=0;b<this.weekNum;b++)for(var c=0;c<this.dayNum;c++)this.daySet[this.daySet.length]=a.add(Date.DAY,b*this.shiftDay+c);this.html=this.generateHTML();this.initMenu();Ext.ux.calendar.MonthView.superclass.initComponent.call(this);this.addEvents("checklayout","afterresize","beforeremoteload","remoteload","canceldetail","viewDay","viewWeek");this.on("checklayout",this.checkLayout,this);this.on("canceldetail",this.onCancelDetailFn,this);this.on("afterrender",
this._onAfterRenderFn,this);this.on("afterlayout",this._onReSizingFn,this);this.on("bodyresize",this._onReSizingFn,this);this.on("sizechanged",this.onSizeChangedFn,this,{buffer:50});Ext.EventManager.on(document,"mouseup",this._onMouseUpFn,this)},_onAfterRenderFn:function(){this.initEls()},_onReSizingFn:function(){this.fireEvent("sizechanged")},onSizeChangedFn:function(){this.handleResize(this.body.getWidth(),this.body.getHeight())},onCancelDetailFn:function(){if(this.detailing){this.detailing=false;
this.detailCt.setStyle("display","none")}},resetSCover:function(){delete this.startPos;delete this.endPos;this.hideSCovers()},_onMouseUpFn:function(){if(!this.dragging)if(this.startPos){var a=Ext.apply({},this.startPos),b=Ext.apply({},this.endPos);this.startPos=null;var c=this.ehandler;if(this.colNum!=this.shiftDay&&1!=c.startDay){a.y++;b.y++}c.prepareLegend(Ext.get(this.id+"-x-monthview-viewer-title-"+b.x+"-"+b.y),a,b,this)}},getMinMaxFromStartEnd:function(a,b){var c=a.x,d=a.y,e=b.x,f=b.y;return c<
e||c==e&&d<=f?{minPos:a,maxPos:b}:{minPos:b,maxPos:a}},hideSCovers:function(){for(var a=0,b=this.scovers.length;a<b;a++)this.scovers[a].dom.style.display="none"},selectRange:function(a,b){this.hideSCovers();if(a)this.startPos=a;else a=this.startPos;this.endPos=b;var c=this.getMinMaxFromStartEnd(a,b);b=c.minPos.x;var d=c.minPos.y;a=c.maxPos.x;c=c.maxPos.y;var e=this.cw,f=this.ch,g,h=Math.floor(e*d);if(b==a){g=this.scovers[b];g.dom.style.display="";d=e*(c-d+1);g.setWidth(d);g.setHeight(f);g.setLeft(h+
"px")}else{g=this.scovers[b];g.dom.style.display="";d=e*(this.colNum-d);g.setWidth(d);g.setHeight(f);g.setLeft(h+"px");for(b=b+1;b<a;b++){g=this.scovers[b];g.dom.style.display="";d=e*this.colNum;g.setWidth(d);g.setHeight(f);g.setLeft("0px")}g=this.scovers[a];g.dom.style.display="";d=e*(c+1);g.setWidth(d);g.setHeight(f);g.setLeft("0px")}},calculatePos:function(a){var b=a.getXY(),c=this.port.getXY();a=Math.floor((b[0]-c[0])/this.cw);b=Math.floor((b[1]-c[1])/this.ch);if(0>b)b=0;else if(b>=this.weekNum){b=
this.weekNum-1;a=this.colNum-1}if(0>a)a=0;else if(a>=this.colNum)a=this.colNum-1;return{x:b,y:a}},getIndexFromDay:function(a){for(var b=0,c=this.daySet.length;b<c;b++)if(a==this.daySet[b].format("Y-m-d"))return b},alignDetailCt:function(){if(this.detailing){var a=this.detailing.x,b=this.detailing.y,c=this.detailing.events;this.detailCt.setStyle("display","");var d=Ext.get(this.id+"-x-monthview-viewer-title-"+a+"-"+b);a=Ext.get(this.id+"-x-monthview-viewer-"+a+"-"+b);var e=this.detailTitle.getHeight()+
this.detailFoot.getHeight()+20;b=c.length*17;var f=this.port.getBottom()-d.getTop()-e,g=a.getBottom()-this.port.getTop()-e,h=this.port.getRight()-d.getRight();e="t";var j=f;c=[0,0];var i=a.getWidth();200<i?this.detailCt.setWidth(i):this.detailCt.setWidth(200);if(f>b)this.detailViewer.setStyle("height","");else if(g>b){e="b";d=a;c[1]=-4;this.detailViewer.setStyle("height","")}else{if(g>f){e="b";j=g;d=a;c[1]=-4}this.detailViewer.setHeight(j)}if(h<this.detailCt.getWidth()){a="r";c[0]=-1}else a="l";a=
e+a;this.detailCt.alignTo(d,a+"-"+a,c)}},showDetails:function(a){var b=this.ehandler,c=b.lang.MonthView,d=b.calendarLayout.getLayout(a,this).reLayout(true);d=d.wlist.concat(d.elist);var e=this.getIndexFromDay(a),f=Math.floor(e/this.dayNum);e=e%this.dayNum;this.detailing={x:f,y:e,events:d};this.detailTitle.dom.innerHTML='<u id="'+Ext.id()+"-x-monthview-viewer-link-"+f+"-"+e+'" class="x-monthview-viewer-link"><b class="x-monthview-viewer-link-b">'+a+"</b></u>";this.detailFoot.dom.innerHTML=d.length+
" "+c.events;b.bindEvent2Detail(this,d,this.detailViewer);this.alignDetailCt()},_onPortMouseDownFn:function(a){a.stopEvent();this.fireEvent("hideeditor");var b=a.getTarget();b=Ext.get(b);if(b.hasClass("x-event-more"))this.showDetails(b.dom.getAttribute("name"));else{if(this.detailing)if(b.hasClass("x-event-detail-ct")||b.parent(".x-event-detail-ct"))return;else this.fireEvent("canceldetail");if(!this.createByDblclick&&!this.ehandler.readOnly)if(!b.hasClass("x-monthview-tool-drop")&&!b.hasClass("x-monthview-viewer-link-b"))if(!(b.hasClass("x-calendar-event")?
b:b.parent(".x-calendar-event"))){a=this.calculatePos(a);0<=a.x&&0<=a.y&&this.selectRange(a,a)}}},_onPortMouseMoveFn:function(a){if(0==a.button){if(this.startPos){a=this.calculatePos(a);0<=a.x&&0<=a.y&&this.selectRange(null,a)}}else this.resetSCover()},initEls:function(){this.lefter=Ext.get(this.id+"-x-monthview-lefter");this.viewer=Ext.get(this.id+"-x-monthview-viewer");this.port=Ext.get(this.id+"-x-monthview-port");this.cheader=Ext.get(this.id+"-x-monthview-header");this.lefter.un("click",this._onLefterClickFn,
this);this.lefter.on("click",this._onLefterClickFn,this);this.port.un("click",this._onPortClickFn,this);this.port.on("click",this._onPortClickFn,this);this.port.un("mousedown",this._onPortMouseDownFn,this);this.port.on("mousedown",this._onPortMouseDownFn,this);if(!this.ehandler.readOnly){this.port.un("mousemove",this._onPortMouseMoveFn,this);this.port.un("mouseover",this._onPortMouseOverFn,this);this.port.un("contextmenu",this._onPortContextMenuFn,this);this.port.un("dblclick",this._onPortDblclickFn,
this);this.port.on("mousemove",this._onPortMouseMoveFn,this);this.port.on("contextmenu",this._onPortContextMenuFn,this);this.port.on("mouseover",this._onPortMouseOverFn,this);this.port.on("dblclick",this._onPortDblclickFn,this);this.initDragZone(this.port)}this.initDetailCt();this.initSelectCover();this.setToday()},_onLefterClickFn:function(a){a.stopEvent();a=a.getTarget();a=Ext.get(a);if(a.hasClass("x-monthview-lefter-inner-b")){a=this.getCellIndex(a.dom.id).x;this.fireEvent("viewWeek",this.daySet[a*
this.shiftDay],this.daySet[(a+1)*this.shiftDay-1])}},_onPortDblclickFn:function(a){a.stopEvent();var b=a.getTarget();b=Ext.get(b);b.hasClass("x-calendar-event")||(b=b.parent(".x-calendar-event"));if(b)b&&!b.bindEvent.locked&&this.ehandler.showEditor(b,this,"update");else this.createByDblclick&&this.addLegend(this.calculatePos(a))},_onPortContextMenuFn:function(a){a.stopEvent();var b=a.getTarget();b=Ext.get(b);(b=b.hasClass("x-calendar-event")?b:b.parent(".x-calendar-event"))&&this.ehandler.showContextMenu(a,
b)},_onPortMouseOverFn:function(a){if(!this.detailing){a=a.getTarget();a=Ext.get(a);if(this.overEl){this.overEl.removeClass("x-tool-btn-over");delete this.overEl}if(a.hasClass("x-monthview-tool-drop")||a.hasClass("x-monthview-tool-add")){a.addClass("x-tool-btn-over");this.overEl=a}}},addLegend:function(a){var b=this.ehandler,c=Ext.apply({},a);this.selectRange(a,c);this.startPos=null;b.prepareLegend(Ext.get(this.id+"-x-monthview-viewer-title-"+a.x+"-"+a.y),a,c,this)},_onPortClickFn:function(a){var b=
this.ehandler;a=a.getTarget();a=Ext.get(a);var c;if(a.hasClass("x-event-detail-tool-close"))this.fireEvent("canceldetail");else if(a.hasClass("x-monthview-viewer-link-b")){b=this.getCellIndex(a.dom.parentNode.id);this.fireEvent("viewDay",this,this.daySet[b.x*this.dayNum+b.y])}else if(!b.readOnly)if(a.hasClass("x-monthview-tool-add"))this.addLegend(this.getCellIndex(a.dom.id));else if(a.hasClass("x-monthview-tool-drop"))this.showMenu(a);else if(c=a.hasClass("x-whole-title-b")?a:a.parent(".x-whole-title-b"))(a=
c.parent(".x-whole-cover"))&&!a.bindEvent.locked&&b.showEditor(a,this,"update");else if(c=a.hasClass("x-legend-title-b")?a:a.parent(".x-legend-title-b"))(a=c.parent(".x-legend-cover"))&&!a.bindEvent.locked&&b.showEditor(a,this,"update")},initDetailCt:function(){var a=this.ehandler.detailTpl.apply({});this.detailCt=Ext.DomHelper.append(this.port,a,true);this.detailCt.setStyle("display","none");this.detailTitle=this.detailCt.child(".x-event-detail-title-td");this.detailViewer=this.detailCt.child(".x-event-detail-viewer");
this.detailFoot=this.detailCt.child(".x-event-detail-foot-text")},initSelectCover:function(){this.scovers=[];for(var a=0,b=this.templateRowNum;a<b;a++){var c=document.createElement("div");c.className="x-event-select-cover";c=Ext.get(c);Ext.get(this.port.dom.childNodes[a]).appendChild(c);this.scovers[this.scovers.length]=c}},initDragZone:function(a){var b=new Ext.dd.StatusProxy({dropNotAllowed:"x-dd-drop-ok"});a.dragzone=new Ext.dd.DragZone(a,{ddGroup:"x-mycalendar",proxy:b,cview:this,onStartDrag:function(){this.cview.dragging=
true;(function(){var c=this.dragData.bindEvent;c=Ext.DomQuery.select("div[name=x-event-"+c.day+"-"+c.eday+"-"+c.eventId+"]",this.cview.body.dom);for(var d=0,e=c.length;d<e;d++)Ext.get(c[d]).setOpacity(0.3)}).defer(1,this)},getDragData:function(c){c=c.getTarget();var d=Ext.get(c);d.hasClass("x-calendar-event")||(d=d.parent(".x-calendar-event"));if(d){c=d.bindEvent;if(!c.locked){var e=d.dom.cloneNode(true);d=d.getWidth();e.style.width=200<d?"200px":d+"px";return{ddel:e,bindEvent:c}}}return false},getRepairXY:function(){return null},
onDrag:function(c){var d=this.dragData.bindEvent,e=this.cview;d=Ext.ux.calendar.Mask.getDayOffset(d.day,d.eday);c=e.calculatePos(c);d=e.addSpan2Pos(c,d);e.selectRange(c,d)},endDrag:function(){var c=this.cview,d=this.dragData.bindEvent,e=Ext.apply({},d),f;if(d.day==d.eday&&(0!=d.startRow||c.rowCount!=d.endRow))f=Ext.apply({},d);var g=c.startPos,h=c.ehandler,j=Ext.ux.calendar.Mask.getDayOffset(d.day,d.eday);c.colNum!=c.shiftDay&&1!=h.startDay&&g.y++;g=c.daySet[g.x*c.shiftDay+g.y];var i=g.format("Y-m-d");
if(d.day!=i){d.eday=g.add(Date.DAY,j).format("Y-m-d");d.day=i;if("string"==Ext.type(d.repeatType))h.updateEvent(d,c,null,f);else{d.repeatType="exception";h.updateRepeatEvent(d,c,e)}}else{d=Ext.DomQuery.select("div[name=x-event-"+d.day+"-"+d.eday+"-"+d.eventId+"]",this.cview.body.dom);e=0;for(f=d.length;e<f;e++)Ext.get(d[e]).setOpacity(1)}c.dragging=false;c.resetSCover();c.fireEvent("canceldetail")}})},addSpan2Pos:function(a,b){a=Ext.apply({},a);a.y+=b;b=Math.floor(a.y/this.dayNum);a.y%=this.shiftDay;
a.x+=b;if(a.x>=this.weekNum){a.x=this.weekNum-1;a.y=this.colNum-1}if(a.y>=this.colNum)a.y=this.colNum-1;return a},viewWeekend:function(a){if(1==this.startDay){Ext.util.CSS.updateRule("."+this.id+"-x-monthview-viewer-col-6","display",a);Ext.util.CSS.updateRule("."+this.id+"-x-monthview-viewer-col-5","display",a)}else{Ext.util.CSS.updateRule("."+this.id+"-x-monthview-viewer-col-0","display",a);Ext.util.CSS.updateRule("."+this.id+"-x-monthview-viewer-col-6","display",a)}},recalculateSize:function(a,
b){if(typeof a=="number"){this.cheader.setWidth(a);a-=this.leftWidth;this.port.setWidth(a);if(7==this.colNum)this.viewWeekend("");else 5==this.colNum&&this.viewWeekend("none");this.cw=a/this.colNum}if(typeof b=="number"){this.ch=(b-this.cheader.getHeight())/this.rowNum;a=Ext.get(this.id+"-x-monthview-viewer-title-0-1").getHeight();this.lineNum=Math.floor((this.ch-a)/this.legendHeight);Ext.util.CSS.updateRule("."+this.id+"-x-monthview-row","height",Math.ceil(this.ch)+"px")}},handleResize:function(a,
b){var c=this.lineNum;this.recalculateSize(a,b);c!=this.lineNum&&this.showCache();this.alignDetailCt();this.fireEvent("afterresize",this,a,b)},checkCSHide:function(a){var b=this.ehandler.calendarSet,c=false;for(var d in b){var e=b[d],f=a[d];if(e&&f)if(false===e.hide&&false!==f.hide){c=true;break}}return c},showCache:function(a,b,c,d){c=this.ehandler;a=a||this.daySet[0];b=b||this.daySet[this.daySet.length-1];if(c.isInDayCache(a,b)&&!d){a=c.calendarLayout;b=0;for(d=this.weekNum;b<d;b++){c={};for(var e=
0,f=this.dayNum;e<f;e++){var g=this.daySet[b*this.dayNum+e].format("Y-m-d"),h=a.getLayout(g,this).reLayout();c[g]=h.wlist.concat(h.elist)}e=Ext.get(this.id+"-x-monthview-ct-"+b).dom.firstChild;a.showWeek(this,e,b,c,true)}return true}return false},checkLayout:function(a,b){var c=this.ehandler,d=this.daySet[0],e=this.daySet[this.daySet.length-1];if(!this.showCache(d,e,a,b)){this.fireEvent("beforeremoteload");c.ds.loadEvent(d,e,function(f){this.showEvents(f,b);c.pushDayCache(d,e);this.fireEvent("remoteload")},
this)}this.setToday()},showEvents:function(a){var b=this.ehandler.calendarLayout;b.updateWholeList(a.whole,"add");for(var c=0;c<this.weekNum;c++){var d=Ext.get(this.id+"-x-monthview-ct-"+c).dom.firstChild;b.showWeek(this,d,c,a)}},onAddFn:function(a){this.addLegend(this.getCellIndex(a.parentMenu.bindEl.dom.id))},onClearFn:function(a){this.clearLegend(this.getCellIndex(a.parentMenu.bindEl.dom.id))},setCutStatus:function(a){var b=a.x;a=a.y;var c=Ext.get(this.id+"-x-monthview-viewer-"+b+"-"+a);c&&c.addClass("x-monthview-cell-cut");
(b=Ext.get(this.id+"-x-monthview-viewer-title-"+b+"-"+a))&&b.addClass("x-monthview-cell-cut");this.ehandler.commentTip.showTip("Notice","Cross-day event and repeat event can not be cut/copied!",b,"bl-tl?")},resetCutStatus:function(a){var b=a.x;a=a.y;var c=Ext.get(this.id+"-x-monthview-viewer-"+b+"-"+a);c&&c.removeClass("x-monthview-cell-cut");(b=Ext.get(this.id+"-x-monthview-viewer-title-"+b+"-"+a))&&b.removeClass("x-monthview-cell-cut")},onCutFn:function(a){a=this.getCellIndex(a.parentMenu.bindEl.dom.id);
var b=this.daySet[a.x*this.dayNum+a.y].format("Y-m-d");this.cpFlag&&this.resetCutStatus(this.cpFlag.pos);this.setCutStatus(a);this.cpFlag={day:b,keep:false,pos:a}},onCopyFn:function(a){a=this.getCellIndex(a.parentMenu.bindEl.dom.id);var b=this.daySet[a.x*this.dayNum+a.y].format("Y-m-d");this.cpFlag&&this.resetCutStatus(this.cpFlag.pos);this.setCutStatus(a);this.cpFlag={day:b,keep:true,pos:a}},onPasteFn:function(a){if(this.cpFlag){var b=this.cpFlag.keep;a=this.getCellIndex(a.parentMenu.bindEl.dom.id);
var c=this.daySet[a.x*this.dayNum+a.y].format("Y-m-d"),d=this.ehandler,e=this.cpFlag.day;d.ds.changeDay(e,c,function(f){for(var g=d.calendarLayout,h=g.deleteDayFromWholeList(e,e,b),j=g.getLayout(e,this),i=[],n=j.reLayout(null,true).elist,m=[],l=0,o=n.length;l<o;l++){var k=n[l];"string"==Ext.type(k.repeatType)?i.push(Ext.apply({},k)):m.push(Ext.apply({},k))}if(f&&f.backids){n=f.backids;l=0;for(o=h.length;l<o;l++){k=h[l];if(n[k.eventId])k.eventId=n[k.eventId]}l=0;for(o=i.length;l<o;l++){k=i[l];if(n[k.eventId])k.eventId=
n[k.eventId]}}l=0;for(o=h.length;l<o;l++){k=h[l];k.day=c;k.eday=c}g.updateWholeList(h,"add");l=0;for(o=i.length;l<o;l++){k=i[l];k.day=c;k.eday=c}h=g.getLayout(c,this);n=h.reLayout(null,true).elist;n=g.combine2List(n,i);h.layouted=false;h.generateLayout(n,true,null,true);if(!b){j.layouted=false;j.generateLayout(m,true,null,true)}this.checkLayout();d.fireEvent("changeEventCache",d)},this,b);if(!b){this.resetCutStatus(this.cpFlag.pos);delete this.cpFlag}}},clearLegend:function(a){var b=this.ehandler,
c=b.calendarLayout,d=this.daySet[a.x*this.dayNum+a.y].format("Y-m-d");b.ds.deleteDay(d,function(){c.deleteDayFromWholeList(d);var e=c.getLayout(d,this);if(e){e.layouted=false;e.updateRepeat=true;e.generateLayout([],true,null,true)}this.checkLayout(true);b.fireEvent("changeEventCache",b)},this)},resizePort:Ext.emptyFn,refreshDate:function(){for(var a=this.daySet[0].getWeekOfYear(),b=0;b<this.weekNum;b++){for(var c=0;c<this.dayNum;c++){var d=Ext.get(this.id+"-x-monthview-viewer-link-"+b+"-"+c);if(d){var e=
this.daySet[b*this.dayNum+c].format(this.dayFormat);d.dom.innerHTML='<b class="x-monthview-viewer-link-b">'+e+"</b>"}}c=Ext.get(this.id+"-x-monthview-week-"+b+"-0");d=(a+b)%53;if(0==d)d=53;c.dom.innerHTML=d}},resetView:function(){this.refreshDate();this.setToday()},cleanup:function(a){var b=function(c){if(c=Ext.get(this.id+"-x-monthview-ct-"+c)){c=c.dom.firstChild;for(var d=[],e=1,f=c.childNodes.length;e<f;e++)d.push(c.childNodes[e]);e=0;for(f=d.length;e<f;e++)Ext.get(d[e]).remove()}}.createDelegate(this);
if(false==Ext.type(a))for(a=0;a<this.templateRowNum;a++)b(a);else b(a)},locateDay:function(a){a=a.getFirstDateOfMonth();this.recalculateWeek(a);this.recalculateSize(this.body.getWidth(),this.body.getHeight());a=this.getStartDate(a);this.daySet=[];for(var b=0;b<this.weekNum;b++)for(var c=0;c<this.dayNum;c++)this.daySet[this.daySet.length]=a.add(Date.DAY,b*this.shiftDay+c)},showDay:function(a){this.locateDay(a);this.resetView();this.checkLayout(true)},recalculateWeek:function(a){if(1==this.startDay){var b=
a.format("N");this.rowNum=7==b&&30<=a.getDaysInMonth()?6:6==b&&31==a.getDaysInMonth()?6:1==b&&28==a.getDaysInMonth()?4:5}else{var c=a.format("w");this.rowNum=6==c&&30<=a.getDaysInMonth()?6:5==c&&31==a.getDaysInMonth()?6:0==b&&28==a.getDaysInMonth()?4:5}this.weekNum=this.rowNum},goBack:function(){var a=this.shiftDay||this.dayNum,b=this.dayNum,c=this.daySet[0],d=c.getFirstDateOfMonth();if(c.format("Y-m-d")==d.format("Y-m-d")){d=d.add(Date.DAY,-1);d=d.getFirstDateOfMonth()}this.recalculateWeek(d);d=
this.getStartDate(d);c=this.weekNum;this.daySet=[];for(var e=0;e<c;e++)for(var f=0;f<b;f++)this.daySet[this.daySet.length]=d.add(Date.DAY,e*a+f);this.resetView();this.recalculateSize(this.body.getWidth(),this.body.getHeight());this.checkLayout(true)},goNext:function(){var a=this.shiftDay||this.dayNum,b=this.dayNum,c=this.daySet[this.daySet.length-1],d=c.getLastDateOfMonth();d=c.format("Y-m-d")==d.format("Y-m-d")?d.add(Date.DAY,1):c.getFirstDateOfMonth();this.recalculateWeek(d);d=this.getStartDate(d);
this.daySet=[];c=this.weekNum;for(var e=0;e<c;e++)for(var f=0;f<b;f++)this.daySet[this.daySet.length]=d.add(Date.DAY,e*a+f);this.resetView();this.recalculateSize(this.body.getWidth(),this.body.getHeight());this.checkLayout(true)},isShift:function(a,b){var c,d=a.format("Y-m-d"),e=this.daySet[0].format("Y-m-d");c=d<e?e:d;d=b.format("Y-m-d");e=this.daySet[this.daySet.length-1].format("Y-m-d");if(c>(d>e?e:d)){a=a.getFirstDateOfMonth();this.recalculateWeek(a);a=this.getStartDate(a);this.daySet=[];for(b=
0;b<this.weekNum;b++)for(c=0;c<this.dayNum;c++)this.daySet[this.daySet.length]=a.add(Date.DAY,b*this.shiftDay+c);return true}else return false},showRange:function(a,b){var c=false;if(this.isShift(a,b)){this.resetView();c=true}this.recalculateSize(this.body.getWidth(),this.body.getHeight());this.checkLayout(c)}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.ResultView=function(a){Ext.apply(this,a);this.ehandler.applyCalendarSetting(this);this.pageSize=20;a=this.ehandler.lang.ResultView;var b=this.ehandler.ds.getSearchStore(),c=[{header:"",sortable:true,menuDisabled:true,width:20,dataIndex:"calendarId",renderer:this.hiddenRenderFn.createDelegate(this)},{header:"",sortable:true,menuDisabled:true,width:20,dataIndex:"locked",renderer:this.lockedRenderFn.createDelegate(this)},{header:a["cm.time"],dataIndex:"ymd",sortable:true,width:140,renderer:this.fromtoRenderFn.createDelegate(this)},
{header:a["cm.calendar"],sortable:true,menuDisabled:true,width:100,dataIndex:"calendarId",renderer:this.calendarRenderFn.createDelegate(this)},{header:a["cm.subject"],sortable:true,width:120,dataIndex:"subject",renderer:this.subjectRenderFn},{header:a["cm.content"],sortable:true,width:120,dataIndex:"description",renderer:this.contentRenderFn.createDelegate(this)},{header:a["cm.expire"],sortable:true,menuDisabled:true,width:80,renderer:this.expireRenderFn.createDelegate(this)}];this.groupBtn=new Ext.Button({iconCls:"icon-sys-calendar-group",
text:a["groupBtn.group.text"],handler:this.onGroupFn,scope:this});this.returnBtn=new Ext.Button({iconCls:"icon-sys-calendar-door_out",text:a["returnBtn.text"],handler:this.onReturnFn,scope:this});var d=new Ext.PagingToolbar({pageSize:this.pageSize,store:b});d.on("render",this.onPageToolbarRenderFn,this);this.list=new Ext.grid.GridPanel({border:false,store:b,columns:c,view:new Ext.grid.GroupingView({forceFit:true}),loadMask:{msg:a["loadMask.msg"]},bbar:d});Ext.ux.calendar.ResultView.superclass.constructor.call(this,
{layout:"fit",items:[this.list]});this.on("render",this.onRenderFn,this);this.list.on("rowdblclick",this.onRowDblClickFn,this);this.list.on("rowclick",this.onRowClickFn,this);b.on("beforeload",this.onBeforeLoadFn,this);b.on("load",this.onLoadFn,this);b.clearGrouping()};
Ext.extend(Ext.ux.calendar.ResultView,Ext.ux.calendar.BasicView,{onBeforeLoadFn:function(a){a.removeAll()},onLoadFn:function(a,b){a=0;for(var c=b.length;a<c;a++){var d=b[a],e=d.data.repeatType;if("no"!=e&&"exception"!=e)d.data.repeatType=Ext.decode(e)}},onGroupFn:function(a){var b=this.ehandler.lang.ResultView,c=this.list.getStore();if(b["groupBtn.group.text"]==a.getText()){a.setText(b["groupBtn.unGroup.text"]);a.setIconClass("icon-sys-calendar-ungroup");c.groupBy("ymd")}else{a.setText(b["groupBtn.group.text"]);
a.setIconClass("icon-sys-calendar-group");c.clearGrouping()}},onReturnFn:function(){var a=this.ownerCt;a.getLayout().setActiveItem(a.currentIdx);a.currentView.checkLayout(true)},onRenderFn:function(a){a.port=a.body},onPageToolbarRenderFn:function(a){a.add("->",this.groupBtn,"-",this.returnBtn)},onRowClickFn:function(a,b,c){c=c.getTarget();var d=Ext.get(c);c=this.ehandler;a=a.getStore();b=a.getAt(b);var e={eventId:b.data.id,calendarId:b.data.calendarId,startRow:parseInt(b.data.startRow),endRow:parseInt(b.data.endRow),
subject:b.data.subject,content:b.data.description,day:b.data.ymd,eday:b.data.eymd,isShared:b.data.isShared,alertFlag:b.data.alertFlag,repeatType:b.data.repeatType},f=Ext.apply({},e);if(d.hasClass("x-calendar-resultview-lock")){if(d.hasClass("icon-sys-calendar-event_lock")){d.removeClass("icon-sys-calendar-event_lock");d.addClass("icon-sys-calendar-event_unlock");b.set("locked",false);e.locked=false}else if(d.hasClass("icon-sys-calendar-event_unlock")){d.removeClass("icon-sys-calendar-event_unlock");
d.addClass("icon-sys-calendar-event_lock");b.set("locked",true);e.locked=true}a.commitChanges();d=this.ownerCt.currentView;"string"==Ext.type(b.data.repeatType)?c.updateEvent(e,d):c.updateRepeatEvent(e,d,f)}},onRowDblClickFn:function(a,b){var c=this.ownerCt.currentView,d=this.ehandler,e=a.getStore(),f=e.getAt(b);if(!f.data.locked)if(a=a.getView().getRow(b)){a=Ext.get(a);a.bindEvent={eventId:f.data.id,calendarId:f.data.calendarId,startRow:parseInt(f.data.startRow),endRow:parseInt(f.data.endRow),subject:f.data.subject,
content:f.data.description,day:f.data.ymd,eday:f.data.eymd,isShared:f.data.isShared,alertFlag:f.data.alertFlag,locked:f.data.locked,repeatType:f.data.repeatType};a.cview=c;d.editor.fireEvent("showdetailsetting",{bindEl:a,cview:this,onLayout:function(g){f.set("calendarId",g.calendarId);f.set("subject",g.subject);f.set("description",g.content);f.set("ymd",g.day);f.set("eymd",g.eday);f.set("isShared",g.isShared);f.set("alertFlag",g.alertFlag);f.set("locked",g.locked);f.set("repeatType",g.repeatType);
e.commitChanges()},action:"update"})}},calendarRenderFn:function(a,b,c){a=this.ehandler;c=a.calendarSet[c.data.calendarId];return a.calendarTpl.apply({calendarId:c.id,"legend-style":"height:9px;",title:c.name,color:c.color})},fromtoRenderFn:function(a,b,c){a=c.data;a.startRow=Ext.ux.calendar.Mask.getRowFromHM(c.data.startTime,this.intervalSlot);a.endRow=Ext.ux.calendar.Mask.getRowFromHM(c.data.endTime,this.intervalSlot);a.day=a.ymd;a.eday=a.eymd;return this.ehandler.generateInfo(a)},subjectRenderFn:function(a){a=
a||"";if(""==a.trim())a=this.ehandler.lang.ResultView.noSubject;return a},contentRenderFn:function(a){a=a||"";if(""==a.trim())a=this.ehandler.lang.ResultView.noContent;return a},generateExpireHTML:function(a){var b=this.ehandler.lang.ResultView;a=a.hour;var c;if(-1==a)c='<div style="border:1px solid silver;height:20px;line-height:20px;background:rgb(231,231,231);text-align:center;"><b>Out of date</b></div>';else if(0<=a&&a<=24)c='<div style="border:1px solid silver;height:20px;line-height:20px;background:rgb(249,66,51);text-align:center;"><b>'+
a+" "+b.hour+"</b></div>";else if(24<a&&a<=72)c='<div style="border:1px solid silver;height:20px;line-height:20px;background:rgb(255,255,164);text-align:center;"><b>'+a+" "+b.hour+"</b></div>";else if(72<a)c='<div style="border:1px solid silver;height:20px;line-height:20px;background:rgb(147,250,97);text-align:center;"><b>'+a+" "+b.hour+"</b></div>";return c},expireRenderFn:function(a,b,c){a=Ext.ux.calendar.Mask.getRowFromHM(c.data.endTime,this.intervalSlot);c=c.data.ymd+" "+c.data.endTime;b=Date.parseDate(c,
"Y-m-d H:i");if(this.rowCount==a){b=b.add(Date.DAY,1);c=b.format("Y-m-d H:i")}a=b.getElapsed();return(new Date).format("Y-m-d H:i")>=c?this.generateExpireHTML({hour:-1}):this.generateExpireHTML({hour:Math.round(a/36E5)})},hiddenRenderFn:function(a,b,c){return this.ehandler.calendarSet[c.data.calendarId].hide?'<div class="x-resultview-event-hide"></div>':'<div class="x-resultview-event-show"></div>'},lockedRenderFn:function(a,b,c){return c.data.locked?'<div class="x-calendar-resultview-lock icon-sys-calendar-event_lock"></div>':
'<div class="x-calendar-resultview-lock icon-sys-calendar-event_unlock"></div>'},loadEvents:function(a){var b=this.list.getStore();b.removeAll();this.matchText=a;b.baseParams=Ext.apply(b.baseParams,{text:a});b.load({params:{start:0,limit:this.pageSize}})},checkLayout:function(){this.list.getStore().reload()}});Ext.ns("Ext.util");
Ext.util.DatePicker=Ext.extend(Ext.DatePicker,{onRender:function(a,b){Ext.util.DatePicker.superclass.onRender.call(this,a,b)},updateRange:function(){if(this.startDate&&this.endDate){var a=this.startDate.clearTime().getTime(),b=this.endDate.clearTime().getTime();this.cells.each(function(c){var d=c.dom.firstChild.dateValue;a<=d&&d<=b?c.addClass("x-date-selected"):c.removeClass("x-date-selected")})}},setRange:function(a,b){this.startDate=a;this.endDate=b},update:function(a,b){Ext.util.DatePicker.superclass.update.call(this,
a,b);this.updateRange()}});Ext.ns("Ext.util");Ext.util.LabelField=Ext.extend(Ext.form.Field,{onRender:function(a,b){Ext.util.LabelField.superclass.onRender.call(this,a,b);this.wrap=this.el.wrap({cls:this.wrapClass});Ext.isIE&&this.wrap.setHeight(20);this.el.addClass("x-hidden");this.labelEl=Ext.DomHelper.append(this.wrap,'<div style="padding-top:3px;"></div>',true);this.labelEl.dom.innerHTML=this.text},setText:function(a){if(this.labelEl)this.labelEl.dom.innerHTML=a;else this.text=a},getText:function(){return this.labelEl.dom.innerHTML}});
Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.WestPanel=function(a){Ext.apply(this,a);a=this.ehandler;a.applyCalendarSetting(this);this.ds=a.ds;a=a.lang.WestPanel;this.dateLabel=new Ext.form.Label({html:"<b>"+(new Date).format(this.fromtoFormat)+"</b>"});this.datePicker=new Ext.util.DatePicker({value:new Date,startDay:this.startDay});this.showAllBtn=new Ext.Button({iconCls:"icon-sys-calendar-calendar_show",text:a["myShowAllBtn.text"],handler:this.onShowAllFn,scope:this});this.addBtn=new Ext.Button({iconCls:"icon-sys-calendar-add_calendar",text:a["myAddBtn.text"],
handler:this.onAddFn,scope:this});var b=[this.showAllBtn,"->"];this.readOnly||b.push(this.addBtn);this.myCalendarPanel=new Ext.Panel({style:"padding-top:5px;",region:"center",iconCls:"icon-sys-calendar-calendar",title:a["myCalendarPanel.title"],bodyStyle:"padding:2px;background-color:white;overflow-x:hidden;overflow-y:auto;position:relative;",bbar:b});this.myCalendarPanel.on("render",this.onMyCalendarRenderFn,this);this.formpanel=new Ext.form.FormPanel({border:false,cls:"x-calendar-container",style:"padding:0px 10px 10px 12px;",
layout:"border",items:[{border:false,region:"north",height:230,style:"padding:5px 0px 0px 0px;",cls:"x-dayview-west-date-span",items:[this.dateLabel,this.datePicker]},this.myCalendarPanel]});Ext.ux.calendar.WestPanel.superclass.constructor.call(this,{border:false,cls:"x-calendar-west",collapsible:true,iconCls:"icon-sys-calendar-calendar",title:"\u65e5\u5386\u9762\u677f",collapseMode:"mini",region:"west",minWidth:200,width:200,layout:"fit",items:[this.formpanel]});this.addEvents("changedate");this.dateLabel.on("render",
this.onDateLabelRenderFn,this);this.datePicker.on("render",this.onDatePickerRenderFn,this);this.datePicker.on("select",this.onSelectFn,this);this.on("changedate",this.changeDateLabel,this)};
Ext.extend(Ext.ux.calendar.WestPanel,Ext.Panel,{onOtherCalendarRenderFn:function(a){this.ehandler.renderSharedCalendar(a.body)},onShowAllFn:function(){this.ehandler.onShowAllFn()},onAddFn:function(){this.ehandler.ceditor.popup({action:"add"})},onSelectFn:function(a,b){this.ownerCt.calendarContainer.showDay(b)},onMyCalendarRenderFn:function(a){this.ehandler.renderOwnedCalendar(a.body)},changeDateLabel:function(a,b){this.updateDateLabel(a,b);this.updateDatePicker(a,b)},updateDateLabel:function(a,b){b=
b.format(this.fromtoFormat);a=a.format(this.fromtoFormat);if(a!==b)a+=" - "+b;this.dateLabel.getEl().dom.innerHTML="<b>"+a+"</b>"},updateDatePicker:function(a,b){var c=a.format(this.fromtoFormat);this.datePicker.setRange(a,b);if(7<Ext.ux.calendar.Mask.getDayOffset(a,b)){b=a.getFirstDateOfMonth();var d=b.format("Y-m-d");c=a.format("Y-m-d");if(c!=d)b=a.getLastDateOfMonth().add(Date.DAY,1);this.datePicker.setValue(b)}else this.datePicker.setValue(a)},onDateLabelRenderFn:function(){var a=this.ownerCt.calendarContainer.currentView;
this.updateDateLabel(a.daySet[0],a.daySet[a.daySet.length-1])},onDatePickerRenderFn:function(){var a=this.ownerCt.calendarContainer.currentView;this.updateDatePicker(a.daySet[0],a.daySet[a.daySet.length-1])}});